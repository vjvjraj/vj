<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiSahay - Advanced Farm OS</title>
    
    <!-- Icons (Open Source - MIT) -->
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <!-- Leaflet CSS (Open Source - BSD) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <!-- Leaflet JS (Open Source - BSD) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- QR Generator (Open Source - MIT) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- Professional Dark Agriculture Theme Variables --- */
        :root {
            /* Natural Night Palette */
            --primary: #4ade80;       /* Bright Green for Actions */
            --primary-hover: #22c55e; /* Slightly darker on hover */
            --secondary: #38bdf8;     /* Sky Blue */
            --accent: #fbbf24;        /* Amber/Harvest */
            --danger: #f87171;        /* Soft Red */
            
            /* Typography */
            --text-main: #f8fafc;     /* High Contrast White */
            --text-muted: #94a3b8;    /* Muted Blue-Grey */
            --text-inverse: #020617;  /* Black for buttons */

            /* Interface Surfaces */
            --glass-bg: rgba(15, 23, 42, 0.85); /* Dark Slate Glass */
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --input-bg: rgba(0, 0, 0, 0.3);
            
            --card-radius: 16px;
        }

        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }

        body {
            font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
            background-color: #0f172a;
            color: var(--text-main);
            line-height: 1.6;
        }

        /* --- Background --- */
        #app-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            /* Darker, moody agriculture image */
            background-image: url('https://images.unsplash.com/photo-1625246333195-78d9c38ad449?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center;
            animation: slowZoom 60s infinite alternate;
        }
        
        #app-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            /* Dark gradient overlay for max text readability */
            background: linear-gradient(180deg, rgba(2,6,23,0.8) 0%, rgba(2,6,23,0.95) 100%);
            backdrop-filter: blur(3px);
        }

        @keyframes slowZoom { from { transform: scale(1); } to { transform: scale(1.05); } }

        /* --- Header --- */
        .header {
            position: fixed; top: 0; width: 100%; height: 64px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border); 
            display: flex; align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        
        .logo { font-size: 1.5rem; font-weight: 800; display: flex; gap: 0.5rem; align-items: center; color: var(--primary); letter-spacing: -0.5px; }
        .logo span:last-child { color: #fff; }
        
        .nav-icons { display: flex; gap: 1rem; align-items: center; }

        /* --- Layout --- */
        .app-layout {
            display: flex; height: 100%; padding-top: 64px; box-sizing: border-box;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border); padding: 1.5rem 1rem;
            display: none; flex-direction: column; gap: 0.5rem;
        }
        .nav-item {
            padding: 0.85rem 1rem; border-radius: 10px; cursor: pointer;
            color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 0.8rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: white; border-color: rgba(255,255,255,0.1); }
        .nav-item.active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.1);
        }
        .sidebar-footer { margin-top: auto; }

        /* --- Main Content --- */
        .main-content-area {
            flex: 1; overflow-y: auto; padding: 2rem; position: relative;
            scroll-behavior: smooth;
        }

        /* STRICT Page Visibility Control */
        .app-page { display: none !important; opacity: 0; transition: opacity 0.3s ease; }
        .app-page.active { display: block !important; opacity: 1; animation: fadeIn 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 1.5rem; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }

        /* --- Cards --- */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border); border-radius: var(--card-radius);
            padding: 1.5rem; box-shadow: var(--glass-shadow);
            backdrop-filter: blur(12px);
            display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); border-color: rgba(255,255,255,0.2); }
        .card-title { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Controls --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 0.8rem; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; font-size: 0.95rem; box-sizing: border-box; transition: 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.2); }
        
        .gps-group { display: flex; gap: 0.5rem; }
        .icon-btn { padding: 0.8rem; background: rgba(74, 222, 128, 0.1); border: 1px solid var(--primary); border-radius: 8px; color: var(--primary); cursor: pointer; transition: all 0.2s; }
        .icon-btn:hover { background: var(--primary); color: #020617; }

        .button {
            width: 100%; padding: 0.9rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            background: var(--primary); color: #020617; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 0.5rem;
        }
        .button:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 6px 12px rgba(74, 222, 128, 0.2); }
        .button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; transform: none; }
        
        .button.secondary { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; }
        .button.secondary:hover { background: rgba(255,255,255,0.1); border-color: white; }

        /* --- Data Lists --- */
        .data-list { display: flex; flex-direction: column; gap: 0.8rem; }
        .data-item { 
            display: flex; align-items: center; padding: 1rem; background: rgba(255,255,255,0.03); 
            border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;
        }
        .data-item:hover { background: rgba(255,255,255,0.07); }
        .data-icon { padding: 0.6rem; border-radius: 8px; margin-right: 1rem; background: rgba(255,255,255,0.05); }
        .data-info h4 { margin: 0; font-size: 0.9rem; color: var(--text-muted); font-weight: 600; }
        .data-info span { font-size: 1.1rem; font-weight: 700; color: white; }
        
        .weather-card { border-left: 3px solid var(--secondary); background: linear-gradient(90deg, rgba(56, 189, 248, 0.1), transparent); }
        .weather-card .data-icon { color: var(--secondary); }
        
        .soil-card { border-left: 3px solid var(--accent); background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), transparent); }
        .soil-card .data-icon { color: var(--accent); }
        
        .satellite-card { border-left: 3px solid #a855f7; background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent); }
        .satellite-card .data-icon { color: #a855f7; }

        /* --- Tabs --- */
        .tab-nav { display: flex; gap: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1.5rem; overflow-x: auto; }
        .tab-btn { 
            padding: 0.75rem 1.5rem; background: none; border: none; color: var(--text-muted); 
            font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; margin-bottom: -1px; transition: 0.2s;
        }
        .tab-btn:hover { color: white; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        /* --- Map --- */
        #farmMap { height: 400px; width: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); z-index: 1; filter: grayscale(0.2) contrast(1.1); }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: rgba(15, 23, 42, 0.95); box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 900;
            backdrop-filter: blur(10px);
        }
        .b-nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: var(--text-muted); gap: 3px; cursor: pointer; transition: 0.2s; }
        .b-nav-item.active { color: var(--primary); transform: translateY(-2px); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal-box {
            background: #1e293b; border: 1px solid rgba(255,255,255,0.15); border-radius: 16px;
            width: 90%; max-width: 500px; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .modal-head { padding: 1.25rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .modal-head h3 { margin: 0; color: white; font-weight: 700; font-size: 1.2rem; }
        .modal-body { padding: 1.5rem; overflow-y: auto; color: var(--text-main); }

        /* --- MARKET STYLES --- */
        .market-dropdown {
            position: absolute; top: 100%; left: 0; width: 100%; background: #1e293b; 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; max-height: 200px; 
            overflow-y: auto; z-index: 50; margin-top: 5px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .market-dropdown-item {
            padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; color: white;
        }
        .market-dropdown-item:hover { background: rgba(255,255,255,0.1); }
        .market-cat-btn {
            padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            background: rgba(255,255,255,0.05); border: 1px solid transparent; cursor: pointer; color: var(--text-muted);
            transition: all 0.2s; white-space: nowrap;
        }
        .market-cat-btn.active {
            background: rgba(74, 222, 128, 0.2); border-color: var(--primary); color: var(--primary);
        }
        .market-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;
        }
        .market-card {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px; padding: 1.2rem; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .market-card:hover { transform: translateY(-2px); border-color: var(--primary); background: rgba(255,255,255,0.05); }
        .market-trend { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-flex; align-items: center; gap: 2px; }
        .trend-up { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .trend-down { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .trend-steady { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }

        /* Chat */
        .chat-container { height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1rem; padding-right: 5px; }
        .msg { padding: 0.8rem; border-radius: 10px; max-width: 80%; font-size: 0.95rem; line-height: 1.5; }
        .msg.user { background: var(--primary); color: #020617; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.bot { background: rgba(255,255,255,0.1); color: white; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }

        /* Resp */
        @media (min-width: 768px) {
            .sidebar { display: flex; }
            .bottom-nav { display: none; }
        }
    </style>
</head>
<body>

    <div id="app-background"></div>
    <div id="app-overlay"></div>

    <header class="header">
        <div class="container">
            <div class="logo">
                <span data-lucide="sprout"></span>
                <span>KrishiSahay</span>
            </div>
            <div class="nav-icons">
                <select id="langSwitcher" class="form-input" style="width:auto; padding:0.4rem; background:rgba(0,0,0,0.5);">
                    <option value="en" style="color:black">English</option>
                    <option value="hi" style="color:black">हिन्दी</option>
                    <option value="kn" style="color:black">ಕನ್ನಡ</option>
                    <option value="ta" style="color:black">தமிழ்</option>
                    <option value="te" style="color:black">తెలుగు</option>
                </select>
                <div id="authStatus" title="Profile" style="padding: 6px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); color: var(--primary); cursor: pointer;">
                    <span data-lucide="user"></span>
                </div>
            </div>
        </div>
    </header>

    <div class="app-layout">
        <nav class="sidebar">
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="nav('dashboard')"><span data-lucide="layout-dashboard"></span> <span data-i18n="nav_dash">Dashboard</span></div>
                <div class="nav-item" onclick="nav('soil')"><span data-lucide="flask-conical"></span> <span data-i18n="nav_soil">Soil</span></div>
                <!-- Logbook Removed from Sidebar -->
                <div class="nav-item" onclick="nav('ai-tools')"><span data-lucide="brain-circuit"></span> <span data-i18n="nav_ai">AI Tools</span></div>
                <div class="nav-item" onclick="nav('market')"><span data-lucide="shopping-cart"></span> <span data-i18n="nav_market">Market</span></div>
                <div class="nav-item" onclick="nav('community')"><span data-lucide="users"></span> <span data-i18n="nav_comm">Community</span></div>
                <div class="nav-item" onclick="nav('settings')"><span data-lucide="settings"></span> <span data-i18n="nav_set">Settings</span></div>
            </div>
            <div class="sidebar-footer">
                <div style="font-size:0.8rem; color:var(--text-muted); text-align:center;">v4.2 Dark Mode</div>
            </div>
        </nav>

        <main class="main-content-area" id="mainScroll">
            
            <!-- DASHBOARD (RE-FRAMED) -->
            <div id="page-dashboard" class="app-page active">
                <h2 class="page-title" data-i18n="title_dash">Farm Dashboard</h2>
                
                <!-- 1. Top Section: Weather & MAP (Moved Map Here) -->
                <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(16, 185, 129, 0.3);">
                      <div class="card-title" data-i18n="card_live">Live Field Status</div>
                      <div class="data-list" style="flex-direction:row; flex-wrap:wrap; align-items: stretch;">
                        <div class="data-item weather-card" style="flex:1; min-width:200px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div class="data-icon"><span data-lucide="cloud-sun" style="color:var(--secondary)"></span></div>
                                <div class="data-info">
                                    <h4 data-i18n="data_weather">Weather</h4>
                                    <span id="weatherData">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <!-- MAP Container in Dashboard -->
                        <div style="flex: 2; min-width: 300px; height: 300px; margin-left: 1rem;">
                             <div id="farmMap" style="height: 100%; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);"></div>
                        </div>
                      </div>
                </div>

                <div class="content-grid">
                    <!-- 2. Middle Left: Controls (With Search) -->
                    <div class="card">
                        <div class="card-title" data-i18n="card_controls">Farm Controls</div>
                        <div class="card-content form-space">
                            <div class="form-group" style="position:relative;">
                                <label data-i18n="lbl_location">Location</label>
                                <div class="gps-group">
                                    <input type="text" id="dashLocationInput" value="Bengaluru, Karnataka" class="form-input" style="flex:1;" placeholder="Search city...">
                                    <button class="icon-btn" id="gpsBtn"><span data-lucide="crosshair"></span></button>
                                </div>
                                <div id="dashSearchResults" class="market-dropdown" style="display:none;"></div>
                            </div>
                            <div class="form-group">
                                <label data-i18n="lbl_crop">Crop</label>
                                <select id="crop" class="form-select">
                                    <option value="Rice" data-i18n="opt_rice">Rice</option>
                                    <option value="Wheat" data-i18n="opt_wheat">Wheat</option>
                                    <option value="Cotton" selected data-i18n="opt_cotton">Cotton</option>
                                    <option value="Tomato">Tomato</option>
                                    <option value="Potato">Potato</option>
                                    <option value="Onion">Onion</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-i18n="lbl_issue">Issue</label>
                                <input type="text" id="issue" class="form-input" placeholder="e.g. Yellow spots" data-i18n-ph="ph_issue">
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="button" id="getAdviceBtn">
                                <span data-lucide="sparkles" style="width:18px"></span> <span id="btnText" data-i18n="btn_advice">Get Advisory</span>
                            </button>
                        </div>
                    </div>

                    <!-- 3. Middle Right: Logbook -->
                    <div class="card">
                         <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
                             <span data-i18n="title_log">Logbook</span>
                             <button class="button secondary" style="width:auto; padding:0.4rem 0.8rem; font-size:0.8rem;" onclick="openModal('logEntryModal')">
                                 <span data-lucide="plus" style="width:14px;"></span> <span data-i18n="btn_add">Add</span>
                             </button>
                         </div>
                         <div id="dashboardLogList" class="data-list" style="max-height:300px; overflow-y:auto;">
                             <p style="text-align:center; color:var(--text-muted);" data-i18n="txt_no_entries">No recent activity.</p>
                         </div>
                    </div>
                </div>

                <!-- 4. Bottom: Widgets -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="card">
                        <div class="card-title" data-i18n="widget_price">Market Price</div>
                        <div class="data-item">
                            <div class="data-icon"><span data-lucide="trending-up" style="color:var(--primary)"></span></div>
                            <div class="data-info">
                                <h4 id="marketPriceCrop">Cotton (Bengaluru)</h4>
                                <span id="marketPriceWidget">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                         <div class="card-title" data-i18n="widget_advisory">Advisory Alert</div>
                         <div class="data-item">
                            <div class="data-icon"><span data-lucide="bell" style="color:var(--danger)"></span></div>
                            <div class="data-info">
                                <h4>Next 24 Hours</h4>
                                <span id="weatherAlertWidget" style="font-size:0.95rem; color:var(--accent);">Analyzing forecast...</span>
                            </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- MARKET -->
            <div id="page-market" class="app-page">
                <h2 class="page-title" data-i18n="title_market">Marketplace</h2>
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab(this, 'market-supplies')" data-i18n="tab_supplies">Live Prices</button>
                    <button class="tab-btn" onclick="switchTab(this, 'market-produce')" data-i18n="tab_produce">My Produce</button>
                    <button class="tab-btn" onclick="switchTab(this, 'market-trace')" data-i18n="tab_trace">Agri-Trace</button>
                </div>

                <!-- LIVE PRICES -->
                <div id="market-supplies" class="tab-content active">
                    <div class="card">
                        <div class="card-title">Real-Time Market Rates (Mandi/APMC)</div>
                        
                        <!-- Market Search -->
                        <div style="position:relative; margin-bottom: 1rem;">
                            <div class="gps-group">
                                <input type="text" id="marketSearchInput" class="form-input" placeholder="Search District or Market..." style="padding-left:2.5rem;">
                                <span style="position:absolute; left:10px; top:12px; color:var(--text-muted);"><span data-lucide="search" style="width:18px;"></span></span>
                            </div>
                            <div id="marketSearchResults" class="market-dropdown" style="display:none;"></div>
                        </div>

                        <!-- Categories -->
                        <div class="form-group">
                            <div style="display:flex; gap:0.5rem; overflow-x:auto; padding-bottom:5px;" id="marketCategories">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Results Grid -->
                        <div id="marketPricesGrid" class="market-grid">
                            <p style="grid-column: 1/-1; text-align:center; color:var(--text-muted); padding:2rem;">
                                Search for a location to see live prices.
                            </p>
                        </div>
                        <div style="text-align:right; margin-top:1rem; font-size:0.75rem; color:var(--text-muted);" id="marketLastUpdated"></div>
                    </div>
                </div>

                <div id="market-produce" class="tab-content">
                    <div class="card">
                        <button class="button secondary" style="margin-bottom:1rem;" onclick="openModal('listProduceModal')">
                            <span data-lucide="plus"></span> <span data-i18n="btn_list_produce">List Item</span>
                        </button>
                        <div class="data-list" id="marketProduceList">
                             <p style="text-align:center; color:var(--text-muted);" data-i18n="txt_no_listings">No listings.</p>
                        </div>
                    </div>
                </div>

                <div id="market-trace" class="tab-content">
                    <div class="card" style="align-items:center;">
                         <!-- Trace Start -->
                         <div id="trace-start-view" style="text-align:center; padding:1rem;">
                             <span data-lucide="qr-code" style="width:64px; height:64px; color:var(--text-muted);"></span>
                             <h3 style="color:white; margin:1rem 0;" data-i18n="trace_start_title">Batch Tracking</h3>
                             <p style="margin-bottom:1rem; color:var(--text-muted);" data-i18n="trace_start_desc">Create a verifiable identity for your crop batch.</p>
                             <button class="button" id="generateBatchBtn" data-i18n="btn_gen_qr">Create New Batch</button>
                         </div>
                         <!-- Trace QR -->
                         <div id="trace-qr-view" style="display:none; text-align:center; width:100%;">
                             <h3 data-i18n="trace_qr_title">Batch QR Code</h3>
                             <canvas id="batchQRCanvas" style="border:4px solid white; border-radius:8px; margin:1rem 0;"></canvas>
                             <button class="button secondary" id="simulateScanBtn" data-i18n="btn_sim_scan">Simulate Scan</button>
                         </div>
                         <!-- Trace Ledger -->
                         <div id="trace-ledger-view" style="display:none; width:100%;">
                             <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                                 <h3 style="margin:0; color:var(--primary);" data-i18n="trace_ledger_title">Ledger</h3>
                                 <button class="button secondary" style="width:auto; padding:0.4rem 0.8rem;" id="showQRBtn" data-i18n="btn_view_qr">View QR</button>
                             </div>
                             <div id="ledger-crop-details" style="margin-bottom:1rem; padding:1rem; background:rgba(255,255,255,0.05); border-radius:8px;"></div>
                             <div id="ledger-content" class="data-list"></div>
                             <div style="margin-top:1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                 <button class="button secondary" onclick="openModal('transportModal')" data-i18n="btn_add_trans">Add Transport</button>
                                 <button class="button secondary" onclick="openModal('receiverModal')" data-i18n="btn_add_recv">Add Receipt</button>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- SOIL TEST MODULE -->
            <div id="page-soil" class="app-page">
                <h2 class="page-title" data-i18n="title_soil">Soil Testing Center</h2>
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab(this, 'soil-calc')" data-i18n="tab_calc">Calculator</button>
                    <button class="tab-btn" onclick="switchTab(this, 'soil-visual')" data-i18n="tab_visual">Visual</button>
                    <button class="tab-btn" onclick="switchTab(this, 'soil-history')" data-i18n="tab_history">History</button>
                </div>

                <div id="soil-calc" class="tab-content active">
                    <div class="card">
                        <div class="card-title">Enter Lab Data</div>
                        <div class="content-grid" style="gap: 1rem;">
                            <div class="form-group"><label>N (Nitrogen)</label><input type="number" id="soil-n" class="form-input" placeholder="e.g. 280"></div>
                            <div class="form-group"><label>P (Phosphorus)</label><input type="number" id="soil-p" class="form-input" placeholder="e.g. 15"></div>
                            <div class="form-group"><label>K (Potassium)</label><input type="number" id="soil-k" class="form-input" placeholder="e.g. 150"></div>
                            <div class="form-group"><label>pH Level</label><input type="number" id="soil-ph" class="form-input" placeholder="e.g. 6.5" step="0.1"></div>
                        </div>
                        <button class="button" id="calcSoilBtn" style="margin-top:1rem;">Generate Report</button>
                    </div>
                </div>

                <div id="soil-visual" class="tab-content">
                    <div class="card">
                        <div class="card-title">Visual Soil Analysis</div>
                        <div style="text-align:center; padding:1rem;">
                            <div id="soilImagePreview" style="height:200px; background:rgba(0,0,0,0.3); border-radius:12px; margin-bottom:1rem; display:flex; align-items:center; justify-content:center;">
                                <span data-lucide="image" style="width:48px; height:48px; opacity:0.5;"></span>
                            </div>
                            <input type="file" id="soilImageUpload" class="form-input" accept="image/*">
                            <button class="button" id="analyzeSoilImgBtn" style="margin-top:1rem;" disabled>Analyze</button>
                        </div>
                        <div id="soilVisualResult" style="margin-top:1rem; display:none; padding:1rem; background:rgba(16,185,129,0.1); border-radius:10px;"></div>
                    </div>
                </div>

                <div id="soil-history" class="tab-content">
                    <div class="card">
                         <div class="data-list" id="soilHistoryList">
                             <p style="text-align:center; color:var(--text-muted);">No past tests.</p>
                         </div>
                    </div>
                </div>
            </div>

            <!-- AI TOOLS -->
            <div id="page-ai-tools" class="app-page">
                <h2 class="page-title" data-i18n="title_ai">AI Tools</h2>
                <div class="content-grid">
                    <div class="card">
                        <div class="card-title" data-i18n="tool_pest">Pest Doctor</div>
                        <button class="button" style="background: linear-gradient(135deg, #f87171, #ef4444);" onclick="openModal('pestDetectorModal')">
                            <span data-lucide="camera"></span> <span data-i18n="btn_scan">Start Scan</span>
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-title" data-i18n="tool_chat">FarmChat</div>
                        <button class="button" style="background: linear-gradient(135deg, #38bdf8, #0ea5e9);" onclick="openModal('chatModal')">
                            <span data-lucide="message-circle"></span> <span data-i18n="btn_chat">Chat Now</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- COMMUNITY (Updated with Equipment) -->
            <div id="page-community" class="app-page">
                <h2 class="page-title" data-i18n="title_comm">Community</h2>
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab(this, 'comm-forum')" data-i18n="tab_forum">Forum</button>
                    <button class="tab-btn" onclick="switchTab(this, 'comm-equip')" data-i18n="tab_equip">Equipment</button>
                    <button class="tab-btn" onclick="switchTab(this, 'comm-news')" data-i18n="tab_news">News</button>
                </div>
                
                <div id="comm-forum" class="tab-content active">
                    <div class="card">
                        <textarea id="newPostContent" class="form-textarea" rows="2" placeholder="Share a tip..." data-i18n-ph="ph_share_tip"></textarea>
                        <button class="button secondary" style="width:auto; margin-top:0.5rem; align-self:flex-end;" id="submitPostBtn" data-i18n="btn_post">Post</button>
                        <div id="forumPostList" class="data-list" style="margin-top:1rem;">
                            <!-- Posts will go here -->
                        </div>
                    </div>
                </div>
                
                <div id="comm-equip" class="tab-content">
                    <div class="card">
                        <div id="equipmentList" class="market-grid">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <div id="comm-news" class="tab-content">
                    <div class="card">
                        <p style="text-align:center; color:var(--text-muted);">Local agricultural news & events will appear here.</p>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="page-settings" class="app-page">
                <h2 class="page-title" data-i18n="title_settings">Settings</h2>
                <div class="card">
                      <div class="card-title">Profile</div>
                      <div class="form-space">
                          <input type="text" id="setting-name" class="form-input" placeholder="Name">
                          <button class="button" id="saveProfileBtn" style="margin-top:1rem;">Save</button>
                      </div>
                </div>
            </div>

        </main>

        <nav class="bottom-nav">
            <div class="b-nav-item active" onclick="nav('dashboard')"><span data-lucide="layout-dashboard"></span> <span data-i18n="nav_dash">Home</span></div>
            <div class="b-nav-item" onclick="nav('soil')"><span data-lucide="flask-conical"></span> <span data-i18n="nav_soil">Soil</span></div>
            <div class="b-nav-item" onclick="nav('ai-tools')"><span data-lucide="brain-circuit"></span> <span data-i18n="nav_ai">AI</span></div>
            <div class="b-nav-item" onclick="nav('market')"><span data-lucide="shopping-cart"></span> <span data-i18n="nav_market">Market</span></div>
            <div class="b-nav-item" onclick="nav('community')"><span data-lucide="map"></span> <span data-i18n="nav_comm">Map</span></div>
        </nav>
    </div>

    <!-- MODALS -->
    <div id="advisoryModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_advisory">Advisory</h3><button class="close-modal-btn" onclick="closeModal('advisoryModal')"><span data-lucide="x"></span></button></div><div id="modalContent" class="modal-body"></div></div></div>
    <div id="chatModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_chat">FarmChat</h3><button class="close-modal-btn" onclick="closeModal('chatModal')"><span data-lucide="x"></span></button></div><div class="modal-body"><div id="chatBox" class="chat-container"><div class="msg bot">Namaste! Ask me anything.</div></div><div style="display:flex; gap:0.5rem;"><input type="text" id="chatInput" class="form-input" placeholder="Type..." data-i18n-ph="ph_chat"><button class="icon-btn" id="chatSendBtn"><span data-lucide="send"></span></button></div></div></div></div>
    <div id="logEntryModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_log">New Log</h3><button class="close-modal-btn" onclick="closeModal('logEntryModal')"><span data-lucide="x"></span></button></div><div class="modal-body form-space"><select id="log-type" class="form-select"><option data-i18n="opt_irrigation">Irrigation</option><option data-i18n="opt_fert">Fertilizer</option><option data-i18n="opt_harvest">Harvest</option></select><textarea id="log-notes" class="form-textarea" placeholder="Notes..." data-i18n-ph="ph_log_notes"></textarea><button class="button" id="saveLogBtn" data-i18n="btn_save">Save</button></div></div></div>
    <div id="pestDetectorModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_pest">Pest Doctor</h3><button class="close-modal-btn" onclick="closeModal('pestDetectorModal')"><span data-lucide="x"></span></button></div><div class="modal-body form-space"><div id="imagePreviewContainer" style="height:200px; background:rgba(0,0,0,0.3); border-radius:8px; display:flex; align-items:center; justify-content:center;">No Image</div><input type="file" id="pestImageUpload" class="form-input" accept="image/*"><div id="pestResult" style="display:none; padding:1rem; background:rgba(16,185,129,0.1); border-radius:8px;"></div><button class="button" id="scanPestPhotoBtn" disabled data-i18n="btn_scan">Scan</button></div></div></div>
    <div id="listProduceModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_list">Sell Produce</h3><button class="close-modal-btn" onclick="closeModal('listProduceModal')"><span data-lucide="x"></span></button></div><div class="modal-body form-space"><input type="text" id="produce-name" class="form-input" placeholder="Crop Name" data-i18n-ph="ph_produce_name"><input type="text" id="produce-price" class="form-input" placeholder="Price" data-i18n-ph="ph_price"><button class="button" id="saveProduceBtn" data-i18n="btn_list">List</button></div></div></div>
    <div id="transportModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_trans">Add Transport</h3><button class="close-modal-btn" onclick="closeModal('transportModal')"><span data-lucide="x"></span></button></div><div class="modal-body form-space"><input type="text" id="trans-vehicle" class="form-input" placeholder="Vehicle No" data-i18n-ph="ph_vehicle"><button class="button" id="saveTransportBtn" data-i18n="btn_update">Update</button></div></div></div>
    <div id="receiverModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3 data-i18n="modal_recv">Receipt</h3><button class="close-modal-btn" onclick="closeModal('receiverModal')"><span data-lucide="x"></span></button></div><div class="modal-body form-space"><input type="text" id="recv-name" class="form-input" placeholder="Buyer Name" data-i18n-ph="ph_buyer"><button class="button" id="saveReceiverBtn" data-i18n="btn_update">Update</button></div></div></div>
    <div id="soilReportModal" class="modal-overlay"><div class="modal-box"><div class="modal-head"><h3>Soil Report</h3><button class="close-modal-btn" onclick="closeModal('soilReportModal')"><span data-lucide="x"></span></button></div><div id="soilReportContent" class="modal-body"></div></div></div>

    <script type="module">
        // --- CONFIG ---
        const apiKey = "AIzaSyASbj9A3aEmawAhcWkVxnu-wRYXwn1LmjA"; // Gemini API Key
        const GOVT_API_KEY = "579b464db66ec23bdd000001cdd3946e44ce4aad7209ff7b23ac571b"; // OGD Key
        
        // --- APP STATE ---
        let db = { logs: [], produce: [], soilTests: [] };
        let currentBatch = null;
        let mapInstance = null, farmMarker = null;
        let lat = 14.6819, lon = 77.6006;
        let selectedState = "Karnataka";
        let selectedDistrict = "Bengaluru";
        let curLang = 'en';
        let marketState = { loc: {state:'', district:''}, cat: 'All' };
        let pestImgFile = null;

        // --- TRANSLATIONS (Partial for Demo, Extensible) ---
        const translations = {
            en: { nav_dash: "Dashboard", nav_log: "Logbook", nav_ai: "AI Tools", nav_market: "Market", nav_comm: "Community", nav_set: "Settings", nav_soil: "Soil",
                  title_dash: "Farm Dashboard", card_controls: "Farm Controls", lbl_location: "Location", lbl_crop: "Crop", lbl_issue: "Issue", btn_advice: "Get Advisory",
                  card_live: "Live Data", data_weather: "Weather", data_soil: "Moisture", data_temp: "Soil Temp",
                  title_log: "Logbook", btn_add: "New Entry", txt_no_entries: "No entries.",
                  title_ai: "AI Tools", tool_pest: "Pest Doctor", desc_pest: "Scan crop for diagnosis", btn_scan: "Scan", tool_chat: "FarmChat", desc_chat: "Ask AI", btn_chat: "Chat",
                  title_market: "Marketplace", btn_list_produce: "List Item", txt_no_listings: "No listings.",
                  title_comm: "Community", title_settings: "Settings", lbl_name: "Name", btn_save_profile: "Save",
                  title_soil: "Soil Center", tab_calc: "Calculator", tab_visual: "Visual", tab_supplies: "Live Prices", tab_produce: "My Produce", tab_trace: "Agri-Trace", tab_history: "History",
                  opt_rice: "Rice", opt_wheat: "Wheat", opt_cotton: "Cotton", opt_irrigation: "Irrigation", opt_fert: "Fertilizer", opt_harvest: "Harvest",
                  modal_advisory: "Advisory", modal_chat: "FarmChat", modal_log: "Log", modal_pest: "Pest Doctor", modal_list: "Sell",
                  btn_save: "Save", btn_list: "List", btn_post: "Post",
                  ph_issue: "e.g. Yellow spots", ph_chat: "Type...", ph_log_notes: "Notes...", ph_produce_name: "Crop", ph_price: "Price", ph_share_tip: "Tip...",
                  widget_price: "Market Price", widget_advisory: "Advisory",
                  trace_start_title: "Batch Tracking", trace_start_desc: "Create verifiable identity", btn_gen_qr: "Create New Batch", trace_qr_title: "Batch QR", btn_sim_scan: "Simulate Scan", trace_ledger_title: "Ledger", btn_view_qr: "View QR", btn_add_trans: "Add Transport", btn_add_recv: "Add Receipt", btn_close: "Close & Reset",
                  modal_trans: "Transport", modal_recv: "Receipt", btn_update: "Update", ph_vehicle: "Vehicle No", ph_buyer: "Buyer",
                  tab_equip: "Equipment", tab_news: "News"
            },
            hi: { nav_dash: "डैशबोर्ड", nav_log: "लॉगबुक", nav_ai: "एआई", nav_market: "बाज़ार", nav_comm: "समुदाय", nav_set: "सेटिंग्स", nav_soil: "मिट्टी",
                  title_dash: "फार्म डैशबोर्ड", card_controls: "खेत नियंत्रण", lbl_location: "स्थान", btn_advice: "सलाह लें",
                  card_live: "लाइव डेटा", data_weather: "मौसम", data_soil: "नमी", data_temp: "मिट्टी तापमान",
                  title_log: "लॉगबुक", btn_add: "नई प्रविष्टि", txt_no_entries: "कोई प्रविष्टि नहीं।",
                  title_ai: "एआई टूल्स", tool_pest: "कीट डॉक्टर", desc_pest: "रोग निदान के लिए स्कैन करें", btn_scan: "स्कैन", tool_chat: "फार्म चैट", desc_chat: "प्रश्न पूछें", btn_chat: "चैट",
                  title_market: "बाज़ार", btn_list_produce: "बेचें", txt_no_listings: "कोई लिस्टिंग नहीं।",
                  title_comm: "समुदाय", title_settings: "सेटिंग्स", lbl_name: "नाम", btn_save_profile: "सहेजें",
                  title_soil: "मिट्टी केंद्र", tab_calc: "कैलक्यूलेटर", tab_visual: "दृश्य", tab_supplies: "लाइव भाव", tab_produce: "मेरी उपज", tab_trace: "एग्री-ट्रेस", tab_history: "इतिहास",
                  opt_rice: "चावल", opt_wheat: "गेहूं", opt_cotton: "कपास", opt_irrigation: "सिंचाई", opt_fert: "उर्वरक", opt_harvest: "कटाई",
                  modal_advisory: "सलाह", modal_chat: "चैट", modal_log: "लॉग", modal_pest: "कीट डॉक्टर", modal_list: "बेचें",
                  btn_save: "सहेजें", btn_list: "सूचीबद्ध करें", btn_post: "पोस्ट",
                  ph_issue: "उदा. पीला धब्बा", ph_chat: "लिखें...", ph_log_notes: "नोट्स...", ph_produce_name: "फसल", ph_price: "कीमत", ph_share_tip: "सुझाव...",
                  widget_price: "बाज़ार भाव", widget_advisory: "सलाह"
            }
            // Add other langs...
        };

        function updateLanguage(lang) {
            curLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang] && translations[lang][key]) el.innerText = translations[lang][key];
                else if(translations['en'][key]) el.innerText = translations['en'][key];
            });
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if(translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
                else if(translations['en'][key]) el.placeholder = translations['en'][key];
            });
        }
        document.getElementById('langSwitcher').addEventListener('change', (e) => updateLanguage(e.target.value));

        // --- MARKET LOGIC (From Snippet) ---
        const CROP_TYPES = ["All", "Cereals", "Pulses", "Vegetables", "Fruits", "Commercial"];
        
        function initMarket() {
            const catContainer = document.getElementById('marketCategories');
            catContainer.innerHTML = '';
            CROP_TYPES.forEach(t => {
                let btn = document.createElement('button');
                btn.className = `market-cat-btn ${marketState.cat === t ? 'active' : ''}`;
                btn.innerText = t;
                btn.onclick = () => { marketState.cat = t; initMarket(); fetchMarketData(marketState.loc.state, marketState.loc.district, t); };
                catContainer.appendChild(btn);
            });
        }

        const marketSearchInput = document.getElementById('marketSearchInput');
        marketSearchInput.addEventListener('input', (e) => {
            const q = e.target.value;
            if(q.length < 3) { document.getElementById('marketSearchResults').style.display='none'; return; }
            if(window.marketTimeout) clearTimeout(window.marketTimeout);
            window.marketTimeout = setTimeout(async () => {
                try {
                    let res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=en&format=json`);
                    let data = await res.json();
                    let drop = document.getElementById('marketSearchResults');
                    drop.innerHTML = ''; drop.style.display = 'block';
                    if(data.results) {
                        data.results.forEach(r => {
                            let item = document.createElement('div');
                            item.className = 'market-dropdown-item';
                            item.innerHTML = `<div style="font-weight:600; color:white;">${r.name}</div><div style="font-size:0.8rem; color:gray;">${r.admin1 || ''}, ${r.country}</div>`;
                            item.onclick = () => {
                                marketSearchInput.value = `${r.name}, ${r.admin1}`;
                                drop.style.display = 'none';
                                marketState.loc = { state: r.admin1, district: r.name };
                                fetchMarketData(r.admin1, r.name, marketState.cat);
                            };
                            drop.appendChild(item);
                        });
                    }
                } catch(e) {}
            }, 300);
        });

        async function fetchMarketData(state, district, category) {
            const grid = document.getElementById('marketPricesGrid');
            grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:gray;">Fetching prices...</p>`;
            let items = [];
            // 1. Govt API
            try {
                let url = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${GOVT_API_KEY}&format=json&limit=10&filters[district]=${district}`;
                let res = await fetch(url);
                let data = await res.json();
                if(data.records && data.records.length > 0) items = data.records.map(r => ({ crop: r.commodity, type: r.variety, price: r.modal_price, market: r.market, trend: 'steady' }));
            } catch(e) {}
            // 2. AI Fallback
            if(items.length === 0) {
                let prompt = `Generate JSON for current prices of ${category} in ${district}, ${state}. Array of objects: {crop, type, price, market, trend(up/down/steady), change(%)}. Return ONLY JSON.`;
                try {
                   let aiRes = await callAI(prompt);
                   if(aiRes.includes('```json')) aiRes = aiRes.split('```json')[1].split('```')[0];
                   else if(aiRes.includes('```')) aiRes = aiRes.split('```')[1].split('```')[0];
                   items = JSON.parse(aiRes);
                } catch(e) {
                   // 3. Sim
                   items = [ { crop: "Rice", type: "Sona", price: 4200, trend: "up", change: 2.5, market: `${district} Mandi` } ];
                }
            }
            grid.innerHTML = '';
            items.forEach(i => {
                let col = i.trend === 'up' ? 'trend-up' : 'trend-steady';
                let sym = i.trend === 'up' ? '▲' : '•';
                grid.innerHTML += `<div class="market-card"><div style="display:flex; justify-content:space-between;"><div><h4 style="margin:0; color:white; font-size:1.1rem;">${i.crop}</h4><small style="color:gray;">${i.type}</small></div><span class="market-trend ${col}">${sym} ${i.change || 0}%</span></div><div style="margin-top:1rem;"><div style="font-size:1.5rem; font-weight:700; color:var(--primary);">₹${i.price}<span style="font-size:0.8rem; color:gray;">/Q</span></div><div style="font-size:0.8rem; color:gray;">📍 ${i.market}</div></div></div>`;
            });
            document.getElementById('marketLastUpdated').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
        }

        async function fetchSingleCropPrice(state, district, crop) {
            document.getElementById('marketPriceWidget').innerText = "Loading...";
            document.getElementById('marketPriceCrop').innerText = `${crop} (${district})`;
            let price = "N/A";
            // Check Govt API first
            try {
                 let url = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${GOVT_API_KEY}&format=json&limit=1&filters[district]=${district}&filters[commodity]=${crop}`;
                 let res = await fetch(url);
                 let data = await res.json();
                 if(data.records.length > 0) price = `₹ ${data.records[0].modal_price} / Q`;
            } catch(e) {}
            // Fallback AI
            if(price === "N/A") {
                 let prompt = `What is current mandi price of ${crop} in ${district}, ${state}? Return only price like "₹ 5400 / Q".`;
                 price = await callAI(prompt);
            }
            document.getElementById('marketPriceWidget').innerText = price;
        }

        // --- DASHBOARD SEARCH ---
        const dashInput = document.getElementById('dashLocationInput');
        dashInput.addEventListener('input', (e) => {
            const q = e.target.value;
            if(q.length < 3) { document.getElementById('dashSearchResults').style.display='none'; return; }
            if(window.dashTimeout) clearTimeout(window.dashTimeout);
            window.dashTimeout = setTimeout(async () => {
                let res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=en&format=json`);
                let data = await res.json();
                let drop = document.getElementById('dashSearchResults');
                drop.innerHTML = ''; drop.style.display = 'block';
                if(data.results) {
                    data.results.forEach(r => {
                        let item = document.createElement('div');
                        item.className = 'market-dropdown-item';
                        item.innerHTML = `<div style="font-weight:600; color:white;">${r.name}</div><div style="font-size:0.8rem; color:gray;">${r.admin1||''}, ${r.country}</div>`;
                        item.onclick = () => {
                            dashInput.value = `${r.name}, ${r.admin1}`;
                            drop.style.display = 'none';
                            updateDashboardData(r.latitude, r.longitude, r.name, r.admin1, r.name);
                        };
                        drop.appendChild(item);
                    });
                }
            }, 300);
        });

        document.getElementById('crop').addEventListener('change', () => {
             fetchSingleCropPrice(selectedState, selectedDistrict, document.getElementById('crop').value);
        });

        async function updateDashboardData(newLat, newLon, locName, state, district) {
            lat = newLat; lon = newLon;
            selectedState = state; selectedDistrict = district;
            
            // 1. Update Weather (Based on Farm Location)
            fetchWeather();
            
            // 2. Update Price Widget (Based on District)
            fetchSingleCropPrice(state, district, document.getElementById('crop').value);
            
            // 3. FIND NEAREST MANDI for Map (Based on District)
            let mapLat = newLat;
            let mapLon = newLon;
            let popupText = `<b>${locName}</b><br>Farm Location`;

            try {
                // Nominatim Search for APMC/Mandi
                const mandiQuery = `agricultural market ${district} ${state}`;
                const mandiRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(mandiQuery)}&format=json&limit=1`);
                const mandiData = await mandiRes.json();

                if (mandiData && mandiData.length > 0) {
                    mapLat = mandiData[0].lat;
                    mapLon = mandiData[0].lon;
                    popupText = `<b>${mandiData[0].display_name.split(',')[0]}</b><br>📍 Nearest Mandi (Market)`;
                }
            } catch (e) {
                console.warn("Mandi search failed, defaulting to farm location", e);
            }

            // 4. Update Map View
            if(mapInstance) {
                 mapInstance.setView([mapLat, mapLon], 13);
                 if(farmMarker) {
                     farmMarker.setLatLng([mapLat, mapLon])
                               .bindPopup(popupText)
                               .openPopup();
                 } else {
                     farmMarker = L.marker([mapLat, mapLon]).addTo(mapInstance)
                                    .bindPopup(popupText)
                                    .openPopup();
                 }
            } else {
                 // If map not init (rare), update globals for next init
                 // Note: we can't easily force init here if tab is hidden, but nav() handles it.
            }
        }

        // --- CORE UTILS ---
        window.nav = function(pageId) {
            document.querySelectorAll('.app-page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item, .b-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('mainScroll').scrollTop = 0;
            // IMPORTANT: Map inside dashboard now, need to ensure it renders if tab is dashboard
            if(pageId === 'dashboard' && mapInstance) setTimeout(() => mapInstance.invalidateSize(), 300);
        }

        window.switchTab = function(btn, targetId) {
            const p = btn.parentElement;
            p.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const c = p.parentElement;
            c.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
        }

        window.openModal = (id) => document.getElementById(id).classList.add('visible');
        window.closeModal = (id) => document.getElementById(id).classList.remove('visible');

        // --- GEMINI ---
        async function callAI(text, img=null) {
            try {
                let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                let parts = [{ text }];
                if(img) parts.push({ inlineData: { mimeType: "image/jpeg", data: img }});
                let r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts}]}) });
                let d = await r.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } catch(e) { return "AI Error."; }
        }

        // --- WEATHER & GPS ---
        async function fetchWeather() {
            try {
                document.getElementById('weatherData').innerText = "Loading...";
                let res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m&hourly=soil_temperature_0cm,soil_moisture_0_to_1cm&timezone=auto`);
                let d = await res.json();
                document.getElementById('weatherData').innerText = `${d.current.temperature_2m}°C, Wind ${d.current.wind_speed_10m}km/h`;
            } catch(e) { document.getElementById('weatherData').innerText = "Offline"; }
        }

        document.getElementById('gpsBtn').addEventListener('click', () => {
             if(navigator.geolocation) {
                 document.getElementById('dashLocationInput').value = "Locating...";
                 navigator.geolocation.getCurrentPosition(async (pos) => {
                     let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                     let d = await res.json();
                     let city = d.address.city || d.address.town || "Unknown";
                     let state = d.address.state || "";
                     document.getElementById('dashLocationInput').value = `${city}, ${state}`;
                     updateDashboardData(pos.coords.latitude, pos.coords.longitude, city, state, city);
                 });
             }
        });

        // --- LOGIC HOOKS ---
        document.getElementById('getAdviceBtn').addEventListener('click', async () => {
             let btn = document.getElementById('getAdviceBtn'); btn.disabled=true; btn.innerText="Thinking...";
             let prompt = `Farm Advisory. Context: ${document.getElementById('dashLocationInput').value}, Crop: ${document.getElementById('crop').value}, Issue: ${document.getElementById('issue').value}. Weather: ${document.getElementById('weatherData').innerText}. Reply in ${curLang}.`;
             let ans = await callAI(prompt);
             document.getElementById('modalContent').innerHTML = ans.replace(/\n/g, '<br>');
             openModal('advisoryModal');
             btn.disabled=false; btn.innerText = translations[curLang]['btn_advice'];
        });

        // --- CHAT LOGIC (Implemented) ---
        const chatInput = document.getElementById('chatInput');
        const chatBox = document.getElementById('chatBox');
        
        async function sendChat() {
            const txt = chatInput.value;
            if(!txt) return;
            chatBox.innerHTML += `<div class="msg user">${txt}</div>`;
            chatInput.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;
            
            let res = await callAI(`You are an expert agriculture AI assistant. User says: ${txt}. Reply in ${curLang}. Keep it short and helpful.`);
            chatBox.innerHTML += `<div class="msg bot">${res}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        document.getElementById('chatSendBtn').addEventListener('click', sendChat);
        chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChat(); });

        // --- PEST DOCTOR (Implemented) ---
        document.getElementById('pestImageUpload').addEventListener('change', (e) => {
             let r = new FileReader();
             r.onload = (ev) => {
                 document.getElementById('imagePreviewContainer').innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:contain;">`;
                 pestImgFile = ev.target.result.split(',')[1];
                 document.getElementById('scanPestPhotoBtn').disabled = false;
             }
             if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
        });

        document.getElementById('scanPestPhotoBtn').addEventListener('click', async () => {
             let btn = document.getElementById('scanPestPhotoBtn');
             btn.innerText = "Analyzing..."; btn.disabled = true;
             let res = await callAI(`Analyze this plant image for pests or diseases. Identify the issue and suggest organic remedies. Reply in ${curLang}.`, pestImgFile);
             const resultDiv = document.getElementById('pestResult');
             resultDiv.style.display = 'block';
             resultDiv.innerHTML = `<strong>Analysis:</strong><br>${res.replace(/\n/g, '<br>')}`;
             btn.innerText = "Scan Again"; btn.disabled = false;
        });

        // --- SOIL ---
        document.getElementById('calcSoilBtn').addEventListener('click', async () => {
             let n = document.getElementById('soil-n').value;
             let p = document.getElementById('soil-p').value;
             let k = document.getElementById('soil-k').value;
             if(!n || !p) return alert("Enter Data");
             let prompt = `Analyze soil N=${n}, P=${p}, K=${k} kg/ha. Suggest fertilizer schedule in ${curLang}.`;
             let res = await callAI(prompt);
             document.getElementById('soilReportContent').innerHTML = res.replace(/\n/g, '<br>');
             openModal('soilReportModal');
             db.soilTests.push({ date: new Date().toLocaleDateString(), type: 'Lab', details: `N:${n} P:${p} K:${k}` });
             renderSoilHistory();
        });
        
        let soilImgFile = null;
        document.getElementById('soilImageUpload').addEventListener('change', (e) => {
             let r = new FileReader();
             r.onload = (ev) => {
                 document.getElementById('soilImagePreview').innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:contain;">`;
                 soilImgFile = ev.target.result.split(',')[1];
                 document.getElementById('analyzeSoilImgBtn').disabled = false;
             }
             if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
        });
        document.getElementById('analyzeSoilImgBtn').addEventListener('click', async () => {
            let res = await callAI(`Analyze soil image texture/color. Reply in ${curLang}.`, soilImgFile);
            document.getElementById('soilVisualResult').style.display='block';
            document.getElementById('soilVisualResult').innerHTML = res;
            db.soilTests.push({ date: new Date().toLocaleDateString(), type: 'Visual', details: 'AI Analysis' });
            renderSoilHistory();
        });

        function renderSoilHistory() {
            let h = "";
            if(db.soilTests.length === 0) h = `<p style="text-align:center; color:var(--text-muted);">No past tests.</p>`;
            else db.soilTests.forEach(t => h += `<div class="data-item"><span>${t.date} - ${t.type}</span><br><small style="color:var(--text-muted)">${t.details}</small></div>`);
            document.getElementById('soilHistoryList').innerHTML = h;
        }

        // --- MAP ---
        function initMap() {
            if(mapInstance) { setTimeout(()=>mapInstance.invalidateSize(), 100); return; }
            mapInstance = L.map('farmMap').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
            farmMarker = L.marker([lat, lon]).addTo(mapInstance);
        }

        // --- EQUIPMENT ---
        const equipData = [
            {name:"Tractor 55HP", price:"₹800/hr", owner:"Ravi Farms"},
            {name:"Rotavator", price:"₹400/hr", owner:"Co-op Center"},
            {name:"Drone Sprayer", price:"₹1500/acre", owner:"TechAgri"}
        ];
        function renderEquipment() {
            let c = document.getElementById('equipmentList');
            c.innerHTML = '';
            equipData.forEach(e => {
                c.innerHTML += `<div class="market-card"><div><h4 style="color:white; margin:0;">${e.name}</h4><small style="color:gray;">${e.owner}</small></div><div style="margin-top:0.5rem; color:var(--primary); font-weight:bold;">${e.price}</div><button class="button secondary" style="margin-top:0.5rem; width:100%; font-size:0.8rem;">Rent</button></div>`;
            });
        }

        // --- MARKET PRODUCE (Implemented) ---
        document.getElementById('saveProduceBtn').addEventListener('click', () => {
            const name = document.getElementById('produce-name').value;
            const price = document.getElementById('produce-price').value;
            if(!name || !price) return;
            
            db.produce.push({ name, price, date: new Date().toLocaleDateString() });
            
            let list = document.getElementById('marketProduceList');
            if(db.produce.length === 1) list.innerHTML = ''; // Clear "No listings" msg
            
            list.innerHTML += `<div class="data-item">
                <div class="data-icon"><span data-lucide="package" style="color:var(--accent)"></span></div>
                <div class="data-info">
                    <h4>${name}</h4>
                    <span>₹${price}</span>
                </div>
            </div>`;
            
            lucide.createIcons();
            closeModal('listProduceModal');
            document.getElementById('produce-name').value = '';
            document.getElementById('produce-price').value = '';
        });

        // --- COMMUNITY POST (Implemented) ---
        document.getElementById('submitPostBtn').addEventListener('click', () => {
             const txt = document.getElementById('newPostContent').value;
             if(!txt) return;
             
             const list = document.getElementById('forumPostList');
             const div = document.createElement('div');
             div.className = 'data-item';
             div.innerHTML = `<div><h4 style="color:var(--primary);">You</h4><p style="margin:0; color:white;">${txt}</p></div>`;
             list.prepend(div);
             
             document.getElementById('newPostContent').value = '';
        });

        // --- PROFILE SETTINGS (Implemented) ---
        document.getElementById('saveProfileBtn').addEventListener('click', () => {
             const name = document.getElementById('setting-name').value;
             if(name) {
                 alert("Profile Saved!");
                 // In a real app, save to DB or LocalStorage
             }
        });

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            fetchWeather();
            initMarket(); 
            renderDashboardLogs();
            renderEquipment(); // Init equipment
            
            // Initial price fetch
            fetchSingleCropPrice("Karnataka", "Bengaluru", "Cotton");
            
            // Init map on dashboard load
            initMap();
        };

        // --- AGRI TRACE ---
        document.getElementById('generateBatchBtn').addEventListener('click', () => {
             currentBatch = { id: 'B-'+Date.now(), crop: document.getElementById('crop').value, log: [`Batch Created: ${new Date().toLocaleDateString()}`] };
             renderLedger();
             document.getElementById('trace-start-view').style.display='none';
             document.getElementById('trace-qr-view').style.display='block';
             new QRious({element:document.getElementById('batchQRCanvas'), value: currentBatch.id, size:200});
        });
        document.getElementById('simulateScanBtn').addEventListener('click', () => {
            document.getElementById('trace-qr-view').style.display='none';
            document.getElementById('trace-ledger-view').style.display='block';
        });
        document.getElementById('showQRBtn').addEventListener('click', () => {
            document.getElementById('trace-ledger-view').style.display='none';
            document.getElementById('trace-qr-view').style.display='block';
        });
        document.getElementById('saveTransportBtn').addEventListener('click', () => {
            let v = document.getElementById('trans-vehicle').value;
            if(v) { currentBatch.log.push(`Transport: ${v}`); renderLedger(); closeModal('transportModal'); }
        });
        document.getElementById('saveReceiverBtn').addEventListener('click', () => {
            let n = document.getElementById('recv-name').value;
            if(n) { currentBatch.log.push(`Received by: ${n}`); renderLedger(); closeModal('receiverModal'); }
        });

        function renderLedger() {
             let h = "";
             currentBatch.log.forEach(l => h+= `<div class="data-item"><span>${l}</span></div>`);
             document.getElementById('ledger-content').innerHTML = h;
             // Fixed: Added check or ensure element exists in HTML
             const detailsDiv = document.getElementById('ledger-crop-details');
             if(detailsDiv) detailsDiv.innerHTML = `<small style="color:gray;">ID: ${currentBatch.id}</small><br><strong style="color:var(--primary); font-size:1.2rem;">${currentBatch.crop}</strong>`;
             
             let txt = `BATCH: ${currentBatch.id}\n` + currentBatch.log.join('\n');
             new QRious({element:document.getElementById('batchQRCanvas'), value: txt, size:200});
        }
        
        // --- DASHBOARD LOGBOOK ---
        document.getElementById('saveLogBtn').addEventListener('click', () => {
            let t = document.getElementById('log-type').value;
            let n = document.getElementById('log-notes').value;
            if(!n) return;
            db.logs.push({type:t, note:n});
            renderDashboardLogs();
            closeModal('logEntryModal');
        });
        
        function renderDashboardLogs() {
             let h = "";
             if(db.logs.length === 0) {
                 h = `<p style="text-align:center; color:var(--text-muted);" data-i18n="txt_no_entries">No recent activity.</p>`;
             } else {
                 db.logs.slice().reverse().forEach(l => h+= `<div class="data-item"><div><h4 style="margin:0; color:white;">${l.type}</h4><p style="margin:0; font-size:0.85rem; color:var(--text-muted);">${l.note}</p></div></div>`);
             }
             document.getElementById('dashboardLogList').innerHTML = h;
        }

    </script>
</body>
</html>
