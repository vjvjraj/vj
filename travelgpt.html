<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelGPT | Luminous Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- === OPEN SOURCE LIBRARIES === -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        /* === LUMINOUS THEME VARIABLES === */
        :root {
            --bg-deep: #0f172a;
            --accent-primary: #38bdf8; /* Sky Blue */
            --accent-secondary: #818cf8; /* Indigo */
            --accent-tertiary: #f472b6; /* Pink */
            --glass-surface: rgba(30, 41, 59, 0.7);
            --glass-highlight: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep);
            color: #f8fafc;
            overflow: hidden; 
            height: 100dvh; 
            width: 100vw;
        }

        /* === ANIMATED BACKGROUND MESH === */
        .ambient-mesh {
            position: fixed; inset: -50%; z-index: 0;
            background: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(244, 114, 182, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(56, 189, 248, 0.15) 0px, transparent 50%);
            filter: blur(80px);
            animation: meshFloat 20s ease-in-out infinite alternate;
        }
        @keyframes meshFloat { 
            0% { transform: translate(0, 0) scale(1); } 
            100% { transform: translate(-2%, 2%) scale(1.1); } 
        }

        /* === GLASSMORPHISM 3.0 === */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .glass-btn {
            background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid var(--glass-border);
            transition: all 0.2s ease;
        }
        .glass-btn:active { transform: scale(0.95); }

        /* === ANIMATIONS === */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-enter { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }

        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .scan-line {
            width: 100%; height: 3px; 
            background: var(--accent-primary);
            box-shadow: 0 0 20px var(--accent-primary);
            animation: scan 2s linear infinite;
        }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .float-icon { animation: float 3s ease-in-out infinite; }

        /* === UI ELEMENTS === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        select {
            background-image: none; /* Hide default arrow */
            -webkit-appearance: none;
        }
        select option { background-color: #1e293b; color: #fff; padding: 10px; }

        /* Navigation Dock Active State */
        .nav-item { position: relative; transition: all 0.3s ease; opacity: 0.6; }
        .nav-item.active { opacity: 1; transform: translateY(-5px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%; background: var(--accent-primary);
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .nav-item.active i { color: var(--accent-primary); filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.5)); }

        /* Chat Bubbles */
        .chat-bubble-user { 
            background: linear-gradient(135deg, var(--accent-primary), #0284c7); 
            border-radius: 16px 16px 2px 16px; 
            box-shadow: 0 4px 15px rgba(2, 132, 199, 0.3);
        }
        .chat-bubble-ai { 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 16px 16px 16px 2px; 
        }

        #ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    </style>
</head>
<body class="flex justify-center items-center">

    <div class="ambient-mesh"></div>

    <!-- MAIN APP WRAPPER -->
    <div class="relative w-full h-full md:max-w-md md:h-[95vh] bg-[#0f172a]/80 md:rounded-[3rem] md:border-[1px] md:border-white/10 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.5)] flex flex-col z-10 overflow-hidden backdrop-blur-md">
        
        <!-- === HEADER === -->
        <header class="absolute top-0 w-full z-40 px-6 pt-12 pb-4 md:pt-6 flex justify-between items-center bg-gradient-to-b from-[#0f172a] to-transparent">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-sky-400 to-indigo-600 flex items-center justify-center shadow-lg shadow-sky-500/20 float-icon">
                    <i class="ph-fill ph-planet text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-white tracking-tight leading-none">Travel<span class="text-sky-400">GPT</span></h1>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.25em]">Super App</span>
                </div>
            </div>
            <div class="flex items-center gap-2 bg-white/5 rounded-full p-1 pr-3 border border-white/5">
                <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-white/10">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full bg-slate-700" />
                </div>
                <div class="flex flex-col">
                    <span class="text-[8px] text-slate-400 font-bold uppercase">Status</span>
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        <span class="text-[9px] font-bold text-emerald-400">Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- === CONTENT AREA === -->
        <main class="flex-1 relative w-full h-full">

            <!-- === 1. HOME VIEW === -->
            <section id="view-home" class="view-section absolute inset-0 pt-32 px-6 pb-32 overflow-y-auto no-scrollbar space-y-6">
                
                <!-- Location Selector Card -->
                <div class="glass-panel p-5 rounded-3xl animate-enter">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <i class="ph-duotone ph-map-pin text-sky-400"></i>
                            <span class="text-xs font-bold text-slate-300 uppercase tracking-wider">Destination</span>
                        </div>
                        <button onclick="detectLiveLocation()" class="group flex items-center gap-1.5 bg-sky-500/10 hover:bg-sky-500/20 text-sky-400 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all border border-sky-500/20">
                            <i class="ph-bold ph-crosshair group-hover:rotate-45 transition-transform"></i> Auto-Detect
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="relative group">
                            <select id="state-select" onchange="populateDistricts()" class="w-full bg-slate-900/50 text-xs font-semibold text-white p-3.5 rounded-xl border border-white/10 focus:border-sky-500/50 focus:outline-none transition-colors appearance-none cursor-pointer">
                                <option value="">State</option>
                            </select>
                            <i class="ph-bold ph-caret-down absolute right-3 top-3.5 text-slate-500 group-hover:text-sky-400 transition-colors pointer-events-none"></i>
                        </div>
                        <div class="relative group">
                            <select id="district-select" onchange="teleportToDistrict()" class="w-full bg-slate-900/50 text-xs font-semibold text-white p-3.5 rounded-xl border border-white/10 focus:border-sky-500/50 focus:outline-none transition-colors appearance-none cursor-pointer disabled:opacity-50" disabled>
                                <option value="">District</option>
                            </select>
                            <i class="ph-bold ph-caret-down absolute right-3 top-3.5 text-slate-500 group-hover:text-sky-400 transition-colors pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="relative">
                        <input type="text" id="teleport-query" placeholder="Search specific town..." class="w-full bg-slate-900/50 text-sm text-white pl-10 pr-10 py-3 rounded-xl border border-white/10 focus:border-sky-500/50 focus:outline-none placeholder-slate-500 transition-colors">
                        <i class="ph-bold ph-magnifying-glass absolute left-3.5 top-3.5 text-slate-500"></i>
                        <button onclick="teleportToCity()" id="btn-teleport" class="absolute right-2 top-2 bg-sky-500 hover:bg-sky-400 text-slate-900 w-8 h-8 rounded-lg flex items-center justify-center transition-transform active:scale-95">
                            <i class="ph-bold ph-paper-plane-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Weather Card -->
                <div class="relative w-full h-44 rounded-[2rem] overflow-hidden shadow-2xl animate-enter" style="animation-delay: 0.1s;">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-600 to-purple-800"></div>
                    <div class="absolute -right-8 -top-8 w-40 h-40 bg-pink-500 rounded-full blur-[60px] opacity-40"></div>
                    <div class="absolute -left-8 -bottom-8 w-40 h-40 bg-sky-500 rounded-full blur-[60px] opacity-40"></div>
                    
                    <div class="absolute inset-0 p-6 flex justify-between items-center z-10">
                        <div class="flex flex-col justify-between h-full">
                            <div class="glass-panel px-3 py-1 rounded-full border-white/10 inline-flex items-center gap-1.5 w-fit">
                                <i class="ph-fill ph-map-pin text-sky-300 text-xs"></i>
                                <span id="weather-loc" class="text-[10px] font-bold text-white uppercase tracking-wider">Finding...</span>
                            </div>
                            <div>
                                <h2 id="weather-temp" class="text-6xl font-bold text-white tracking-tighter drop-shadow-lg">--¬∞</h2>
                                <p id="weather-desc" class="text-sm font-medium text-indigo-100 flex items-center gap-2">
                                    <i class="ph-bold ph-wind"></i> Live Weather
                                </p>
                            </div>
                        </div>
                        <i id="weather-icon" class="ph-duotone ph-cloud-sun text-7xl text-yellow-300 drop-shadow-lg float-icon"></i>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-4 animate-enter" style="animation-delay: 0.2s;">
                    <div class="flex justify-between items-center px-1">
                        <h3 class="text-sm font-bold text-slate-200">Discover Nearby</h3>
                    </div>
                    
                    <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                        <button onclick="quickSearch('attractions')" class="glass-btn pl-3 pr-4 py-2.5 rounded-xl flex items-center gap-2 text-xs font-bold text-amber-300 hover:bg-amber-500/10 border-amber-500/20 active:scale-95 whitespace-nowrap">
                            <i class="ph-fill ph-star text-lg"></i> Top 20
                        </button>
                        <button onclick="quickSearch('temple')" class="glass-btn pl-3 pr-4 py-2.5 rounded-xl flex items-center gap-2 text-xs font-bold text-purple-300 hover:bg-purple-500/10 border-purple-500/20 active:scale-95 whitespace-nowrap">
                            <i class="ph-fill ph-mosque text-lg"></i> Temples
                        </button>
                        <button onclick="quickSearch('restaurant')" class="glass-btn pl-3 pr-4 py-2.5 rounded-xl flex items-center gap-2 text-xs font-bold text-orange-300 hover:bg-orange-500/10 border-orange-500/20 active:scale-95 whitespace-nowrap">
                            <i class="ph-fill ph-hamburger text-lg"></i> Food
                        </button>
                        <button onclick="quickSearch('park')" class="glass-btn pl-3 pr-4 py-2.5 rounded-xl flex items-center gap-2 text-xs font-bold text-green-300 hover:bg-green-500/10 border-green-500/20 active:scale-95 whitespace-nowrap">
                            <i class="ph-fill ph-tree text-lg"></i> Parks
                        </button>
                        <button onclick="quickSearch('shopping')" class="glass-btn pl-3 pr-4 py-2.5 rounded-xl flex items-center gap-2 text-xs font-bold text-pink-300 hover:bg-pink-500/10 border-pink-500/20 active:scale-95 whitespace-nowrap">
                            <i class="ph-fill ph-shopping-bag text-lg"></i> Shop
                        </button>
                        <button onclick="quickSearch('hotel')" class="glass-btn pl-3 pr-4 py-2.5 rounded-xl flex items-center gap-2 text-xs font-bold text-blue-300 hover:bg-blue-500/10 border-blue-500/20 active:scale-95 whitespace-nowrap">
                            <i class="ph-fill ph-bed text-lg"></i> Stay
                        </button>
                    </div>
                    <input type="hidden" id="osm-query">
                </div>

                <!-- Results List -->
                <div id="results-area" class="space-y-3 pb-6 animate-enter" style="animation-delay: 0.3s;">
                    <div class="flex flex-col items-center justify-center py-10 opacity-40">
                        <div class="w-14 h-14 rounded-full bg-slate-800 flex items-center justify-center mb-3">
                            <i class="ph-duotone ph-compass text-3xl text-slate-400"></i>
                        </div>
                        <p class="text-xs text-slate-400 font-medium">Select a category to explore</p>
                    </div>
                </div>
            </section>

            <!-- === 2. MAP VIEW === -->
            <section id="view-map" class="view-section absolute inset-0 hidden">
                <div id="map" class="w-full h-full bg-[#0f172a] grayscale-[20%]"></div>
                <!-- Floating Controls -->
                <button onclick="locateUser()" class="absolute bottom-32 right-6 z-[400] w-12 h-12 bg-white text-slate-900 rounded-2xl shadow-xl flex items-center justify-center active:scale-90 transition-transform">
                    <i class="ph-bold ph-crosshair text-xl"></i>
                </button>
            </section>

            <!-- === 3. AR / CAMERA VIEW === -->
            <section id="view-ar" class="view-section absolute inset-0 hidden bg-black">
                <video id="ar-video" autoplay playsinline muted loop class="absolute inset-0 w-full h-full object-cover opacity-90"></video>
                <img id="ar-static-img" class="absolute inset-0 w-full h-full object-contain bg-black hidden z-10">
                <canvas id="ar-canvas" class="relative z-10"></canvas>
                <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="handleFileUpload(this)">

                <!-- Camera Error UI -->
                <div id="camera-error" class="hidden absolute inset-0 z-[60] flex flex-col items-center justify-center bg-slate-950/90 p-8 text-center backdrop-blur-sm">
                    <div class="w-16 h-16 bg-red-500/10 rounded-full mb-4 flex items-center justify-center border border-red-500/20">
                        <i class="ph-duotone ph-camera-slash text-3xl text-red-500"></i>
                    </div>
                    <h3 class="text-white font-bold text-lg mb-2">Camera Blocked</h3>
                    <p class="text-slate-400 text-sm mb-6 max-w-[200px]">We need vision access to scan objects and translate text.</p>
                    <button onclick="startDemoMode()" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl text-sm font-bold border border-white/10 transition-colors">
                        Launch Simulation
                    </button>
                </div>

                <!-- AR Overlay Controls -->
                <div class="absolute top-28 left-4 right-4 z-20 flex flex-col gap-3">
                    <div class="glass-panel p-1 rounded-xl flex gap-1">
                        <button onclick="switchVision('object')" id="btn-vis-obj" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition-all bg-sky-500 text-slate-900 shadow-lg">Object</button>
                        <button onclick="switchVision('ocr')" id="btn-vis-ocr" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition-all text-white hover:bg-white/5">Text Scanner</button>
                    </div>
                    
                    <!-- OCR Settings -->
                    <div id="ocr-controls" class="hidden flex gap-2 animate-enter">
                        <div class="glass-panel px-3 py-2 rounded-xl flex-1 flex items-center gap-2 border-white/20">
                            <span class="text-[10px] text-sky-400 uppercase font-bold whitespace-nowrap">Read:</span>
                            <select id="ocr-source-lang" class="bg-transparent text-white text-xs font-bold w-full focus:outline-none cursor-pointer">
                                <option value="eng">English</option>
                                <option value="hin">Hindi</option>
                                <option value="kan">Kannada</option>
                                <option value="tam">Tamil</option>
                                <option value="tel">Telugu</option>
                                <option value="mal">Malayalam</option>
                            </select>
                        </div>
                        <button onclick="triggerUpload()" class="bg-indigo-600 text-white w-10 rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                            <i class="ph-bold ph-image text-lg"></i>
                        </button>
                    </div>
                    
                    <div id="ocr-lang-panel" class="hidden glass-panel px-3 py-2 rounded-xl flex items-center gap-2 border-white/20 animate-enter" style="animation-delay: 0.05s;">
                        <span class="text-[10px] text-pink-400 uppercase font-bold whitespace-nowrap">To:</span>
                        <select id="target-lang" onchange="updateArTranslation()" class="bg-transparent text-white text-xs font-bold w-full focus:outline-none cursor-pointer">
                            <option value="en">English</option>
                            <option value="hi">Hindi</option>
                            <option value="kn">Kannada</option>
                            <option value="ta">Tamil</option>
                            <option value="te">Telugu</option>
                            <option value="ml">Malayalam</option>
                        </select>
                    </div>
                </div>

                <!-- Result Card -->
                <div id="ocr-result" class="absolute bottom-32 left-4 right-4 glass-panel p-5 rounded-2xl hidden backdrop-blur-xl z-30 animate-enter">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                            <p class="text-[10px] text-slate-300 uppercase font-bold tracking-widest">Live Analysis</p>
                        </div>
                        <button onclick="closeOcr()" class="text-slate-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <p id="ocr-text" class="text-xs text-slate-400 font-mono mb-3 line-clamp-2 pl-3 border-l-2 border-white/10">Scanning visual input...</p>
                    <div class="bg-white/5 p-3 rounded-xl border border-white/5">
                        <p class="text-[9px] text-sky-400 uppercase font-bold mb-1">Translation</p>
                        <p id="ocr-trans-text" class="text-sm text-white font-bold leading-relaxed">...</p>
                    </div>
                </div>
            </section>

            <!-- === 4. TRANSLATOR VIEW === -->
            <section id="view-translate" class="view-section absolute inset-0 hidden pt-32 px-6 pb-28 overflow-y-auto no-scrollbar">
                <div class="flex flex-col h-full gap-5">
                    
                    <!-- Language Bar -->
                    <div class="glass-panel p-2 rounded-[1.5rem] flex items-center justify-between">
                        <div class="flex-1 px-2">
                            <label class="text-[9px] text-slate-500 font-bold uppercase block pl-1 mb-0.5">From</label>
                            <select id="trans-source" class="w-full bg-transparent text-sky-400 font-bold text-sm focus:outline-none">
                                <option value="en">English</option>
                                <option value="hi">Hindi</option>
                                <option value="kn">Kannada</option>
                                <option value="ta">Tamil</option>
                                <option value="te">Telugu</option>
                                <option value="ml">Malayalam</option>
                            </select>
                        </div>
                        <button onclick="swapLanguages()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-slate-400 hover:bg-white/10 hover:text-white transition-all active:rotate-180 duration-300 border border-white/5">
                            <i class="ph-bold ph-arrows-left-right"></i>
                        </button>
                        <div class="flex-1 px-2 text-right">
                            <label class="text-[9px] text-slate-500 font-bold uppercase block pr-1 mb-0.5">To</label>
                            <select id="trans-target" class="w-full bg-transparent text-white font-bold text-sm focus:outline-none text-right" dir="rtl">
                                <option value="hi">Hindi</option>
                                <option value="en">English</option>
                                <option value="kn">Kannada</option>
                                <option value="ta">Tamil</option>
                                <option value="te">Telugu</option>
                                <option value="ml">Malayalam</option>
                            </select>
                        </div>
                    </div>

                    <!-- Input/Output Card -->
                    <div class="glass-panel p-5 rounded-[2rem] flex-1 flex flex-col relative border-white/10">
                        <textarea id="trans-input" class="w-full h-1/2 bg-transparent text-lg text-white placeholder-slate-600 border-none focus:outline-none resize-none font-medium leading-relaxed" placeholder="Tap to type or use voice..."></textarea>
                        
                        <div class="h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent w-full my-4"></div>
                        
                        <div class="flex-1 relative">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-[10px] text-pink-400 uppercase font-bold">Result</p>
                                <button onclick="speakTranslation()" class="text-slate-400 hover:text-white transition-colors"><i class="ph-fill ph-speaker-high text-lg"></i></button>
                            </div>
                            <p id="trans-output" class="text-lg text-slate-200 font-medium leading-relaxed">...</p>
                            
                            <!-- Loader -->
                            <div id="trans-loading" class="absolute inset-0 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm hidden rounded-xl">
                                <div class="flex flex-col items-center gap-2">
                                    <i class="ph-bold ph-spinner animate-spin text-3xl text-sky-400"></i>
                                    <span class="text-[10px] font-bold text-sky-400 uppercase tracking-widest">Translating</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="grid grid-cols-[1fr_auto] gap-3">
                        <button onclick="translateTextManual()" class="bg-white text-slate-900 h-14 rounded-2xl font-bold shadow-lg shadow-white/10 active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-slate-200">
                            <i class="ph-bold ph-translate text-lg"></i> TRANSLATE
                        </button>
                        <button id="btn-trans-mic" onmousedown="toggleVoiceInput()" ontouchstart="toggleVoiceInput()" class="w-14 h-14 bg-slate-800 text-white rounded-2xl border border-white/10 active:scale-90 transition-all flex items-center justify-center relative overflow-hidden group">
                            <div id="mic-pulse" class="absolute inset-0 bg-red-500/20 hidden animate-pulse"></div>
                            <i class="ph-fill ph-microphone text-2xl relative z-10 group-hover:scale-110 transition-transform"></i>
                        </button>
                    </div>
                    <p id="mic-status" class="text-center text-[10px] text-slate-500 h-4 font-mono uppercase tracking-widest"></p>
                </div>
            </section>

            <!-- === 5. AI ASSISTANT === -->
            <section id="view-notebook" class="view-section absolute inset-0 hidden pt-32 px-6 pb-32 overflow-y-auto no-scrollbar">
                
                <!-- Tab Switcher -->
                <div class="glass-panel p-1 rounded-xl flex gap-1 mb-6">
                    <button onclick="toggleNoteMode('chat')" id="tab-chat" class="flex-1 py-2.5 rounded-lg text-xs font-bold text-slate-900 bg-sky-400 transition-all shadow-lg flex items-center justify-center gap-2">
                        <i class="ph-fill ph-chat-circle-dots text-base"></i> Chat
                    </button>
                    <button onclick="toggleNoteMode('notes')" id="tab-notes" class="flex-1 py-2.5 rounded-lg text-xs font-bold text-slate-400 hover:text-white transition-all flex items-center justify-center gap-2">
                        <i class="ph-bold ph-notebook text-base"></i> Notes
                    </button>
                </div>

                <!-- Chat Interface -->
                <div id="ai-chat-container" class="flex flex-col h-[65vh]">
                    <div id="chat-history" class="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                        <div class="flex gap-3 max-w-[90%] chat-bubble-ai p-4 animate-enter">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shrink-0 shadow-lg border border-white/10">
                                <i class="ph-fill ph-robot text-white"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium leading-relaxed text-slate-200">Hello traveler! üåç<br>I can guide you to nearby spots or answer questions like "Best time to visit Coorg".</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-2 rounded-[1.5rem] flex items-center gap-3 focus-within:border-sky-500/50 mt-auto transition-colors">
                        <input type="text" id="chat-input" placeholder="Ask anything..." class="bg-transparent border-none text-sm w-full py-3 px-3 focus:outline-none text-white placeholder-slate-500 font-medium" onkeypress="handleChatKey(event)">
                        <button onclick="sendChat()" class="bg-sky-500 text-slate-900 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-sky-400 transition-all active:scale-90 shadow-lg">
                            <i class="ph-bold ph-paper-plane-right text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Notepad Interface -->
                <div id="notepad-container" class="hidden h-full flex flex-col">
                    <div class="glass-panel p-6 rounded-[2rem] flex-1 flex flex-col relative border-white/10">
                        <textarea id="user-notes" class="w-full h-full bg-transparent text-sm text-slate-200 placeholder-slate-600 border-none focus:outline-none resize-none leading-loose font-mono" placeholder="// Trip Log\n\n1. Flight at 10 AM\n2. Hotel Check-in..." oninput="saveNote()"></textarea>
                        <div class="absolute bottom-5 right-5 flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                            <span class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest">Synced</span>
                        </div>
                    </div>
                </div>

            </section>

        </main>

        <!-- === FLOATING DOCK NAVIGATION === -->
        <nav class="absolute bottom-8 left-6 right-6 h-[72px] glass-panel rounded-[24px] z-50 flex justify-between items-center px-6 shadow-2xl border-white/20">
            <button onclick="switchTab('home')" class="nav-item active flex-1 flex flex-col items-center justify-center gap-1">
                <i class="ph-fill ph-house text-2xl"></i>
                <span class="text-[9px] font-bold">Home</span>
            </button>
            <button onclick="switchTab('map')" class="nav-item flex-1 flex flex-col items-center justify-center gap-1">
                <i class="ph-bold ph-map-trifold text-2xl"></i>
                <span class="text-[9px] font-bold">Map</span>
            </button>
            <button onclick="switchTab('ar')" class="nav-item flex-1 flex flex-col items-center justify-center gap-1">
                <div class="w-14 h-14 bg-gradient-to-tr from-sky-400 to-indigo-500 rounded-full flex items-center justify-center text-white shadow-[0_0_20px_rgba(56,189,248,0.4)] -mt-10 border-4 border-[#0f172a] hover:scale-110 transition-transform">
                    <i class="ph-bold ph-camera text-2xl"></i>
                </div>
            </button>
            <button onclick="switchTab('translate')" class="nav-item flex-1 flex flex-col items-center justify-center gap-1">
                <i class="ph-bold ph-translate text-2xl"></i>
                <span class="text-[9px] font-bold">Voice</span>
            </button>
            <button onclick="switchTab('notebook')" class="nav-item flex-1 flex flex-col items-center justify-center gap-1">
                <i class="ph-bold ph-robot text-2xl"></i>
                <span class="text-[9px] font-bold">AI</span>
            </button>
        </nav>

    </div>

    <!-- === JAVASCRIPT LOGIC (UNCHANGED FUNCTIONALITY) === -->
    <script>
        let currentLat = 28.6139; let currentLng = 77.2090;
        let map = null; let mapMarkers = []; let objectModel = null;
        let isCameraOn = false; let visionMode = 'object'; let processingOCR = false;
        let lastOcrText = ""; let recognition = null; let isListening = false;

        const indiaData = {
            "Andaman & Nicobar": ["Port Blair", "Havelock Island"], "Andhra Pradesh": ["Visakhapatnam", "Tirupati", "Vijayawada"],
            "Arunachal Pradesh": ["Tawang", "Itanagar"], "Assam": ["Guwahati", "Kaziranga"], "Bihar": ["Patna", "Bodh Gaya"],
            "Chandigarh": ["Chandigarh City"], "Chhattisgarh": ["Raipur", "Jagdalpur"], "Delhi": ["New Delhi", "South Delhi"],
            "Goa": ["North Goa", "South Goa", "Panaji"], "Gujarat": ["Ahmedabad", "Surat", "Kutch"], "Haryana": ["Gurgaon", "Kurukshetra"],
            "Himachal Pradesh": ["Shimla", "Manali", "Dharamshala"], "Jammu & Kashmir": ["Srinagar", "Gulmarg"], "Jharkhand": ["Ranchi", "Jamshedpur"],
            "Karnataka": ["Bengaluru", "Mysuru", "Coorg", "Hampi"], "Kerala": ["Kochi", "Munnar", "Alleppey", "Wayanad"],
            "Ladakh": ["Leh", "Nubra Valley"], "Madhya Pradesh": ["Bhopal", "Indore", "Khajuraho"], "Maharashtra": ["Mumbai", "Pune", "Lonavala", "Nashik"],
            "Manipur": ["Imphal"], "Meghalaya": ["Shillong", "Cherrapunji"], "Mizoram": ["Aizawl"], "Nagaland": ["Kohima"],
            "Odisha": ["Bhubaneswar", "Puri"], "Punjab": ["Amritsar", "Ludhiana"], "Rajasthan": ["Jaipur", "Udaipur", "Jodhpur", "Jaisalmer"],
            "Sikkim": ["Gangtok", "Pelling"], "Tamil Nadu": ["Chennai", "Ooty", "Madurai", "Rameswaram"], "Telangana": ["Hyderabad", "Warangal"],
            "Tripura": ["Agartala"], "Uttar Pradesh": ["Agra", "Varanasi", "Lucknow"], "Uttarakhand": ["Dehradun", "Rishikesh", "Nainital"],
            "West Bengal": ["Kolkata", "Darjeeling"]
        };

        async function safeJsonFetch(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(res.status);
                const txt = await res.text();
                return JSON.parse(txt);
            } catch (e) { console.warn(e); throw e; }
        }

        function populateStates() {
            const sel = document.getElementById('state-select');
            for (let s in indiaData) { let o = document.createElement('option'); o.value=s; o.text=s; sel.appendChild(o); }
        }
        function populateDistricts() {
            const sSel = document.getElementById('state-select');
            const dSel = document.getElementById('district-select');
            dSel.innerHTML = '<option value="">District</option>';
            if(sSel.value) { dSel.disabled=false; indiaData[sSel.value].forEach(d=>{let o=document.createElement('option');o.value=d;o.text=d;dSel.appendChild(o);}); }
            else dSel.disabled=true;
        }

        async function detectLiveLocation() {
            if(!navigator.geolocation) return alert("No GPS");
            document.getElementById('weather-loc').innerText = "Triangulating...";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                currentLat = pos.coords.latitude; currentLng = pos.coords.longitude;
                localStorage.setItem('lastLat', currentLat); localStorage.setItem('lastLng', currentLng);
                fetchWeather(); 
                if(map) { map.setView([currentLat, currentLng], 14); L.marker([currentLat, currentLng]).addTo(map).bindPopup("You").openPopup(); }
                
                try {
                    const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}`);
                    const city = data.address.city || data.address.town || data.address.village || "Unknown";
                    document.getElementById('weather-loc').innerText = city;
                    document.getElementById('osm-query').value = 'attractions';
                    queryOverpass();
                } catch(e) { console.error(e); }
            });
        }

        async function teleportToDistrict() {
            const s = document.getElementById('state-select').value;
            const d = document.getElementById('district-select').value;
            if(!d) return;
            const btn = document.getElementById('btn-teleport');
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';
            try {
                const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(d + ',' + s + ', India')}`);
                if(data.length) {
                    currentLat = parseFloat(data[0].lat); currentLng = parseFloat(data[0].lon);
                    localStorage.setItem('lastLat', currentLat); localStorage.setItem('lastLng', currentLng);
                    fetchWeather();
                    if(map) { map.setView([currentLat, currentLng], 14); L.marker([currentLat, currentLng]).addTo(map).bindPopup(d).openPopup(); }
                    document.getElementById('osm-query').value = 'attractions';
                    queryOverpass();
                }
            } catch(e){}
            btn.innerHTML = '<i class="ph-bold ph-paper-plane-right"></i>';
        }

        async function teleportToCity() {
            const q = document.getElementById('teleport-query').value;
            if(!q) return;
            try {
                const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                if(data.length) {
                    currentLat = parseFloat(data[0].lat); currentLng = parseFloat(data[0].lon);
                    fetchWeather(); fetchCityName();
                    if(map) { map.setView([currentLat, currentLng], 14); L.marker([currentLat, currentLng]).addTo(map).bindPopup(q).openPopup(); }
                    document.getElementById('osm-query').value = 'attractions';
                    queryOverpass();
                }
            } catch(e){}
        }

        async function fetchWeather() {
            try {
                const data = await safeJsonFetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLng}&current_weather=true`);
                document.getElementById('weather-temp').innerText = `${Math.round(data.current_weather.temperature)}¬∞`;
                document.getElementById('weather-desc').innerText = `Wind: ${data.current_weather.windspeed} km/h`;
            } catch(e){}
        }
        async function fetchCityName() {
            try {
                const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}`);
                document.getElementById('weather-loc').innerText = data.address.city || "Unknown Location";
            } catch(e){}
        }

        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl: false}).setView([currentLat, currentLng], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map);
            L.marker([currentLat, currentLng]).addTo(map).bindPopup("Start").openPopup();
        }
        function locateUser() { map.setView([currentLat, currentLng], 16); }

        function quickSearch(type) {
            document.getElementById('osm-query').value = type;
            queryOverpass();
        }

        async function queryOverpass() {
            let q = document.getElementById('osm-query').value;
            const resArea = document.getElementById('results-area');
            resArea.innerHTML = '<div class="text-center py-10 opacity-50 text-xs animate-pulse text-sky-400 font-bold">Scouting Sector...</div>';
            
            let ql = '';
            const r = 5000;
            if(q==='attractions') ql = `[out:json][timeout:25];(node["tourism"~"attraction|viewpoint"](around:${r},${currentLat},${currentLng});node["historic"](around:${r},${currentLat},${currentLng}););out 25;`;
            else if(q==='temple') ql = `[out:json][timeout:25];node["amenity"="place_of_worship"](around:${r},${currentLat},${currentLng});out 25;`;
            else if(q==='park') ql = `[out:json][timeout:25];node["leisure"="park"](around:${r},${currentLat},${currentLng});out 25;`;
            else ql = `[out:json][timeout:25];node["amenity"~"${q.includes('hotel')?'hotel':q}"](around:${r},${currentLat},${currentLng});out 25;`;

            const eps = ['https://overpass-api.de/api/interpreter', 'https://lz4.overpass-api.de/api/interpreter'];
            let data=null;
            for(let ep of eps) { try{ data=await safeJsonFetch(`${ep}?data=${encodeURIComponent(ql)}`); if(data) break; }catch(e){} }

            resArea.innerHTML=''; mapMarkers.forEach(m=>map.removeLayer(m)); mapMarkers=[];
            if(!data || !data.elements.length) resArea.innerHTML = '<div class="text-center py-10 opacity-30 text-xs font-bold">Sector Empty</div>';
            else {
                data.elements.slice(0,25).forEach((p, i) => {
                    const name = p.tags.name; if(!name) return;
                    const url = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}`;
                    let icon = 'ph-map-pin';
                    if(p.tags.tourism) icon='ph-camera'; else if(p.tags.amenity==='place_of_worship') icon='ph-mosque';
                    
                    const card = document.createElement('div');
                    card.className = "glass-panel p-4 rounded-2xl flex justify-between items-center mb-3 animate-enter group hover:border-sky-500/30";
                    card.style.animationDelay = `${i*0.05}s`;
                    card.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-xl bg-slate-800/80 flex items-center justify-center text-sky-400 shrink-0 shadow-lg group-hover:scale-110 transition-transform"><i class="ph-fill ${icon} text-lg"></i></div>
                            <div class="truncate">
                                <h4 class="text-sm font-bold text-slate-100 truncate">${name}</h4>
                                <p class="text-[10px] text-slate-400 font-medium truncate uppercase tracking-wide">${p.tags.amenity||p.tags.tourism||"Location"}</p>
                            </div>
                        </div>
                        <a href="${url}" target="_blank" class="w-10 h-10 rounded-xl bg-sky-600 flex items-center justify-center text-white hover:bg-sky-400 transition-colors shadow-lg active:scale-95"><i class="ph-bold ph-navigation-arrow"></i></a>
                    `;
                    resArea.appendChild(card);
                    const m=L.marker([p.lat, p.lon]).addTo(map).bindPopup(name);
                    mapMarkers.push(m);
                });
            }
        }

        // --- TRANSLATOR ---
        function swapLanguages() {
            const s=document.getElementById('trans-source'); const t=document.getElementById('trans-target');
            const tmp=s.value; s.value=t.value; t.value=tmp;
        }
        async function translateTextManual() {
            const i=document.getElementById('trans-input').value;
            const o=document.getElementById('trans-output');
            const l=document.getElementById('trans-loading');
            if(!i) return;
            l.classList.remove('hidden');
            try {
                const s=document.getElementById('trans-source').value; const t=document.getElementById('trans-target').value;
                const data=await safeJsonFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(i)}&langpair=${s}|${t}`);
                o.innerText = data.responseData.translatedText || i;
            } catch(e) { o.innerText="Error"; } finally { l.classList.add('hidden'); }
        }
        function speakTranslation() {
            const t=document.getElementById('trans-output').innerText;
            if(!t || t==="...") return;
            const u=new SpeechSynthesisUtterance(t);
            u.lang=document.getElementById('trans-target').value;
            window.speechSynthesis.speak(u);
        }
        function initSpeech() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(SR) {
                recognition = new SR(); recognition.continuous=false; recognition.interimResults=true;
                recognition.onstart = () => { document.getElementById('mic-pulse').classList.remove('hidden'); document.getElementById('mic-status').innerText="LISTENING..."; };
                recognition.onend = () => { document.getElementById('mic-pulse').classList.add('hidden'); document.getElementById('mic-status').innerText=""; if(document.getElementById('trans-input').value) translateTextManual(); isListening=false; };
                recognition.onresult = (e) => document.getElementById('trans-input').value = Array.from(e.results).map(r=>r[0].transcript).join('');
            }
        }
        function toggleVoiceInput() {
            if(!recognition) return alert("Not Supported");
            if(isListening) recognition.stop();
            else {
                const langMap = {'en':'en-US','hi':'hi-IN','kn':'kn-IN','ta':'ta-IN','te':'te-IN','ml':'ml-IN'};
                recognition.lang = langMap[document.getElementById('trans-source').value];
                recognition.start();
            }
        }

        // --- AR/OCR ---
        async function startCamera() {
            const v=document.getElementById('ar-video'); const s=document.getElementById('ar-static-img');
            s.classList.add('hidden'); v.classList.remove('hidden'); isCameraOn=true;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                v.srcObject=stream; v.play();
                document.getElementById('camera-error').classList.add('hidden');
                requestAnimationFrame(processVideoFrame);
            } catch(e) { document.getElementById('camera-error').classList.remove('hidden'); }
        }
        function startDemoMode() {
            const v=document.getElementById('ar-video');
            v.srcObject=null; v.src="https://videos.pexels.com/video-files/3195652/3195652-sd_640_360_25fps.mp4"; v.play();
            isCameraOn=true; document.getElementById('camera-error').classList.add('hidden');
            requestAnimationFrame(processVideoFrame);
        }
        function stopCamera() {
            const v=document.getElementById('ar-video');
            if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
            v.pause(); isCameraOn=false;
        }
        function switchVision(m) {
            visionMode=m;
            const ocr = document.getElementById('ocr-controls'); const lang = document.getElementById('ocr-lang-panel'); const res = document.getElementById('ocr-result');
            const objBtn = document.getElementById('btn-vis-obj'); const ocrBtn = document.getElementById('btn-vis-ocr');
            
            if(m==='object') {
                ocr.classList.add('hidden'); lang.classList.add('hidden'); res.classList.add('hidden');
                objBtn.classList.replace('bg-white/10', 'bg-sky-500'); objBtn.classList.replace('text-white', 'text-slate-900');
                ocrBtn.classList.replace('bg-sky-500', 'bg-white/10'); ocrBtn.classList.replace('text-slate-900', 'text-white');
            } else {
                ocr.classList.remove('hidden'); lang.classList.remove('hidden'); res.classList.remove('hidden');
                ocrBtn.classList.replace('bg-white/10', 'bg-sky-500'); ocrBtn.classList.replace('text-white', 'text-slate-900');
                objBtn.classList.replace('bg-sky-500', 'bg-white/10'); objBtn.classList.replace('text-slate-900', 'text-white');
            }
        }
        function closeOcr() { document.getElementById('ocr-result').classList.add('hidden'); }
        function triggerUpload() { document.getElementById('img-upload').click(); }
        function handleFileUpload(inp) {
            if(inp.files[0]) {
                const r = new FileReader();
                r.onload = function(e) {
                    const v=document.getElementById('ar-video'); const s=document.getElementById('ar-static-img');
                    isCameraOn=false; v.pause(); v.classList.add('hidden'); s.src=e.target.result; s.classList.remove('hidden');
                    setTimeout(()=>runOCR(s), 500);
                }
                r.readAsDataURL(inp.files[0]);
            }
        }
        async function processVideoFrame() {
            if(!isCameraOn) return;
            const v=document.getElementById('ar-video'); const c=document.getElementById('ar-canvas'); const ctx=c.getContext('2d');
            if(v.readyState>=2) {
                c.width=v.videoWidth; c.height=v.videoHeight; ctx.clearRect(0,0,c.width,c.height);
                if(visionMode==='object' && objectModel) {
                    try {
                        const ps = await objectModel.detect(v);
                        ps.forEach(p=>{
                            ctx.strokeStyle='#38bdf8'; ctx.lineWidth=4; ctx.strokeRect(p.bbox[0],p.bbox[1],p.bbox[2],p.bbox[3]);
                            ctx.font='18px Plus Jakarta Sans'; ctx.fillStyle='#38bdf8'; ctx.fillText(p.class, p.bbox[0], p.bbox[1]>20?p.bbox[1]-10:20);
                        });
                    } catch(e){}
                } else if(visionMode==='ocr' && !processingOCR && Date.now()%3000<100) runOCR(v);
            }
            requestAnimationFrame(processVideoFrame);
        }
        async function updateArTranslation() {
            if(!lastOcrText) return;
            const resEl = document.getElementById('ocr-trans-text');
            resEl.innerText = "Translating...";
            const s3 = document.getElementById('ocr-source-lang').value;
            const t = document.getElementById('target-lang').value;
            const map3to2 = {'eng':'en','hin':'hi','kan':'kn','tam':'ta','tel':'te','mal':'ml'};
            try {
                const data = await safeJsonFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(lastOcrText)}&langpair=${map3to2[s3]}|${t}`);
                resEl.innerText = data.responseData.translatedText || lastOcrText;
            } catch(e) { resEl.innerText = "Error"; }
        }
        async function runOCR(src) {
            if(processingOCR) return; processingOCR=true;
            const txtEl = document.getElementById('ocr-text'); const transEl = document.getElementById('ocr-trans-text');
            txtEl.innerText="Scanning...";
            const cvs = document.createElement('canvas');
            if(src.tagName==='VIDEO') { cvs.width=src.videoWidth; cvs.height=src.videoHeight; } else { cvs.width=src.naturalWidth; cvs.height=src.naturalHeight; }
            cvs.getContext('2d').drawImage(src,0,0);
            
            try {
                const res = await Tesseract.recognize(cvs, document.getElementById('ocr-source-lang').value, {
                    workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
                    corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js'
                });
                const txt = res.data.text.replace(/\n/g,' ').trim();
                if(txt.length>2) { lastOcrText=txt; txtEl.innerText=txt; await updateArTranslation(); }
                else { txtEl.innerText="No Text"; transEl.innerText="..."; }
            } catch(e){ txtEl.innerText="Scan Error"; } finally { processingOCR=false; cvs.remove(); }
        }

        // --- APP SHELL ---
        window.onload = async () => {
            populateStates();
            const lat = localStorage.getItem('lastLat');
            if(lat) { currentLat=parseFloat(lat); currentLng=parseFloat(localStorage.getItem('lastLng')); fetchWeather(); fetchCityName(); initMap(); }
            else { detectLiveLocation(); initMap(); }
            try{ objectModel = await cocoSsd.load(); }catch(e){}
            initSpeech();
        };

        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(el=>{el.classList.add('hidden'); el.classList.remove('opacity-100'); el.classList.add('opacity-0');});
            const v = document.getElementById(`view-${t}`);
            v.classList.remove('hidden'); 
            setTimeout(()=>v.classList.remove('opacity-0'), 50);
            
            if(t==='ar') startCamera(); else stopCamera();
            if(t==='map' && map) setTimeout(()=>map.invalidateSize(), 200);

            document.querySelectorAll('.nav-item').forEach(b=>{ b.classList.remove('active'); });
            const btn = document.querySelector(`button[onclick="switchTab('${t}')"]`);
            btn.classList.add('active');
        }

        // --- CHAT ---
        function toggleNoteMode(m) {
            document.getElementById('ai-chat-container').classList.toggle('hidden', m!=='chat');
            document.getElementById('notepad-container').classList.toggle('hidden', m!=='notes');
            const c=document.getElementById('tab-chat'); const n=document.getElementById('tab-notes');
            if(m==='chat') { c.className="flex-1 py-2.5 rounded-lg text-xs font-bold text-slate-900 bg-sky-400 transition-all shadow-lg flex items-center justify-center gap-2"; n.className="flex-1 py-2.5 rounded-lg text-xs font-bold text-slate-400 hover:text-white transition-all flex items-center justify-center gap-2"; }
            else { n.className="flex-1 py-2.5 rounded-lg text-xs font-bold text-slate-900 bg-sky-400 transition-all shadow-lg flex items-center justify-center gap-2"; c.className="flex-1 py-2.5 rounded-lg text-xs font-bold text-slate-400 hover:text-white transition-all flex items-center justify-center gap-2"; }
        }
        function saveNote() { localStorage.setItem('travelGptNotes', document.getElementById('user-notes').value); }
        function handleChatKey(e) { if(e.key==='Enter') sendChat(); }
        async function sendChat() {
            const i=document.getElementById('chat-input'); const t=i.value.trim(); if(!t) return;
            addMsg(t, 'user'); i.value=''; addMsg("Processing...", 'ai', 'thinking');
            try {
                let act=null; let p="You are TravelGPT. Be concise.";
                if(t.toLowerCase().includes('hotel')) act='hotel';
                const r=await safeJsonFetch(`https://text.pollinations.ai/${encodeURIComponent(p+t)}`);
                document.getElementById('thinking').remove();
                addMsg(await r.text(), 'ai');
                if(act) { switchTab('home'); document.getElementById('osm-query').value=act; queryOverpass(); }
            } catch(e){ document.getElementById('thinking').remove(); addMsg("System Offline.", 'ai'); }
        }
        function addMsg(t, s, id) {
            const h=document.getElementById('chat-history'); const d=document.createElement('div');
            if(id) d.id=id;
            d.className = s==='user' ? "p-4 text-sm font-medium chat-bubble-user max-w-[85%] mb-3 text-white ml-auto animate-enter" : "flex gap-4 max-w-[90%] chat-bubble-ai p-4 mb-3 animate-enter";
            if(s==='ai') d.innerHTML=`<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-sky-400 to-indigo-500 flex items-center justify-center shrink-0 shadow-lg border border-white/10"><i class="ph-fill ph-robot text-white"></i></div><p class="text-sm font-medium leading-relaxed text-slate-200">${t}</p>`;
            else d.innerText=t;
            h.appendChild(d); h.scrollTop=h.scrollHeight;
        }
    </script>
</body>
</html>
