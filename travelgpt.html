<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelGPT | Professional Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- FONTS: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- === OPEN SOURCE LIBRARIES === -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        /* === PROFESSIONAL THEME === */
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --surface: #ffffff;
            --bg-body: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow: hidden; 
            height: 100dvh; 
            width: 100vw;
        }

        .app-shell { display: flex; height: 100%; width: 100%; flex-direction: column; }
        @media (min-width: 768px) { .app-shell { flex-direction: row; } }

        .pro-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .pro-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .pro-input {
            background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s ease;
        }
        .pro-input:focus-within {
            background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        select { -webkit-appearance: none; background: transparent; }

        .nav-link {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); transition: all 0.2s; border-radius: 8px;
        }
        @media (min-width: 768px) {
            .nav-link { flex-direction: row; justify-content: flex-start; padding: 12px 16px; gap: 12px; width: 100%; }
        }
        .nav-link:hover { background-color: var(--primary-soft); color: var(--primary); }
        .nav-link.active { color: var(--primary); background-color: var(--primary-soft); font-weight: 600; }

        #ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .msg-user { background-color: var(--primary); color: white; border-radius: 12px 12px 2px 12px; }
        .msg-ai { background-color: white; border: 1px solid var(--border); border-radius: 12px 12px 12px 2px; }
        #auth-overlay { background-image: radial-gradient(circle at 50% 0%, #e0e7ff 0%, #f8fafc 100%); }
    </style>
</head>
<body>

    <!-- === AUTH OVERLAY === -->
    <div id="auth-overlay" class="absolute inset-0 z-[100] flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-2xl border border-slate-100 animate-fade-in">
            <div class="flex flex-col items-center mb-6">
                <div class="w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center text-white mb-3 shadow-lg shadow-indigo-200">
                    <i class="ph-bold ph-planet text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">TravelGPT</h1>
                <p class="text-sm text-slate-500">Professional Edition</p>
            </div>
            <form id="form-login" class="space-y-4" onsubmit="handleLogin(event)">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full p-3 rounded-lg border border-slate-200 focus:border-indigo-500 outline-none text-sm" placeholder="user@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="login-pass" required class="w-full p-3 rounded-lg border border-slate-200 focus:border-indigo-500 outline-none text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
                    <span>Log In</span> <i class="ph-bold ph-arrow-right"></i>
                </button>
            </form>
            <form id="form-signup" class="space-y-4 hidden" onsubmit="handleSignup(event)">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label><input type="text" id="signup-name" required class="w-full p-3 rounded-lg border border-slate-200 outline-none text-sm" placeholder="John Doe"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label><input type="email" id="signup-email" required class="w-full p-3 rounded-lg border border-slate-200 outline-none text-sm" placeholder="user@example.com"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label><input type="password" id="signup-pass" required class="w-full p-3 rounded-lg border border-slate-200 outline-none text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg flex justify-center items-center gap-2"><span>Create Account</span></button>
            </form>
            <div class="mt-6 text-center"><button id="toggle-auth" onclick="toggleAuthMode()" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition">Don't have an account? Sign Up</button></div>
            <p id="auth-error" class="text-red-500 text-xs text-center mt-3 h-4 font-bold"></p>
        </div>
    </div>

    <!-- === MAIN APP SHELL === -->
    <div id="app-container" class="app-shell bg-slate-50 hidden opacity-0 transition-opacity duration-500">
        <!-- Sidebar Navigation -->
        <nav class="bg-white border-r border-slate-200 z-50 flex md:flex-col justify-between items-center md:items-start px-2 py-2 md:p-4 h-16 md:h-full md:w-64 shrink-0 shadow-sm md:shadow-none order-2 md:order-1">
            <div class="hidden md:flex items-center gap-3 mb-8 px-2">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white"><i class="ph-bold ph-planet text-xl"></i></div>
                <h1 class="font-bold text-lg text-slate-900 tracking-tight">TravelGPT</h1>
            </div>
            <div class="flex md:flex-col justify-around w-full gap-1 md:gap-2">
                <button onclick="switchTab('home')" id="nav-home" class="nav-link active flex-1 md:flex-none"><i class="ph-fill ph-house text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Home</span></button>
                <button onclick="switchTab('map')" id="nav-map" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-map-trifold text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Explore</span></button>
                <button onclick="switchTab('ar')" id="nav-ar" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-camera text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Scanner</span></button>
                <button onclick="switchTab('translate')" id="nav-translate" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-translate text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Voice</span></button>
                <button onclick="switchTab('notebook')" id="nav-notebook" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-chat-circle-dots text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Assistant</span></button>
            </div>
            <!-- Profile Link -->
            <div onclick="switchTab('profile')" class="hidden md:flex mt-auto w-full pt-4 border-t border-slate-100 items-center gap-3 cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition">
                <img id="user-avatar-desktop" src="" class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200">
                <div class="flex flex-col text-left"><span id="user-name-desktop" class="text-xs font-bold text-slate-700">User</span><span class="text-[10px] text-emerald-600 font-medium">‚óè Online</span></div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 relative order-1 md:order-2 h-[calc(100%-64px)] md:h-full overflow-hidden">
            <!-- Mobile Header -->
            <header class="md:hidden absolute top-0 w-full z-40 px-4 py-3 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-slate-200">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white"><i class="ph-bold ph-planet"></i></div>
                    <h1 class="font-bold text-lg text-slate-900">TravelGPT</h1>
                </div>
                <div onclick="switchTab('profile')" class="w-8 h-8 rounded-full bg-slate-100 overflow-hidden border border-slate-200">
                    <img id="user-avatar-mobile" src="" alt="User" />
                </div>
            </header>

            <!-- 1. HOME -->
            <section id="view-home" class="view-section absolute inset-0 pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <div class="flex-1 pro-card bg-white p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wide">Select Location</h2>
                                <button onclick="detectLiveLocation()" class="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-2 py-1 rounded transition flex items-center gap-1"><i class="ph-bold ph-crosshair"></i> Auto-Detect</button>
                            </div>
                            <!-- 3-Level Selector (State -> District -> Dynamic Taluk) -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div class="pro-input relative h-10"><select id="state-select" onchange="populateDistricts()" class="w-full h-full bg-transparent text-xs font-semibold text-slate-700 px-3 cursor-pointer outline-none"><option value="">Select State</option></select><i class="ph-bold ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i></div>
                                <div class="pro-input relative h-10"><select id="district-select" onchange="fetchDynamicTaluks()" class="w-full h-full bg-transparent text-xs font-semibold text-slate-700 px-3 cursor-pointer outline-none disabled:opacity-50" disabled><option value="">Select District</option></select><i class="ph-bold ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i></div>
                                <div class="pro-input relative h-10"><select id="taluk-select" onchange="teleportToTaluk()" class="w-full h-full bg-transparent text-xs font-semibold text-slate-700 px-3 cursor-pointer outline-none disabled:opacity-50" disabled><option value="">Select Taluk</option></select><i id="taluk-loader" class="ph-bold ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i></div>
                            </div>
                            <div class="pro-input relative flex items-center"><i class="ph-bold ph-magnifying-glass text-slate-400 ml-3"></i><input type="text" id="teleport-query" placeholder="Or search specific village/town..." class="w-full bg-transparent text-sm text-slate-800 py-2.5 px-2 outline-none placeholder-slate-400"><button onclick="teleportToCity()" id="btn-teleport" class="mr-1 p-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition"><i class="ph-bold ph-paper-plane-right"></i></button></div>
                        </div>
                        <div class="w-full lg:w-72 pro-card bg-gradient-to-br from-indigo-600 to-violet-700 text-white p-5 flex flex-col justify-between relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-20"><i id="weather-icon" class="ph-duotone ph-cloud-sun text-6xl"></i></div>
                            <div class="z-10"><div class="inline-flex items-center gap-1 bg-white/20 backdrop-blur px-2 py-0.5 rounded-full text-[10px] font-bold mb-2 border border-white/10"><i class="ph-fill ph-map-pin"></i> <span id="weather-loc">India</span></div><h3 id="weather-temp" class="text-4xl font-bold">--¬∞</h3><p id="weather-desc" class="text-sm text-indigo-100 opacity-90">Live Weather</p></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-800 mb-3">Find Nearby</h3>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                            <button onclick="quickSearch('attractions')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-amber-600 bg-amber-50/50 border-amber-100"><i class="ph-duotone ph-star text-2xl"></i> <span class="text-xs font-bold">Top 20</span></button>
                            <button onclick="quickSearch('temple')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-purple-600 hover:bg-purple-50"><i class="ph-duotone ph-mosque text-2xl"></i> <span class="text-xs font-bold">Temples</span></button>
                            <button onclick="quickSearch('park')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-green-600 hover:bg-green-50"><i class="ph-duotone ph-tree text-2xl"></i> <span class="text-xs font-bold">Parks</span></button>
                            <button onclick="quickSearch('restaurant')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-orange-600 hover:bg-orange-50"><i class="ph-duotone ph-hamburger text-2xl"></i> <span class="text-xs font-bold">Food</span></button>
                            <button onclick="quickSearch('shopping')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-pink-600 hover:bg-pink-50"><i class="ph-duotone ph-shopping-bag text-2xl"></i> <span class="text-xs font-bold">Shop</span></button>
                            <button onclick="quickSearch('hotel')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-blue-600 hover:bg-blue-50"><i class="ph-duotone ph-bed text-2xl"></i> <span class="text-xs font-bold">Hotels</span></button>
                        </div>
                        <input type="hidden" id="osm-query">
                    </div>
                    <div class="pro-card bg-white min-h-[300px] p-4"><div id="results-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div class="col-span-full flex flex-col items-center justify-center py-12 text-slate-400"><i class="ph-duotone ph-magnifying-glass text-4xl mb-2"></i><p class="text-sm font-medium">Select a category to start scanning</p></div></div></div>
                </div>
            </section>

            <!-- 2. MAP -->
            <section id="view-map" class="view-section absolute inset-0 hidden"><div id="map" class="w-full h-full bg-slate-100 z-0"></div><button onclick="locateUser()" class="absolute bottom-6 right-6 z-[400] bg-white text-slate-800 p-3 rounded-xl shadow-lg border border-slate-200 hover:bg-slate-50 transition active:scale-95"><i class="ph-bold ph-crosshair text-2xl"></i></button></section>

            <!-- 3. AR -->
            <section id="view-ar" class="view-section absolute inset-0 hidden bg-black">
                <video id="ar-video" autoplay playsinline muted loop class="absolute inset-0 w-full h-full object-cover opacity-90"></video>
                <img id="ar-static-img" class="absolute inset-0 w-full h-full object-contain bg-black hidden z-10">
                <canvas id="ar-canvas" class="relative z-10"></canvas>
                <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                <div class="absolute top-0 left-0 w-full p-4 flex justify-between z-20 bg-gradient-to-b from-black/80 to-transparent">
                     <div class="bg-black/40 backdrop-blur-md rounded-lg p-1 flex gap-1 border border-white/10">
                        <button onclick="switchVision('object')" id="btn-vis-obj" class="px-3 py-1.5 rounded-md text-xs font-bold bg-white text-black transition">Object</button>
                        <button onclick="switchVision('ocr')" id="btn-vis-ocr" class="px-3 py-1.5 rounded-md text-xs font-bold text-white transition hover:bg-white/10">Text</button>
                    </div>
                    <button onclick="triggerUpload()" class="bg-indigo-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-lg hover:bg-indigo-500 transition"><i class="ph-bold ph-image text-lg"></i></button>
                </div>
                <div id="ocr-controls" class="hidden absolute bottom-0 left-0 w-full bg-slate-900/90 backdrop-blur-xl border-t border-white/10 p-4 z-30 rounded-t-2xl">
                    <div class="flex gap-4 mb-4">
                         <div class="flex-1"><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Reading</label><select id="ocr-source-lang" class="w-full bg-white/10 text-white text-xs font-bold p-2 rounded border border-white/20 focus:outline-none"><option value="eng">English</option><option value="hin">Hindi</option><option value="kan">Kannada</option><option value="tam">Tamil</option><option value="tel">Telugu</option><option value="mal">Malayalam</option></select></div>
                         <div class="flex-1"><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Translate To</label><select id="target-lang" onchange="updateArTranslation()" class="w-full bg-white/10 text-white text-xs font-bold p-2 rounded border border-white/20 focus:outline-none"><option value="en">English</option><option value="hi">Hindi</option><option value="kn">Kannada</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ml">Malayalam</option></select></div>
                    </div>
                    <div id="ocr-result" class="bg-black/50 rounded-lg p-3 border border-white/10 hidden"><p id="ocr-text" class="text-xs text-slate-400 font-mono mb-2 border-b border-white/10 pb-2">Scanning...</p><p class="text-[9px] text-indigo-400 font-bold uppercase">Result</p><p id="ocr-trans-text" class="text-sm text-white font-bold">...</p></div>
                </div>
                <div id="camera-error" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6 text-center"><i class="ph-duotone ph-camera-slash text-4xl text-slate-500 mb-3"></i><h3 class="text-white font-bold mb-1">Camera Off</h3><p class="text-slate-400 text-xs mb-4">Permission denied or unavailable.</p><button onclick="startDemoMode()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Launch Demo</button></div>
            </section>

            <!-- 4. TRANSLATE -->
            <section id="view-translate" class="view-section absolute inset-0 hidden pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-3xl mx-auto p-4 md:p-8 h-full flex flex-col">
                    <h2 class="text-xl font-bold text-slate-900 mb-4 hidden md:block">Voice Translator</h2>
                    <div class="pro-card bg-white p-2 mb-4 flex items-center justify-between">
                        <select id="trans-source" class="bg-transparent text-indigo-600 font-bold text-sm p-2 outline-none cursor-pointer"><option value="en">English</option><option value="hi">Hindi</option><option value="kn">Kannada</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ml">Malayalam</option></select>
                        <button onclick="swapLanguages()" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-400"><i class="ph-bold ph-arrows-left-right"></i></button>
                        <select id="trans-target" class="bg-transparent text-slate-900 font-bold text-sm p-2 outline-none cursor-pointer text-right" dir="rtl"><option value="hi">Hindi</option><option value="en">English</option><option value="kn">Kannada</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ml">Malayalam</option></select>
                    </div>
                    <div class="pro-card bg-white flex-1 p-6 flex flex-col relative mb-4">
                        <textarea id="trans-input" class="w-full h-1/2 bg-transparent text-2xl text-slate-800 placeholder-slate-300 border-none focus:outline-none resize-none font-medium" placeholder="Type or Speak..."></textarea>
                        <div class="h-px bg-slate-100 w-full my-6"></div>
                        <div class="flex-1 relative">
                             <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-indigo-500 uppercase">Translation</span><button onclick="speakTranslation()" class="text-slate-400 hover:text-indigo-600"><i class="ph-fill ph-speaker-high text-xl"></i></button></div>
                            <p id="trans-output" class="text-xl text-slate-700 font-medium">...</p>
                            <div id="trans-loading" class="absolute inset-0 flex items-center justify-center bg-white/90 hidden"><i class="ph-bold ph-spinner animate-spin text-3xl text-indigo-600"></i></div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="translateTextManual()" class="flex-1 bg-indigo-600 text-white h-14 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition active:scale-95 flex items-center justify-center gap-2">TRANSLATE</button>
                        <button id="btn-trans-mic" onmousedown="toggleVoiceInput()" ontouchstart="toggleVoiceInput()" class="w-14 h-14 bg-white text-slate-900 border border-slate-200 rounded-xl shadow-sm hover:bg-slate-50 transition active:scale-95 flex items-center justify-center relative overflow-hidden"><div id="mic-pulse" class="absolute inset-0 bg-red-500/10 hidden animate-pulse"></div><i class="ph-fill ph-microphone text-xl text-indigo-600"></i></button>
                    </div>
                </div>
            </section>

            <!-- 5. AI ASSISTANT -->
            <section id="view-notebook" class="view-section absolute inset-0 hidden pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-3xl mx-auto p-4 md:p-8 h-full flex flex-col">
                    <div class="flex bg-white p-1 rounded-lg border border-slate-200 mb-4 shrink-0">
                        <button onclick="toggleNoteMode('chat')" id="tab-chat" class="flex-1 py-2 rounded text-xs font-bold text-white bg-indigo-600 shadow-sm transition">AI Chat</button>
                        <button onclick="toggleNoteMode('notes')" id="tab-notes" class="flex-1 py-2 rounded text-xs font-bold text-slate-500 hover:bg-slate-50 transition">My Notes</button>
                    </div>
                    <div id="ai-chat-container" class="flex-1 flex flex-col bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
                        <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4"><div class="flex gap-3 max-w-[90%] chat-ai p-4 animate-fade-in"><div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center shrink-0 border border-indigo-100"><i class="ph-fill ph-robot text-indigo-600"></i></div><p class="text-sm text-slate-700 leading-relaxed">Hello! I'm TravelGPT. üåç<br>Ask me "Hotels in Mumbai" or "Places to visit in Kerala".</p></div></div>
                        <div class="p-3 bg-slate-50 border-t border-slate-100 flex gap-2"><input type="text" id="chat-input" placeholder="Ask anything..." class="flex-1 bg-white border border-slate-200 rounded-xl px-4 text-sm focus:outline-none focus:border-indigo-500 transition" onkeypress="handleChatKey(event)"><button onclick="sendChat()" class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-indigo-700 transition"><i class="ph-bold ph-paper-plane-right"></i></button></div>
                    </div>
                    <div id="notepad-container" class="hidden flex-1 flex flex-col bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm relative"><textarea id="user-notes" class="w-full h-full p-6 text-sm text-slate-800 placeholder-slate-400 focus:outline-none leading-loose resize-none" placeholder="Type your travel notes here..." oninput="saveNote()"></textarea><div class="absolute bottom-4 right-4 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100">Autosaved</div></div>
                </div>
            </section>

            <!-- 6. NEW: PROFILE VIEW (Robust Implementation) -->
            <section id="view-profile" class="view-section absolute inset-0 hidden pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-xl mx-auto p-6 md:p-12">
                    <div class="pro-card bg-white p-8 text-center mb-6">
                        <img id="profile-avatar" src="" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-indigo-50 shadow-md">
                        <h2 id="profile-name" class="text-2xl font-bold text-slate-900">Guest User</h2>
                        <p id="profile-email" class="text-sm text-slate-500 mb-6 font-medium">--</p>
                        <div class="grid grid-cols-2 gap-4 border-t border-slate-100 pt-6">
                            <div class="bg-slate-50 p-3 rounded-xl"><p id="stat-trips" class="text-xl font-bold text-indigo-600">0</p><p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Searches</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl"><p class="text-xl font-bold text-indigo-600">Pro</p><p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Plan</p></div>
                        </div>
                    </div>
                    <button onclick="logout()" class="w-full bg-white text-red-600 font-bold py-4 rounded-xl hover:bg-red-50 transition border border-red-100 shadow-sm">Sign Out</button>
                </div>
            </section>

        </main>
    </div>

    <!-- === JAVASCRIPT LOGIC === -->
    <script>
        let currentUser = null;
        let currentLat = 28.6139; let currentLng = 77.2090;
        let map = null; let mapMarkers = []; let objectModel = null;
        let isCameraOn = false; let visionMode = 'object'; let processingOCR = false;
        let lastOcrText = ""; let recognition = null; let isListening = false;
        let searchCount = 0;

        // --- COMPREHENSIVE DATA (All 28 States + 8 UTs) ---
        const indiaStates = {
            "Andaman & Nicobar": ["Nicobar", "North and Middle Andaman", "South Andaman"],
            "Andhra Pradesh": ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikakulam", "Visakhapatnam", "Vizianagaram", "West Godavari", "YSR Kadapa"],
            "Arunachal Pradesh": ["Tawang", "West Kameng", "East Kameng", "Papum Pare", "Kurung Kumey", "Kra Daadi", "Lower Subansiri", "Upper Subansiri", "West Siang", "East Siang", "Siang", "Upper Siang", "Lower Siang", "Lower Dibang Valley", "Dibang Valley", "Anjaw", "Lohit", "Namsai", "Changlang", "Tirap", "Longding"],
            "Assam": ["Baksa", "Barpeta", "Biswanath", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Hojai", "Jorhat", "Kamrup", "Kamrup Metropolitan", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Majuli", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "South Salmara-Mankachar", "Tinsukia", "Udalguri", "West Karbi Anglong"],
            "Bihar": ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"],
            "Chandigarh": ["Chandigarh"],
            "Chhattisgarh": ["Balod", "Baloda Bazar", "Balrampur", "Bastar", "Bemetara", "Bijapur", "Bilaspur", "Dantewada", "Dhamtari", "Durg", "Gariaband", "Janjgir-Champa", "Jashpur", "Kabirdham", "Kanker", "Kondagaon", "Korba", "Koriya", "Mahasamund", "Mungeli", "Narayanpur", "Raigarh", "Raipur", "Rajnandgaon", "Sukma", "Surajpur", "Surguja"],
            "Dadra & Nagar Haveli and Daman & Diu": ["Dadra and Nagar Haveli", "Daman", "Diu"],
            "Delhi": ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"],
            "Goa": ["North Goa", "South Goa"],
            "Gujarat": ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad", "Chhota Udaipur", "Dahod", "Dang", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kheda", "Kutch", "Mahisagar", "Mehsana", "Morbi", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar", "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Vadodara", "Valsad"],
            "Haryana": ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Nuh", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"],
            "Himachal Pradesh": ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"],
            "Jammu & Kashmir": ["Anantnag", "Bandipora", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"],
            "Jharkhand": ["Bokaro", "Chatra", "Deoghar", "Dhanbad", "Dumka", "East Singhbhum", "Garhwa", "Giridih", "Godda", "Gumla", "Hazaribagh", "Jamtara", "Khunti", "Koderma", "Latehar", "Lohardaga", "Pakur", "Palamu", "Ramgarh", "Ranchi", "Sahibganj", "Seraikela Kharsawan", "Simdega", "West Singhbhum"],
            "Karnataka": ["Bagalkot", "Ballari", "Belagavi", "Bengaluru Rural", "Bengaluru Urban", "Bidar", "Chamarajanagar", "Chikkaballapur", "Chikkamagaluru", "Chitradurga", "Dakshina Kannada", "Davanagere", "Dharwad", "Gadag", "Hassan", "Haveri", "Kalaburagi", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysuru", "Raichur", "Ramanagara", "Shivamogga", "Tumakuru", "Udupi", "Uttara Kannada", "Vijayapura", "Yadgir"],
            "Kerala": ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappuram", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"],
            "Ladakh": ["Kargil", "Leh"],
            "Lakshadweep": ["Lakshadweep"],
            "Madhya Pradesh": ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha"],
            "Maharashtra": ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"],
            "Manipur": ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"],
            "Meghalaya": ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills"],
            "Mizoram": ["Aizawl", "Champhai", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Serchhip"],
            "Nagaland": ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"],
            "Odisha": ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghpur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar", "Khordha", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Subarnapur", "Sundargarh"],
            "Puducherry": ["Karaikal", "Mahe", "Puducherry", "Yanam"],
            "Punjab": ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Muktsar", "Nawanshahr", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar", "Sangrur", "Tarn Taran"],
            "Rajasthan": ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Bharatpur", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur"],
            "Sikkim": ["East Sikkim", "North Sikkim", "South Sikkim", "West Sikkim"],
            "Tamil Nadu": ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Mayiladuthurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"],
            "Telangana": ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal", "Nagarkurnool", "Nalgonda", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Rangareddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal Rural", "Warangal Urban", "Yadadri Bhuvanagiri"],
            "Tripura": ["Dhalai", "Gomati", "Khowai", "North Tripura", "Sepahijala", "South Tripura", "Unakoti", "West Tripura"],
            "Uttar Pradesh": ["Agra", "Aligarh", "Ambedkar Nagar", "Amethi", "Amroha", "Auraiya", "Ayodhya", "Azamgarh", "Baghpat", "Bahraich", "Ballia", "Balrampur", "Banda", "Barabanki", "Bareilly", "Basti", "Bhadohi", "Bijnor", "Budaun", "Bulandshahr", "Chandauli", "Chitrakoot", "Deoria", "Etah", "Etawah", "Farrukhabad", "Fatehpur", "Firozabad", "Gautam Buddha Nagar", "Ghaziabad", "Ghazipur", "Gonda", "Gorakhpur", "Hamirpur", "Hapur", "Hardoi", "Hathras", "Jalaun", "Jaunpur", "Jhansi", "Kannauj", "Kanpur Dehat", "Kanpur Nagar", "Kasganj", "Kaushambi", "Kheri", "Kushinagar", "Lalitpur", "Lucknow", "Maharajganj", "Mahoba", "Mainpuri", "Mathura", "Mau", "Meerut", "Mirzapur", "Moradabad", "Muzaffarnagar", "Pilibhit", "Pratapgarh", "Prayagraj", "Raebareli", "Rampur", "Saharanpur", "Sambhal", "Sant Kabir Nagar", "Shahjahanpur", "Shamli", "Shravasti", "Siddharthnagar", "Sitapur", "Sonbhadra", "Sultanpur", "Unnao", "Varanasi"],
            "Uttarakhand": ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragarh", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"],
            "West Bengal": ["Alipurduar", "Bankura", "Birbhum", "Cooch Behar", "Dakshin Dinajpur", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Jhargram", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Bardhaman", "Paschim Medinipur", "Purba Bardhaman", "Purba Medinipur", "Purulia", "South 24 Parganas", "Uttar Dinajpur"]
        };

        /* === AUTH & PROFILE === */
        function initAuth() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showApp();
            } else {
                showAuth();
            }
        }
        function showAuth() {
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
        function showApp() {
            document.getElementById('auth-overlay').classList.add('hidden');
            const app = document.getElementById('app-container');
            app.classList.remove('hidden');
            setTimeout(() => app.classList.add('opacity-100'), 50);
            
            // PROFILE UPDATE
            const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.name}`;
            document.getElementById('user-avatar-desktop').src = avatarUrl;
            document.getElementById('user-avatar-mobile').src = avatarUrl;
            document.getElementById('user-name-desktop').innerText = currentUser.name.split(' ')[0];
            document.getElementById('profile-avatar').src = avatarUrl;
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-email').innerText = currentUser.email;
            document.getElementById('stat-trips').innerText = localStorage.getItem(`searches_${currentUser.email}`) || 0;

            loadUserData();
            populateStates();
            if(!map) setTimeout(initMap, 200);
        }
        function toggleAuthMode() {
            const l = document.getElementById('form-login'); const s = document.getElementById('form-signup');
            const b = document.getElementById('toggle-auth');
            if (l.classList.contains('hidden')) { l.classList.remove('hidden'); s.classList.add('hidden'); b.innerText = "Don't have an account? Sign Up"; } 
            else { l.classList.add('hidden'); s.classList.remove('hidden'); b.innerText = "Already have an account? Log In"; }
        }
        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            if(pass.length < 4) { document.getElementById('auth-error').innerText = "Password too short"; return; }
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[email]) { document.getElementById('auth-error').innerText = "User already exists"; return; }
            const newUser = { name, email, pass };
            users[email] = newUser;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            currentUser = newUser;
            showApp();
        }
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[email];
            if (user && user.pass === pass) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                currentUser = user;
                showApp();
            } else { document.getElementById('auth-error').innerText = "Invalid credentials"; }
        }
        function logout() { localStorage.removeItem('currentUser'); location.reload(); }
        function loadUserData() {
            const key = `notes_${currentUser.email}`;
            document.getElementById('user-notes').value = localStorage.getItem(key) || "";
            const lat = localStorage.getItem(`lat_${currentUser.email}`);
            if(lat) { currentLat=parseFloat(lat); currentLng=parseFloat(localStorage.getItem(`lng_${currentUser.email}`)); fetchCityName(); fetchWeather(); }
        }
        function saveNote() { if(!currentUser) return; localStorage.setItem(`notes_${currentUser.email}`, document.getElementById('user-notes').value); }
        function incrementStats() {
            if(!currentUser) return;
            let count = parseInt(localStorage.getItem(`searches_${currentUser.email}`) || 0) + 1;
            localStorage.setItem(`searches_${currentUser.email}`, count);
            document.getElementById('stat-trips').innerText = count;
        }

        /* === LOCATION LOGIC (Dynamic Taluks) === */
        function populateStates() {
            const sel = document.getElementById('state-select');
            if(sel.options.length > 1) return;
            Object.keys(indiaStates).sort().forEach(s => { let o = document.createElement('option'); o.value=s; o.text=s; sel.appendChild(o); });
        }
        function populateDistricts() {
            const s = document.getElementById('state-select').value;
            const dSel = document.getElementById('district-select');
            const tSel = document.getElementById('taluk-select');
            dSel.innerHTML = '<option value="">Select District</option>'; tSel.innerHTML = '<option value="">Select Taluk</option>'; tSel.disabled=true;
            if(s) { 
                dSel.disabled=false; 
                indiaStates[s].sort().forEach(d=>{let o=document.createElement('option');o.value=d;o.text=d;dSel.appendChild(o);}); 
            } else dSel.disabled=true;
        }
        async function fetchDynamicTaluks() {
            const s = document.getElementById('state-select').value;
            const d = document.getElementById('district-select').value;
            const tSel = document.getElementById('taluk-select');
            const loader = document.getElementById('taluk-loader');
            
            if(!d) { tSel.disabled=true; return; }
            
            tSel.innerHTML = '<option value="">Loading Towns...</option>';
            tSel.disabled = true;
            loader.classList.add('animate-spin', 'ph-spinner');
            loader.classList.remove('ph-caret-down');

            // Nominatim query for towns/suburbs in the district
            // Using a clever search for administrative boundaries level 8-10
            try {
                const query = `[out:json][timeout:15];
                    area["name"="${d}"]["admin_level"="5"]->.searchArea;
                    (
                      relation["admin_level"~"6|7|8"](area.searchArea);
                    );
                    out tags;`;
                // Note: Overpass is complex for hierarchical. Falling back to Nominatim "Address Lookup" for simplicity or just general search.
                // Alternative: Just search for "Towns in District"
                // Using simple Nominatim structured query which is faster
                
                const url = `https://nominatim.openstreetmap.org/search?format=json&city=${d}&state=${s}&country=India&featuretype=settlement&limit=50`;
                const data = await safeJsonFetch(url);
                
                tSel.innerHTML = '<option value="">Select Town/Taluk</option>';
                
                // Add unique towns
                const towns = [...new Set(data.map(item => item.name.split(',')[0]))].sort();
                
                if(towns.length === 0) {
                     // Fallback if strict city search fails, search broader
                     const url2 = `https://nominatim.openstreetmap.org/search?format=json&q=${d}+${s}&limit=1`;
                     const data2 = await safeJsonFetch(url2);
                     // If we found the district itself, just enable it
                     tSel.innerHTML = '<option value="">Main District Area</option>';
                } else {
                    towns.forEach(t => {
                        let o = document.createElement('option');
                        o.value = t;
                        o.text = t;
                        tSel.appendChild(o);
                    });
                }
                
                tSel.disabled = false;
            } catch(e) {
                console.warn(e);
                tSel.innerHTML = '<option value="">Enter Manually Below</option>';
            } finally {
                loader.classList.remove('animate-spin', 'ph-spinner');
                loader.classList.add('ph-caret-down');
            }
        }

        /* === CORE APP LOGIC === */
        async function safeJsonFetch(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(res.status);
                const txt = await res.text();
                return JSON.parse(txt);
            } catch (e) { console.warn(e); throw e; }
        }

        async function teleportToTaluk() {
            const s = document.getElementById('state-select').value;
            const d = document.getElementById('district-select').value;
            const t = document.getElementById('taluk-select').value;
            if(!t) return;
            
            const btn = document.getElementById('btn-teleport');
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';
            document.getElementById('results-area').innerHTML = `<div class="col-span-full text-center py-10 opacity-50 text-xs animate-pulse font-bold text-indigo-600">Scanning ${t}...</div>`;

            const query = `${t}, ${d}, ${s}, India`;
            try {
                const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                if(data.length) {
                    updateLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), t);
                    document.getElementById('osm-query').value = 'attractions';
                    queryOverpass();
                    incrementStats();
                }
            } catch(e){}
            btn.innerHTML = '<i class="ph-bold ph-paper-plane-right"></i>';
        }

        async function detectLiveLocation() {
            if(!navigator.geolocation) return alert("No GPS");
            document.getElementById('weather-loc').innerText = "Triangulating...";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                updateLocation(pos.coords.latitude, pos.coords.longitude, "You");
                incrementStats();
                try {
                    const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}`);
                    const city = data.address.city || data.address.town || "Unknown";
                    document.getElementById('weather-loc').innerText = city;
                    document.getElementById('osm-query').value = 'attractions';
                    queryOverpass();
                } catch(e) { console.error(e); }
            });
        }

        function updateLocation(lat, lng, label) {
            currentLat = lat; currentLng = lng;
            if(currentUser) {
                localStorage.setItem(`lat_${currentUser.email}`, lat);
                localStorage.setItem(`lng_${currentUser.email}`, lng);
            }
            fetchWeather();
            if(map) { map.setView([lat, lng], 14); L.marker([lat, lng]).addTo(map).bindPopup(label).openPopup(); }
        }

        async function teleportToCity() {
            const q = document.getElementById('teleport-query').value;
            if(!q) return;
            try {
                const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                if(data.length) {
                    updateLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), q);
                    fetchCityName();
                    document.getElementById('osm-query').value = 'attractions';
                    queryOverpass();
                    incrementStats();
                }
            } catch(e){}
        }

        async function fetchWeather() {
            try {
                const data = await safeJsonFetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLng}&current_weather=true`);
                document.getElementById('weather-temp').innerText = `${Math.round(data.current_weather.temperature)}¬∞`;
                document.getElementById('weather-desc').innerText = `Wind: ${data.current_weather.windspeed} km/h`;
            } catch(e){}
        }
        async function fetchCityName() {
            try {
                const data = await safeJsonFetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}`);
                document.getElementById('weather-loc').innerText = data.address.city || "Unknown Location";
            } catch(e){}
        }

        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl: false}).setView([currentLat, currentLng], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map);
            L.marker([currentLat, currentLng]).addTo(map).bindPopup("Start").openPopup();
        }
        function locateUser() { map.setView([currentLat, currentLng], 16); }

        function quickSearch(type) {
            document.getElementById('osm-query').value = type;
            queryOverpass();
        }

        async function queryOverpass() {
            let q = document.getElementById('osm-query').value;
            const resArea = document.getElementById('results-area');
            resArea.innerHTML = '<div class="col-span-full text-center py-10 opacity-50 text-xs animate-pulse font-bold text-indigo-600">Scouting Sector...</div>';
            
            let ql = '';
            const r = 5000;
            if(q==='attractions') ql = `[out:json][timeout:25];(node["tourism"~"attraction|viewpoint"](around:${r},${currentLat},${currentLng});node["historic"](around:${r},${currentLat},${currentLng}););out 25;`;
            else if(q==='temple') ql = `[out:json][timeout:25];node["amenity"="place_of_worship"](around:${r},${currentLat},${currentLng});out 25;`;
            else if(q==='park') ql = `[out:json][timeout:25];node["leisure"="park"](around:${r},${currentLat},${currentLng});out 25;`;
            else ql = `[out:json][timeout:25];node["amenity"~"${q.includes('hotel')?'hotel':q}"](around:${r},${currentLat},${currentLng});out 25;`;

            const eps = ['https://overpass-api.de/api/interpreter', 'https://lz4.overpass-api.de/api/interpreter'];
            let data=null;
            for(let ep of eps) { try{ data=await safeJsonFetch(`${ep}?data=${encodeURIComponent(ql)}`); if(data) break; }catch(e){} }

            resArea.innerHTML=''; mapMarkers.forEach(m=>map.removeLayer(m)); mapMarkers=[];
            if(!data || !data.elements.length) resArea.innerHTML = '<div class="col-span-full text-center py-10 opacity-40 text-xs font-bold text-slate-400">Sector Empty</div>';
            else {
                data.elements.slice(0,25).forEach((p, i) => {
                    const name = p.tags.name; if(!name) return;
                    const url = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}`;
                    let icon = 'ph-map-pin';
                    if(p.tags.tourism) icon='ph-camera'; else if(p.tags.amenity==='place_of_worship') icon='ph-mosque';
                    
                    const card = document.createElement('div');
                    card.className = "pro-card p-4 flex justify-between items-center animate-fade-in hover:border-indigo-500/50";
                    card.style.animationDelay = `${i*0.05}s`;
                    card.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0"><i class="ph-fill ${icon} text-lg"></i></div>
                            <div class="truncate">
                                <h4 class="text-sm font-bold text-slate-800 truncate">${name}</h4>
                                <p class="text-[10px] text-slate-500 font-medium truncate uppercase tracking-wide">${p.tags.amenity||p.tags.tourism||"Location"}</p>
                            </div>
                        </div>
                        <a href="${url}" target="_blank" class="w-9 h-9 rounded-lg bg-indigo-600 flex items-center justify-center text-white hover:bg-indigo-700 transition shadow-sm active:scale-95"><i class="ph-bold ph-navigation-arrow"></i></a>
                    `;
                    resArea.appendChild(card);
                    const m=L.marker([p.lat, p.lon]).addTo(map).bindPopup(name);
                    mapMarkers.push(m);
                });
            }
        }

        // --- TRANSLATOR ---
        function swapLanguages() {
            const s=document.getElementById('trans-source'); const t=document.getElementById('trans-target');
            const tmp=s.value; s.value=t.value; t.value=tmp;
        }
        async function translateTextManual() {
            const i=document.getElementById('trans-input').value;
            const o=document.getElementById('trans-output');
            const l=document.getElementById('trans-loading');
            if(!i) return;
            l.classList.remove('hidden');
            try {
                const s=document.getElementById('trans-source').value; const t=document.getElementById('trans-target').value;
                const data=await safeJsonFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(i)}&langpair=${s}|${t}`);
                o.innerText = data.responseData.translatedText || i;
            } catch(e) { o.innerText="Error"; } finally { l.classList.add('hidden'); }
        }
        function speakTranslation() {
            const t=document.getElementById('trans-output').innerText;
            if(!t || t==="...") return;
            const u=new SpeechSynthesisUtterance(t);
            u.lang=document.getElementById('trans-target').value;
            window.speechSynthesis.speak(u);
        }
        function initSpeech() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(SR) {
                recognition = new SR(); recognition.continuous=false; recognition.interimResults=true;
                recognition.onstart = () => { document.getElementById('mic-pulse').classList.remove('hidden'); document.getElementById('mic-status').innerText="LISTENING..."; };
                recognition.onend = () => { document.getElementById('mic-pulse').classList.add('hidden'); document.getElementById('mic-status').innerText=""; if(document.getElementById('trans-input').value) translateTextManual(); isListening=false; };
                recognition.onresult = (e) => document.getElementById('trans-input').value = Array.from(e.results).map(r=>r[0].transcript).join('');
            }
        }
        function toggleVoiceInput() {
            if(!recognition) return alert("Not Supported");
            if(isListening) recognition.stop();
            else {
                const langMap = {'en':'en-US','hi':'hi-IN','kn':'kn-IN','ta':'ta-IN','te':'te-IN','ml':'ml-IN'};
                recognition.lang = langMap[document.getElementById('trans-source').value];
                recognition.start();
            }
        }

        // --- AR/OCR ---
        async function startCamera() {
            const v=document.getElementById('ar-video'); const s=document.getElementById('ar-static-img');
            s.classList.add('hidden'); v.classList.remove('hidden'); isCameraOn=true;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                v.srcObject=stream; v.play();
                document.getElementById('camera-error').classList.add('hidden');
                requestAnimationFrame(processVideoFrame);
            } catch(e) { document.getElementById('camera-error').classList.remove('hidden'); }
        }
        function startDemoMode() {
            const v=document.getElementById('ar-video');
            v.srcObject=null; v.src="https://videos.pexels.com/video-files/3195652/3195652-sd_640_360_25fps.mp4"; v.play();
            isCameraOn=true; document.getElementById('camera-error').classList.add('hidden');
            requestAnimationFrame(processVideoFrame);
        }
        function stopCamera() {
            const v=document.getElementById('ar-video');
            if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
            v.pause(); isCameraOn=false;
        }
        function switchVision(m) {
            visionMode=m;
            const ocr = document.getElementById('ocr-controls'); const lang = document.getElementById('ocr-lang-panel'); const res = document.getElementById('ocr-result');
            const objBtn = document.getElementById('btn-vis-obj'); const ocrBtn = document.getElementById('btn-vis-ocr');
            
            if(m==='object') {
                ocr.classList.add('hidden'); lang.classList.add('hidden'); res.classList.add('hidden');
                objBtn.classList.replace('bg-white', 'bg-indigo-600'); objBtn.classList.replace('text-black', 'text-white');
                ocrBtn.classList.replace('bg-indigo-600', 'bg-white'); ocrBtn.classList.replace('text-white', 'text-black');
            } else {
                ocr.classList.remove('hidden'); lang.classList.remove('hidden'); res.classList.remove('hidden');
                ocrBtn.classList.replace('bg-white', 'bg-indigo-600'); ocrBtn.classList.replace('text-black', 'text-white');
                objBtn.classList.replace('bg-indigo-600', 'bg-white'); objBtn.classList.replace('text-white', 'text-black');
            }
        }
        function closeOcr() { document.getElementById('ocr-result').classList.add('hidden'); }
        function triggerUpload() { document.getElementById('img-upload').click(); }
        function handleFileUpload(inp) {
            if(inp.files[0]) {
                const r = new FileReader();
                r.onload = function(e) {
                    const v=document.getElementById('ar-video'); const s=document.getElementById('ar-static-img');
                    isCameraOn=false; v.pause(); v.classList.add('hidden'); s.src=e.target.result; s.classList.remove('hidden');
                    setTimeout(()=>runOCR(s), 500);
                }
                r.readAsDataURL(inp.files[0]);
            }
        }
        async function processVideoFrame() {
            if(!isCameraOn) return;
            const v=document.getElementById('ar-video'); const c=document.getElementById('ar-canvas'); const ctx=c.getContext('2d');
            if(v.readyState>=2) {
                c.width=v.videoWidth; c.height=v.videoHeight; ctx.clearRect(0,0,c.width,c.height);
                if(visionMode==='object' && objectModel) {
                    try {
                        const ps = await objectModel.detect(v);
                        ps.forEach(p=>{
                            ctx.strokeStyle='#4f46e5'; ctx.lineWidth=4; ctx.strokeRect(p.bbox[0],p.bbox[1],p.bbox[2],p.bbox[3]);
                            ctx.font='18px Inter'; ctx.fillStyle='#4f46e5'; ctx.fillText(p.class, p.bbox[0], p.bbox[1]>20?p.bbox[1]-10:20);
                        });
                    } catch(e){}
                } else if(visionMode==='ocr' && !processingOCR && Date.now()%3000<100) runOCR(v);
            }
            requestAnimationFrame(processVideoFrame);
        }
        async function updateArTranslation() {
            if(!lastOcrText) return;
            const resEl = document.getElementById('ocr-trans-text');
            resEl.innerText = "Translating...";
            const s3 = document.getElementById('ocr-source-lang').value;
            const t = document.getElementById('target-lang').value;
            const map3to2 = {'eng':'en','hin':'hi','kan':'kn','tam':'ta','tel':'te','mal':'ml'};
            try {
                const data = await safeJsonFetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(lastOcrText)}&langpair=${map3to2[s3]}|${t}`);
                resEl.innerText = data.responseData.translatedText || lastOcrText;
            } catch(e) { resEl.innerText = "Error"; }
        }
        async function runOCR(src) {
            if(processingOCR) return; processingOCR=true;
            const txtEl = document.getElementById('ocr-text'); const transEl = document.getElementById('ocr-trans-text');
            txtEl.innerText="Scanning...";
            const cvs = document.createElement('canvas');
            if(src.tagName==='VIDEO') { cvs.width=src.videoWidth; cvs.height=src.videoHeight; } else { cvs.width=src.naturalWidth; cvs.height=src.naturalHeight; }
            cvs.getContext('2d').drawImage(src,0,0);
            
            try {
                const res = await Tesseract.recognize(cvs, document.getElementById('ocr-source-lang').value, {
                    workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
                    corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js'
                });
                const txt = res.data.text.replace(/\n/g,' ').trim();
                if(txt.length>2) { lastOcrText=txt; txtEl.innerText=txt; await updateArTranslation(); }
                else { txtEl.innerText="No Text"; transEl.innerText="..."; }
            } catch(e){ txtEl.innerText="Scan Error"; } finally { processingOCR=false; cvs.remove(); }
        }

        // --- CHAT ---
        function toggleNoteMode(m) {
            document.getElementById('ai-chat-container').classList.toggle('hidden', m!=='chat');
            document.getElementById('notepad-container').classList.toggle('hidden', m!=='notes');
            const c=document.getElementById('tab-chat'); const n=document.getElementById('tab-notes');
            if(m==='chat') { c.className="flex-1 py-2 rounded text-xs font-bold text-white bg-indigo-600 shadow-sm transition"; n.className="flex-1 py-2 rounded text-xs font-bold text-slate-500 hover:bg-slate-50 transition"; }
            else { n.className="flex-1 py-2 rounded text-xs font-bold text-white bg-indigo-600 shadow-sm transition"; c.className="flex-1 py-2 rounded text-xs font-bold text-slate-500 hover:bg-slate-50 transition"; }
        }
        function handleChatKey(e) { if(e.key==='Enter') sendChat(); }
        async function sendChat() {
            const i=document.getElementById('chat-input'); const t=i.value.trim(); if(!t) return;
            addMsg(t, 'user'); i.value=''; addMsg("Processing...", 'ai', 'thinking');
            try {
                let act=null; let p="You are TravelGPT. Be concise.";
                if(t.toLowerCase().includes('hotel')) act='hotel';
                const r=await safeJsonFetch(`https://text.pollinations.ai/${encodeURIComponent(p+t)}`);
                document.getElementById('thinking').remove();
                addMsg(await r.text(), 'ai');
                if(act) { switchTab('home'); document.getElementById('osm-query').value=act; queryOverpass(); }
            } catch(e){ document.getElementById('thinking').remove(); addMsg("System Offline.", 'ai'); }
        }
        function addMsg(t, s, id) {
            const h=document.getElementById('chat-history'); const d=document.createElement('div');
            if(id) d.id=id;
            d.className = s==='user' ? "p-4 text-sm font-medium msg-user max-w-[85%] mb-3 ml-auto animate-fade-in" : "flex gap-4 max-w-[90%] msg-ai p-4 mb-3 animate-fade-in";
            if(s==='ai') d.innerHTML=`<div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center shrink-0 border border-indigo-100"><i class="ph-fill ph-robot text-indigo-600"></i></div><p class="text-sm font-medium leading-relaxed text-slate-700">${t}</p>`;
            else d.innerText=t;
            h.appendChild(d); h.scrollTop=h.scrollHeight;
        }

        // --- APP SHELL ---
        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(el=>{el.classList.add('hidden'); el.classList.remove('opacity-100'); el.classList.add('opacity-0');});
            const v = document.getElementById(`view-${t}`);
            v.classList.remove('hidden'); 
            setTimeout(()=>v.classList.remove('opacity-0'), 50);
            
            if(t==='ar') startCamera(); else stopCamera();
            if(t==='map' && map) setTimeout(()=>map.invalidateSize(), 200);

            document.querySelectorAll('.nav-link').forEach(b=>{ b.classList.remove('active'); });
            const btn = document.getElementById(`nav-${t}`);
            if(btn) btn.classList.add('active');
        }

        // Run Init
        window.onload = initAuth;
    </script>
</body>
</html>
