<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Travel Guide | Professional Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- FONTS: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- === OPEN SOURCE LIBRARIES === -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- TensorFlow & COCO-SSD -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <!-- Tesseract OCR (v5) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

    <style>
        /* === PROFESSIONAL THEME === */
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --surface: #ffffff;
            --bg-body: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow: hidden; 
            height: 100dvh; 
            width: 100vw;
        }

        .app-shell { display: flex; height: 100%; width: 100%; flex-direction: column; }
        @media (min-width: 768px) { .app-shell { flex-direction: row; } }

        .pro-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .pro-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .pro-input {
            background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s ease;
        }
        .pro-input:focus-within {
            background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }

        .scan-line { width: 100%; height: 2px; background: var(--primary); box-shadow: 0 0 8px var(--primary); animation: scan 2s linear infinite; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        select { -webkit-appearance: none; background: transparent; }

        .nav-link {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); transition: all 0.2s; border-radius: 8px;
        }
        @media (min-width: 768px) {
            .nav-link { flex-direction: row; justify-content: flex-start; padding: 12px 16px; gap: 12px; width: 100%; }
        }
        .nav-link:hover { background-color: var(--primary-soft); color: var(--primary); }
        .nav-link.active { color: var(--primary); background-color: var(--primary-soft); font-weight: 600; }

        #ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .msg-user { background-color: var(--primary); color: white; border-radius: 12px 12px 2px 12px; }
        .msg-ai { background-color: white; border: 1px solid var(--border); border-radius: 12px 12px 12px 2px; }
        
        /* LOGIN STYLES */
        #auth-overlay {
            background-image: linear-gradient(rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.8)), url('https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            z-index: 9999;
        }

        /* ADMIN STYLES */
        .admin-sidebar { background: #1e1b4b; color: white; }
        .admin-nav-item { padding: 12px; border-radius: 8px; cursor: pointer; opacity: 0.7; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .admin-nav-item:hover, .admin-nav-item.active { opacity: 1; background: rgba(255,255,255,0.1); font-weight: 600; }
        .admin-stat-card { background: white; border-radius: 16px; padding: 24px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Loading States */
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body>

    <!-- === AUTH OVERLAY === -->
    <div id="auth-overlay" class="absolute inset-0 z-[100] flex flex-col items-center justify-center p-6 transition-all duration-500 backdrop-blur-sm">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-2xl border-none animate-fade-in">
            <div class="flex flex-col items-center mb-6">
                <div class="w-14 h-14 rounded-2xl bg-indigo-600 flex items-center justify-center text-white mb-3 shadow-lg shadow-indigo-200">
                    <i class="ph-bold ph-airplane-tilt text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Travel Guide</h1>
                <p class="text-sm font-medium text-slate-500">Your Journey Starts Here</p>
            </div>
            
            <form id="form-login" class="space-y-5" onsubmit="handleLogin(event)">
                <div>
                    <label class="block text-xs font-bold text-slate-700 uppercase mb-1 ml-1">Email Address</label>
                    <input type="email" id="login-email" required class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-300 focus:border-indigo-600 focus:ring-4 focus:ring-indigo-100 outline-none text-sm font-semibold text-slate-800 bg-slate-50 focus:bg-white transition-all" placeholder="name@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 uppercase mb-1 ml-1">Password</label>
                    <input type="password" id="login-pass" required class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-300 focus:border-indigo-600 focus:ring-4 focus:ring-indigo-100 outline-none text-sm font-semibold text-slate-800 bg-slate-50 focus:bg-white transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg hover:shadow-indigo-200 active:scale-95 flex justify-center items-center gap-2">
                    <span>Sign In</span> <i class="ph-bold ph-arrow-right"></i>
                </button>
                <button type="button" onclick="guestLogin()" class="w-full text-indigo-600 text-xs font-bold hover:underline">
                    Continue as Guest
                </button>
            </form>

            <form id="form-signup" class="space-y-5 hidden" onsubmit="handleSignup(event)">
                <div><label class="block text-xs font-bold text-slate-700 uppercase mb-1 ml-1">Name</label><input type="text" id="signup-name" required class="w-full p-3 rounded-xl border border-slate-300 outline-none text-sm font-semibold" placeholder="John Doe"></div>
                <div><label class="block text-xs font-bold text-slate-700 uppercase mb-1 ml-1">Email</label><input type="email" id="signup-email" required class="w-full p-3 rounded-xl border border-slate-300 outline-none text-sm font-semibold" placeholder="user@example.com"></div>
                <div><label class="block text-xs font-bold text-slate-700 uppercase mb-1 ml-1">Password</label><input type="password" id="signup-pass" required class="w-full p-3 rounded-xl border border-slate-300 outline-none text-sm font-semibold" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex justify-center items-center gap-2"><span>Create Account</span></button>
            </form>

            <div class="mt-6 text-center pt-4 border-t border-slate-100 space-y-2">
                <button id="toggle-auth" onclick="toggleAuthMode()" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 transition py-2 px-4 rounded-lg hover:bg-indigo-50">
                    Create new account
                </button>
                <div class="text-[10px] text-slate-400">Login to get unlimited access</div>
            </div>
            <p id="auth-error" class="text-red-500 text-xs text-center mt-2 h-4 font-bold"></p>
        </div>
    </div>

    <!-- === ADMIN DASHBOARD === -->
    <div id="admin-container" class="app-shell bg-slate-50 hidden opacity-0 transition-opacity duration-500">
        <div class="flex h-full flex-col md:flex-row">
            <!-- Admin Sidebar -->
            <aside class="admin-sidebar w-full md:w-64 p-4 flex flex-col justify-between shrink-0 shadow-xl z-20">
                <div>
                    <div class="flex items-center gap-3 mb-8 px-2 mt-4">
                        <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-white"><i class="ph-bold ph-shield-check text-xl"></i></div>
                        <h1 class="font-bold text-lg text-white">Admin Panel</h1>
                    </div>
                    <nav class="space-y-2">
                        <div onclick="switchAdminTab('dashboard')" id="adm-nav-dashboard" class="admin-nav-item active"><i class="ph-bold ph-squares-four text-lg"></i> Dashboard</div>
                        <div onclick="switchAdminTab('packages')" id="adm-nav-packages" class="admin-nav-item"><i class="ph-bold ph-suitcase text-lg"></i> Packages</div>
                        <div onclick="switchAdminTab('bookings')" id="adm-nav-bookings" class="admin-nav-item"><i class="ph-bold ph-list-checks text-lg"></i> Bookings</div>
                        <div onclick="switchAdminTab('users')" id="adm-nav-users" class="admin-nav-item"><i class="ph-bold ph-users text-lg"></i> Users</div>
                        <div onclick="switchAdminTab('logs')" id="adm-nav-logs" class="admin-nav-item"><i class="ph-bold ph-scroll text-lg"></i> Logs</div>
                    </nav>
                </div>
                <button onclick="logout()" class="w-full bg-indigo-800/50 text-indigo-200 py-3 rounded-xl text-sm font-bold hover:bg-indigo-800 transition border border-indigo-700/50 flex items-center justify-center gap-2 mb-4"><i class="ph-bold ph-sign-out"></i> Log Out</button>
            </aside>

            <!-- Admin Content -->
            <main class="flex-1 overflow-y-auto p-6 md:p-10 relative bg-slate-50">
                
                <!-- View: Dashboard -->
                <div id="adm-view-dashboard" class="space-y-8 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-900">Dashboard Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="admin-stat-card">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total Users</p><h3 class="text-4xl font-bold text-indigo-600 mt-2" id="stat-total-users">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600"><i class="ph-fill ph-users text-xl"></i></div>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Active Packages</p><h3 class="text-4xl font-bold text-emerald-600 mt-2" id="stat-total-packages">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600"><i class="ph-fill ph-suitcase text-xl"></i></div>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total Bookings</p><h3 class="text-4xl font-bold text-amber-600 mt-2" id="stat-total-bookings">0</h3></div>
                                <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600"><i class="ph-fill ph-ticket text-xl"></i></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Packages -->
                <div id="adm-view-packages" class="hidden space-y-8 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-900">Trip Packages</h2>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph-bold ph-plus-circle text-indigo-600"></i> Create New Package</h3>
                        <form onsubmit="handleCreatePackage(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="pkg-title" placeholder="Package Title (e.g. Goa Beach Blast)" class="pro-input w-full p-3 text-sm" required>
                                <input type="text" id="pkg-location" placeholder="Location (e.g. Goa, India)" class="pro-input w-full p-3 text-sm" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="number" id="pkg-price" placeholder="Price (‚Çπ)" class="pro-input w-full p-3 text-sm" required>
                                <input type="text" id="pkg-duration" placeholder="Duration (e.g. 3 Days 2 Nights)" class="pro-input w-full p-3 text-sm" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="pkg-image" placeholder="Image URL (Optional)" class="pro-input w-full p-3 text-sm">
                                <input type="text" id="pkg-hotel" placeholder="Stay Details (e.g. 5-Star Resort)" class="pro-input w-full p-3 text-sm" required>
                            </div>
                            <textarea id="pkg-desc" placeholder="Itinerary Description..." class="pro-input w-full p-3 text-sm h-24" required></textarea>
                            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-indigo-100">Publish Package</button>
                        </form>
                    </div>

                    <h3 class="font-bold text-slate-700">Existing Packages</h3>
                    <div id="admin-pkg-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- View: Bookings -->
                <div id="adm-view-bookings" class="hidden space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-900">All Customer Bookings</h2>
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3">User Email</th>
                                        <th class="px-6 py-3">Package</th>
                                        <th class="px-6 py-3">Price</th>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-booking-list" class="divide-y divide-slate-100">
                                     <!-- Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- View: Users -->
                <div id="adm-view-users" class="hidden space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-900">Registered Users</h2>
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                         <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3">Name</th>
                                        <th class="px-6 py-3">Email</th>
                                        <th class="px-6 py-3">Role</th>
                                        <th class="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list" class="divide-y divide-slate-100">
                                     <!-- Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- View: Activity Logs -->
                <div id="adm-view-logs" class="hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-900">Activity Logs</h2><button onclick="clearLogs()" class="text-xs text-red-500 hover:underline">Clear Logs</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- User Logs -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                            <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Registered User Activities</h3>
                            <div id="log-list-user" class="space-y-2 max-h-[500px] overflow-y-auto text-sm"></div>
                        </div>
                        <!-- Guest Logs -->
                         <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                            <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Guest Activities</h3>
                            <div id="log-list-guest" class="space-y-2 max-h-[500px] overflow-y-auto text-sm"></div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- === MAIN USER APP === -->
    <div id="app-container" class="app-shell bg-slate-50 hidden opacity-0 transition-opacity duration-500">
        <!-- Sidebar Navigation -->
        <nav class="bg-white border-r border-slate-200 z-50 flex md:flex-col justify-between items-center md:items-start px-2 py-2 md:p-4 h-16 md:h-full w-full md:w-64 shrink-0 shadow-lg md:shadow-none order-2 md:order-1 absolute bottom-0 md:relative">
            <div class="hidden md:flex items-center gap-3 mb-8 px-2">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white"><i class="ph-bold ph-airplane-tilt text-xl"></i></div>
                <h1 class="font-bold text-lg text-slate-900 tracking-tight">Travel Guide</h1>
            </div>

            <div class="flex md:flex-col justify-around w-full gap-1 md:gap-2">
                <button onclick="switchTab('home')" id="nav-home" class="nav-link active flex-1 md:flex-none"><i class="ph-fill ph-house text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Home</span></button>
                <button onclick="switchTab('map')" id="nav-map" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-map-trifold text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Explore</span></button>
                <button onclick="switchTab('ar')" id="nav-ar" class="nav-link flex-1 md:flex-none relative">
                    <div class="md:hidden -mt-8 bg-indigo-600 rounded-full w-12 h-12 flex items-center justify-center text-white shadow-lg shadow-indigo-200 border-4 border-slate-50"><i class="ph-bold ph-camera text-xl"></i></div>
                    <div class="hidden md:flex items-center gap-3"><i class="ph-bold ph-camera text-lg"></i><span class="text-sm font-medium">AR Scanner</span></div>
                    <span class="md:hidden text-[10px] font-medium mt-1">Scan</span>
                </button>
                <button onclick="switchTab('packages')" id="nav-packages" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-suitcase-rolling text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Trips</span></button>
                <button onclick="switchTab('tools')" id="nav-tools" class="nav-link flex-1 md:flex-none"><i class="ph-bold ph-squares-four text-xl md:text-lg"></i><span class="text-[10px] md:text-sm font-medium">Tools</span></button>
            </div>
            
            <div onclick="switchTab('profile')" class="hidden md:flex mt-auto w-full pt-4 border-t border-slate-100 items-center gap-3 cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition">
                <img id="user-avatar-desktop" src="" alt="User" class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200">
                <div class="flex flex-col text-left"><span id="user-name-desktop" class="text-xs font-bold text-slate-700">User</span><span class="text-[10px] text-emerald-600 font-medium">‚óè Online</span></div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 relative order-1 md:order-2 h-[calc(100%-64px)] md:h-full overflow-hidden">
            <!-- Mobile Header -->
            <header class="md:hidden absolute top-0 w-full z-40 px-4 py-3 flex justify-between items-center bg-white/80 backdrop-blur-md border-b border-slate-200">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white"><i class="ph-bold ph-airplane-tilt"></i></div>
                    <h1 class="font-bold text-lg text-slate-900">Travel Guide</h1>
                </div>
                <div onclick="switchTab('profile')" class="w-8 h-8 rounded-full bg-slate-100 overflow-hidden border border-slate-200 cursor-pointer">
                    <img id="user-avatar-mobile" src="" alt="User" class="w-full h-full object-cover" />
                </div>
            </header>

            <!-- 1. HOME VIEW -->
            <section id="view-home" class="view-section absolute inset-0 pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6 pb-24">
                    <!-- Location & Weather -->
                    <div class="flex flex-col lg:flex-row gap-4">
                        <div class="flex-1 pro-card bg-white p-5">
                            <div class="flex justify-between items-center mb-4"><h2 class="text-sm font-bold text-slate-400 uppercase tracking-wide">Select Location</h2><button onclick="detectLiveLocation()" class="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-2 py-1 rounded transition flex items-center gap-1"><i class="ph-bold ph-crosshair"></i> Auto-Detect</button></div>
                            <div class="relative mb-4">
                                <div class="relative">
                                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-3.5 text-slate-400"></i>
                                    <input type="text" id="location-search-input" oninput="handleLocationSearch(event)" placeholder="Search City, Town, or Village..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-indigo-500 transition-colors">
                                    <div id="search-spinner" class="absolute right-3 top-3.5 hidden"><i class="ph-bold ph-spinner animate-spin text-indigo-600"></i></div>
                                </div>
                                <div id="search-results-dropdown" class="absolute top-full left-0 w-full bg-white border border-slate-200 rounded-xl shadow-xl mt-1 z-50 max-h-60 overflow-y-auto hidden"></div>
                            </div>
                            <p class="text-xs text-slate-400 italic">Enter location to see famous places and weather.</p>
                        </div>
                        <div class="w-full lg:w-72 pro-card bg-gradient-to-br from-indigo-600 to-violet-700 text-white p-5 flex flex-col justify-between relative overflow-hidden"><div class="absolute top-0 right-0 p-4 opacity-20"><i id="weather-icon" class="ph-duotone ph-cloud-sun text-6xl"></i></div><div class="z-10"><div class="inline-flex items-center gap-1 bg-white/20 backdrop-blur px-2 py-0.5 rounded-full text-[10px] font-bold mb-2 border border-white/10"><i class="ph-fill ph-map-pin"></i> <span id="weather-loc">India</span></div><h3 id="weather-temp" class="text-4xl font-bold">--¬∞</h3><p id="weather-desc" class="text-sm text-indigo-100 opacity-90">Live Weather</p></div></div>
                    </div>
                    
                    <!-- Featured Package Teaser -->
                    <div class="pro-card bg-white p-4 border-l-4 border-indigo-500">
                        <div class="flex justify-between items-center">
                            <div><h3 class="font-bold text-slate-900">Recommended Trips</h3><p class="text-xs text-slate-500">Curated packages for you</p></div>
                            <button onclick="switchTab('packages')" class="text-indigo-600 text-xs font-bold hover:underline">View All &rarr;</button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-bold text-slate-800 mb-3">Find Nearby</h3>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                            <button onclick="quickSearch('attractions')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-amber-600 bg-amber-50/50 border-amber-100"><i class="ph-duotone ph-star text-2xl"></i> <span class="text-xs font-bold">Top 20</span></button>
                            <button onclick="quickSearch('temple')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-purple-600 hover:bg-purple-50"><i class="ph-duotone ph-mosque text-2xl"></i> <span class="text-xs font-bold">Temples</span></button>
                            <button onclick="quickSearch('park')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-green-600 hover:bg-green-50"><i class="ph-duotone ph-tree text-2xl"></i> <span class="text-xs font-bold">Parks</span></button>
                            <button onclick="quickSearch('restaurant')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-orange-600 hover:bg-orange-50"><i class="ph-duotone ph-hamburger text-2xl"></i> <span class="text-xs font-bold">Food</span></button>
                            <button onclick="quickSearch('shopping')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-pink-600 hover:bg-pink-50"><i class="ph-duotone ph-shopping-bag text-2xl"></i> <span class="text-xs font-bold">Shop</span></button>
                            <button onclick="quickSearch('hotel')" class="pro-card p-3 flex flex-col items-center gap-2 hover:-translate-y-1 transition text-blue-600 hover:bg-blue-50"><i class="ph-duotone ph-bed text-2xl"></i> <span class="text-xs font-bold">Hotels</span></button>
                        </div>
                        <input type="hidden" id="osm-query">
                    </div>
                    <div class="pro-card bg-white min-h-[300px] p-4"><div id="results-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div class="col-span-full flex flex-col items-center justify-center py-12 text-slate-400"><i class="ph-duotone ph-magnifying-glass text-4xl mb-2"></i><p class="text-sm font-medium">Select a category to start scanning</p></div></div></div>
                </div>
            </section>

            <!-- 2. MAP VIEW -->
            <section id="view-map" class="view-section absolute inset-0 hidden"><div id="map" class="w-full h-full bg-slate-100 z-0"></div><button onclick="locateUser()" class="absolute bottom-24 right-6 z-[400] bg-white text-slate-800 p-3 rounded-xl shadow-lg border border-slate-200 hover:bg-slate-50 transition active:scale-95"><i class="ph-bold ph-crosshair text-2xl"></i></button></section>

            <!-- 3. AR VIEW -->
            <section id="view-ar" class="view-section absolute inset-0 hidden bg-black">
                 <video id="ar-video" autoplay playsinline muted loop class="absolute inset-0 w-full h-full object-cover opacity-90 hidden"></video>
                 <img id="ar-static-img" class="absolute inset-0 w-full h-full object-contain bg-black hidden z-10">
                 <canvas id="ar-canvas" class="relative z-10"></canvas>
                 <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                 
                 <!-- AR Controls -->
                 <div class="absolute top-0 left-0 w-full p-4 pt-20 z-30 bg-gradient-to-b from-black/80 to-transparent flex flex-col gap-3">
                     <div class="flex justify-between items-center">
                        <div class="bg-black/40 backdrop-blur-md rounded-lg p-1 flex gap-1 border border-white/10 flex-1 mr-2">
                            <button onclick="switchVision('object')" id="btn-vis-obj" class="flex-1 px-3 py-2 rounded-md text-xs font-bold bg-white text-black transition">Object</button>
                            <button onclick="switchVision('ocr')" id="btn-vis-ocr" class="flex-1 px-3 py-2 rounded-md text-xs font-bold text-white transition hover:bg-white/10">Text</button>
                        </div>
                        <button onclick="triggerUpload()" class="bg-indigo-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-lg hover:bg-indigo-500 transition"><i class="ph-bold ph-image text-lg"></i></button>
                     </div>
                 </div>

                 <div id="ai-loading" class="hidden absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm"><i class="ph-bold ph-spinner animate-spin text-4xl text-white mb-2"></i><p class="text-white font-bold text-sm">Processing...</p></div>
                 <div id="obj-result" class="absolute bottom-32 left-0 w-full p-4 text-center hidden"><div class="inline-block bg-black/60 backdrop-blur-md px-4 py-2 rounded-full border border-white/10"><p id="obj-name" class="text-white font-bold text-sm">Detecting...</p></div></div>
                 
                 <div id="ocr-controls" class="hidden absolute bottom-24 left-0 w-full bg-slate-900/90 backdrop-blur-xl border-t border-white/10 p-4 z-30 rounded-t-2xl">
                    <div class="flex gap-4 mb-4"><div class="flex-1"><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Reading</label><select id="ocr-source-lang" onchange="resetOCR()" class="w-full bg-white/10 text-white text-xs font-bold p-2 rounded border border-white/20 focus:outline-none"><option value="eng">English</option><option value="hin">Hindi</option><option value="kan">Kannada</option><option value="tam">Tamil</option><option value="tel">Telugu</option><option value="mal">Malayalam</option></select></div><div class="flex-1"><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Translate To</label><select id="target-lang" onchange="updateArTranslation()" class="w-full bg-white/10 text-white text-xs font-bold p-2 rounded border border-white/20 focus:outline-none"><option value="en">English</option><option value="hi">Hindi</option><option value="kn">Kannada</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ml">Malayalam</option></select></div></div>
                    <div id="ocr-result" class="bg-black/50 rounded-lg p-3 border border-white/10 hidden"><p id="ocr-text" class="text-xs text-slate-400 font-mono mb-2 border-b border-white/10 pb-2">Scanning...</p><p class="text-[9px] text-indigo-400 font-bold uppercase">Result</p><p id="ocr-trans-text" class="text-sm text-white font-bold">...</p></div>
                 </div>

                 <div id="camera-error" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6 text-center"><i class="ph-duotone ph-camera-slash text-4xl text-slate-500 mb-3"></i><h3 class="text-white font-bold mb-1">Camera Permission Needed</h3><p class="text-slate-400 text-xs mb-4">Please allow camera access.</p><div class="flex gap-2"><button onclick="startCamera()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Retry</button><button onclick="triggerUpload()" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-bold border border-white/20">Upload</button></div></div>
            </section>

            <!-- 4. TRIP PACKAGES -->
            <section id="view-packages" class="view-section absolute inset-0 hidden pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-6xl mx-auto p-4 md:p-8 pb-24">
                    <h2 class="text-xl font-bold text-slate-900 mb-4">Curated Trip Packages</h2>
                    <div id="user-pkg-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Content -->
                    </div>
                </div>
            </section>

            <!-- 5. TOOLS (VOICE + AI) -->
            <section id="view-tools" class="view-section absolute inset-0 hidden pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                <div class="max-w-3xl mx-auto p-4 md:p-8 flex flex-col gap-6 pb-24">
                    <div class="flex bg-white p-1 rounded-xl border border-slate-200">
                        <button onclick="toggleTool('voice')" id="tool-voice" class="flex-1 py-3 rounded-lg text-xs font-bold text-white bg-indigo-600 shadow-sm transition">Voice Translator</button>
                        <button onclick="toggleTool('ai')" id="tool-ai" class="flex-1 py-3 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 transition">AI Assistant</button>
                    </div>

                    <!-- Voice Tool -->
                    <div id="tool-container-voice" class="flex flex-col gap-4">
                        <div class="pro-card bg-white p-2 flex items-center justify-between">
                            <select id="trans-source" class="bg-transparent text-indigo-600 font-bold text-sm p-2 outline-none cursor-pointer"><option value="en">English</option><option value="hi">Hindi</option><option value="kn">Kannada</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ml">Malayalam</option></select>
                            <button onclick="swapLanguages()" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-400"><i class="ph-bold ph-arrows-left-right"></i></button>
                            <select id="trans-target" class="bg-transparent text-slate-900 font-bold text-sm p-2 outline-none cursor-pointer text-right" dir="rtl"><option value="hi">Hindi</option><option value="en">English</option><option value="kn">Kannada</option><option value="ta">Tamil</option><option value="te">Telugu</option><option value="ml">Malayalam</option></select>
                        </div>
                        <div class="pro-card bg-white flex-1 p-6 flex flex-col relative min-h-[300px]">
                            <textarea id="trans-input" class="w-full h-1/2 bg-transparent text-2xl text-slate-800 placeholder-slate-300 border-none focus:outline-none resize-none font-medium" placeholder="Type or Speak..."></textarea>
                            <div class="h-px bg-slate-100 w-full my-6"></div>
                            <div class="flex-1 relative">
                                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-indigo-500 uppercase">Translation</span><button onclick="speakTranslation()" class="text-slate-400 hover:text-indigo-600"><i class="ph-fill ph-speaker-high text-xl"></i></button></div>
                                <p id="trans-output" class="text-xl text-slate-700 font-medium">...</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="translateTextManual()" class="flex-1 bg-indigo-600 text-white h-14 rounded-xl font-bold shadow-md">TRANSLATE</button>
                            <button onclick="toggleVoiceInput()" class="w-14 h-14 bg-white text-slate-900 border border-slate-200 rounded-xl shadow-sm flex items-center justify-center relative overflow-hidden"><div id="mic-pulse" class="absolute inset-0 bg-red-500/10 hidden animate-pulse"></div><i class="ph-fill ph-microphone text-xl text-indigo-600"></i></button>
                        </div>
                        <p id="mic-status" class="text-center text-xs font-bold text-red-500 h-4"></p>
                    </div>

                    <!-- AI Tool -->
                    <div id="tool-container-ai" class="hidden flex-col gap-4 h-[65vh]">
                         <div id="ai-chat-container" class="flex-1 flex flex-col bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm h-full">
                            <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4"><div class="flex gap-3 max-w-[90%] chat-ai p-4 animate-fade-in"><div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center shrink-0 border border-indigo-100"><i class="ph-fill ph-robot text-indigo-600"></i></div><p class="text-sm text-slate-700 leading-relaxed">Hello! I'm TravelGPT. üåç<br>Ask me "Hotels in Mumbai" or "Places to visit in Kerala".</p></div></div>
                            <div class="p-3 bg-slate-50 border-t border-slate-100 flex gap-2"><input type="text" id="chat-input" placeholder="Ask anything..." class="flex-1 bg-white border border-slate-200 rounded-xl px-4 text-sm focus:outline-none focus:border-indigo-500 transition" onkeypress="handleChatKey(event)"><button onclick="sendChat()" class="bg-indigo-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-indigo-700 transition"><i class="ph-bold ph-paper-plane-right"></i></button></div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl border border-slate-200">
                             <textarea id="user-notes" class="w-full text-sm text-slate-800 placeholder-slate-400 focus:outline-none resize-none h-20" placeholder="Trip Notes..." oninput="saveNote()"></textarea>
                             <div class="flex justify-end mt-2"><button onclick="downloadNote()" class="text-xs font-bold text-indigo-600 hover:underline">Download Notes</button></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 6. PROFILE -->
            <section id="view-profile" class="view-section absolute inset-0 hidden pt-16 md:pt-0 overflow-y-auto bg-slate-50">
                 <div class="max-w-xl mx-auto p-6 md:p-12">
                    <div class="pro-card bg-white p-8 text-center mb-6">
                        <img id="profile-avatar" src="" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-indigo-50 shadow-md">
                        <div class="flex flex-col items-center">
                            <h2 id="profile-name" class="text-2xl font-bold text-slate-900">Guest User</h2>
                            <span id="guest-badge" class="hidden mt-1 px-2 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-bold uppercase rounded-full tracking-wide border border-amber-200">Guest Mode</span>
                        </div>
                        <p id="profile-email" class="text-sm text-slate-500 mb-6 font-medium mt-1">--</p>
                        
                        <div id="user-bookings-list" class="text-left mt-6 pt-6 border-t border-slate-100">
                            <h3 class="text-sm font-bold text-slate-800 mb-3">My Bookings</h3>
                            <div id="bookings-container" class="space-y-3 text-sm text-slate-500">No bookings yet.</div>
                        </div>
                    </div>
                    <button onclick="logout()" class="w-full bg-white text-red-600 font-bold py-4 rounded-xl hover:bg-red-50 transition border border-red-100 shadow-sm">Sign Out</button>
                </div>
            </section>

        </main>
    </div>

    <!-- === JAVASCRIPT LOGIC === -->
    <script>
        let currentUser = null;
        let currentLat = 28.6139; let currentLng = 77.2090;
        let map = null; let mapMarkers = []; let objectModel = null;
        let isCameraOn = false; let visionMode = 'object'; let processingOCR = false;
        let lastOcrText = ""; let recognition = null; let isListening = false;
        let ocrWorker = null;
        let guestSearchCount = 0; 
        let searchTimeout = null;

        const LOG_KEY = 'activityLogs';

        // --- UTILS ---
        function logActivity(action, detail) {
            const logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
            const entry = {
                user: currentUser ? currentUser.email : 'Unknown',
                role: currentUser ? currentUser.role : 'guest',
                action: action,
                detail: detail,
                time: new Date().toLocaleString()
            };
            logs.unshift(entry);
            // Limit logs
            if(logs.length > 200) logs.pop();
            localStorage.setItem(LOG_KEY, JSON.stringify(logs));
        }
        function clearLogs() { localStorage.setItem(LOG_KEY, '[]'); renderLogs(); }

        // --- AUTH & ADMIN ---
        function initAuth() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) { currentUser = JSON.parse(storedUser); showApp(); } else { showAuth(); }
        }
        function showAuth() { document.getElementById('auth-overlay').style.display = 'flex'; document.getElementById('app-container').classList.add('hidden'); }
        function showApp() {
            document.getElementById('auth-overlay').style.display = 'none';
            if(currentUser.email === 'admin@travel.com') {
                document.getElementById('admin-container').classList.remove('hidden');
                setTimeout(() => document.getElementById('admin-container').classList.add('opacity-100'), 50);
                renderAdminPackages();
                renderAllBookings();
                renderAllUsers();
                renderAdminStats();
                renderLogs();
            } else {
                document.getElementById('app-container').classList.remove('hidden');
                setTimeout(() => document.getElementById('app-container').classList.add('opacity-100'), 50);
                
                // Profile Setup
                const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(currentUser.name)}`;
                document.getElementById('user-avatar-desktop').src = avatarUrl;
                document.getElementById('user-avatar-mobile').src = avatarUrl;
                document.getElementById('profile-avatar').src = avatarUrl;
                document.getElementById('profile-name').innerText = currentUser.name;
                document.getElementById('profile-email').innerText = currentUser.email;
                
                if(currentUser.role === 'guest') document.getElementById('guest-badge').classList.remove('hidden');

                renderUserPackages();
                renderBookings();
                
                if(!map) setTimeout(initMap, 200);
                initSpeech(); loadModels(); loadUserData();
                // Check if user has saved location
                const lat = localStorage.getItem(`lat_${currentUser.email}`);
                const lng = localStorage.getItem(`lng_${currentUser.email}`);
                if(lat && lng) updateLocation(parseFloat(lat), parseFloat(lng), "Saved Location");
            }
        }
        
        function toggleAuthMode() {
            const l = document.getElementById('form-login');
            const s = document.getElementById('form-signup');
            const b = document.getElementById('toggle-auth');
            if (l.classList.contains('hidden')) {
                l.classList.remove('hidden'); s.classList.add('hidden'); b.innerText = "Create new account";
            } else {
                l.classList.add('hidden'); s.classList.remove('hidden'); b.innerText = "Already have an account? Log In";
            }
            document.getElementById('auth-error').innerText = "";
        }

        // --- ADMIN LOGIC ---
        function switchAdminTab(t) {
             const views = ['dashboard', 'packages', 'bookings', 'users', 'logs'];
             views.forEach(v => {
                 document.getElementById(`adm-view-${v}`).classList.add('hidden');
                 document.getElementById(`adm-nav-${v}`).classList.remove('active');
             });
             document.getElementById(`adm-view-${t}`).classList.remove('hidden');
             document.getElementById(`adm-nav-${t}`).classList.add('active');
        }
        function renderAdminStats() {
            const users = Object.keys(JSON.parse(localStorage.getItem('users') || '{}')).length;
            const pkgs = JSON.parse(localStorage.getItem('tripPackages') || '[]').length;
            let totalBookings = 0;
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('bookings_')) totalBookings += JSON.parse(localStorage.getItem(key)).length;
            }
            document.getElementById('stat-total-users').innerText = users;
            document.getElementById('stat-total-packages').innerText = pkgs;
            document.getElementById('stat-total-bookings').innerText = totalBookings;
        }
        function renderAllBookings() {
             let html = '';
             for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('bookings_')) {
                    const userEmail = key.replace('bookings_', '');
                    const userBookings = JSON.parse(localStorage.getItem(key));
                    userBookings.forEach(b => {
                        html += `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-medium text-slate-900">${userEmail}</td><td class="px-6 py-4">${b.title}</td><td class="px-6 py-4">‚Çπ${b.price}</td><td class="px-6 py-4">${b.date}</td><td class="px-6 py-4 text-emerald-600 font-bold">Confirmed</td></tr>`;
                    });
                }
             }
             if(!html) html = '<tr><td colspan="5" class="p-4 text-center text-slate-400">No bookings yet.</td></tr>';
             document.getElementById('admin-booking-list').innerHTML = html;
        }
        function renderAllUsers() {
             const users = JSON.parse(localStorage.getItem('users') || '{}');
             let html = '';
             Object.values(users).forEach(u => {
                 html += `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-medium text-slate-900">${u.name}</td><td class="px-6 py-4">${u.email}</td><td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2.5 py-0.5 rounded">${u.role}</span></td><td class="px-6 py-4"><button onclick="removeUser('${u.email}')" class="text-red-600 hover:underline">Remove</button></td></tr>`;
             });
             document.getElementById('admin-user-list').innerHTML = html;
        }
        function removeUser(email) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            delete users[email];
            localStorage.setItem('users', JSON.stringify(users));
            renderAllUsers(); renderAdminStats();
        }
        function renderLogs() {
            const logs = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
            const userLogs = logs.filter(l => l.role !== 'guest');
            const guestLogs = logs.filter(l => l.role === 'guest');
            
            const render = (list, elId) => {
                const el = document.getElementById(elId);
                el.innerHTML = list.map(l => `<div class="p-2 border-b border-slate-100 last:border-0"><div class="flex justify-between"><span class="font-bold text-slate-700">${l.action}</span><span class="text-[10px] text-slate-400">${l.time}</span></div><p class="text-xs text-slate-500">${l.detail} (${l.user})</p></div>`).join('') || '<p class="text-slate-400 p-2">No logs.</p>';
            };
            render(userLogs, 'log-list-user');
            render(guestLogs, 'log-list-guest');
        }

        // --- AUTH LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            
            if(email === 'admin@travel.com' && pass === 'Admin@1223') {
                currentUser = { name: "Admin", email: email, role: 'admin' };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                logActivity('Admin Login', 'Admin access granted');
                showApp();
                return;
            }
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[email];
            if (user && user.pass === pass) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                currentUser = user;
                logActivity('User Login', `Login success for ${email}`);
                showApp();
            } else { document.getElementById('auth-error').innerText = "Invalid credentials"; }
        }
        function handleSignup(e) {
             e.preventDefault();
             const name = document.getElementById('signup-name').value;
             const email = document.getElementById('signup-email').value;
             const pass = document.getElementById('signup-pass').value;
             const users = JSON.parse(localStorage.getItem('users') || '{}');
             if(users[email]) { document.getElementById('auth-error').innerText = "Email already exists"; return; }
             const newUser = { name, email, pass, role: 'user' };
             users[email] = newUser;
             localStorage.setItem('users', JSON.stringify(users));
             localStorage.setItem('currentUser', JSON.stringify(newUser));
             currentUser = newUser;
             logActivity('Signup', `New user registered: ${email}`);
             showApp();
        }
        function guestLogin() { currentUser = { name: "Guest", email: "guest@travel.app", role: 'guest' }; localStorage.setItem('currentUser', JSON.stringify(currentUser)); logActivity('Guest Access', 'Guest session started'); showApp(); }
        function logout() { logActivity('Logout', `${currentUser.email} logged out`); localStorage.removeItem('currentUser'); location.reload(); }

        function checkGuestLimit() {
            if(currentUser && currentUser.role === 'guest') {
                if(guestSearchCount >= 5) {
                    alert("Guest Limit Reached (5 Searches). Please create an account to continue.");
                    return false;
                }
                guestSearchCount++;
            }
            return true;
        }

        // --- PACKAGES ---
        function handleCreatePackage(e) {
            e.preventDefault();
            const imageInput = document.getElementById('pkg-image');
            const pkg = {
                id: Date.now(),
                title: document.getElementById('pkg-title').value,
                location: document.getElementById('pkg-location').value,
                price: document.getElementById('pkg-price').value,
                duration: document.getElementById('pkg-duration').value,
                hotel: document.getElementById('pkg-hotel').value,
                // Use a default image if none provided
                image: imageInput && imageInput.value ? imageInput.value : 'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=2070&auto=format&fit=crop',
                desc: document.getElementById('pkg-desc').value
            };
            const packages = JSON.parse(localStorage.getItem('tripPackages') || '[]');
            packages.push(pkg);
            localStorage.setItem('tripPackages', JSON.stringify(packages));
            alert("Package Created!");
            renderAdminPackages(); renderAdminStats();
            e.target.reset();
        }
        function renderAdminPackages() {
            const list = document.getElementById('admin-pkg-list');
            const packages = JSON.parse(localStorage.getItem('tripPackages') || '[]');
            list.innerHTML = packages.map(p => `<div class="border p-4 rounded-lg flex justify-between items-center"><div><h3 class="font-bold">${p.title}</h3><p class="text-xs text-slate-500">${p.location}</p></div><button onclick="deletePackage(${p.id})" class="text-red-500 text-xs hover:underline">Delete</button></div>`).join('');
        }
        function deletePackage(id) {
            let packages = JSON.parse(localStorage.getItem('tripPackages') || '[]');
            packages = packages.filter(p => p.id !== id);
            localStorage.setItem('tripPackages', JSON.stringify(packages));
            renderAdminPackages(); renderAdminStats();
        }
        function renderUserPackages() {
            const container = document.getElementById('user-pkg-list');
            const packages = JSON.parse(localStorage.getItem('tripPackages') || '[]');
            if(packages.length === 0) { container.innerHTML = '<p class="col-span-full text-center text-slate-400">No packages available yet. Admin needs to add some.</p>'; return; }
            container.innerHTML = packages.map(p => `
                <div class="pro-card bg-white overflow-hidden flex flex-col h-full hover:shadow-lg transition">
                    <div class="h-40 bg-slate-200 bg-cover bg-center" style="background-image: url('${p.image}')"></div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-slate-900 text-lg">${p.title}</h3><span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded">‚Çπ${p.price}</span></div>
                        <p class="text-xs text-slate-500 mb-4 flex items-center gap-1"><i class="ph-fill ph-map-pin"></i> ${p.location} ‚Ä¢ ${p.duration}</p>
                        <p class="text-sm text-slate-600 mb-4 flex-1 line-clamp-3">${p.desc}</p>
                        <div class="text-xs text-indigo-600 bg-indigo-50 p-2 rounded mb-4"><strong>Stay:</strong> ${p.hotel}</div>
                        <button onclick="bookPackage(${p.id})" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition">Book Now</button>
                    </div>
                </div>
            `).join('');
        }
        function bookPackage(id) {
            if(currentUser.role === 'guest') return alert("Guests cannot book trips. Please sign up to book.");
            const packages = JSON.parse(localStorage.getItem('tripPackages') || '[]');
            const pkg = packages.find(p => p.id === id);
            if(!pkg) return;
            const bookings = JSON.parse(localStorage.getItem(`bookings_${currentUser.email}`) || '[]');
            bookings.push({ ...pkg, date: new Date().toLocaleDateString() });
            localStorage.setItem(`bookings_${currentUser.email}`, JSON.stringify(bookings));
            alert(`Successfully booked: ${pkg.title}!`);
            logActivity('Booking Success', `Booked ${pkg.title} for ‚Çπ${pkg.price}`);
            renderBookings();
        }
        function renderBookings() {
            const container = document.getElementById('bookings-container');
            const bookings = JSON.parse(localStorage.getItem(`bookings_${currentUser.email}`) || '[]');
            if(bookings.length === 0) container.innerHTML = "No bookings yet.";
            else container.innerHTML = bookings.map(b => `<div class="bg-slate-50 p-3 rounded-lg border border-slate-100 mb-2"><p class="font-bold text-slate-800">${b.title}</p><div class="flex justify-between text-xs text-slate-500"><span>${b.date}</span><span class="text-emerald-600 font-bold">Confirmed</span></div></div>`).join('');
        }

        // --- NAVIGATION & TABS ---
        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(el=>{el.classList.add('hidden'); el.classList.remove('opacity-100');});
            const v = document.getElementById(`view-${t}`);
            v.classList.remove('hidden'); 
            
            if(t === 'packages') renderUserPackages();
            if(t === 'map') {
                setTimeout(() => {
                    if(map) {
                        map.invalidateSize();
                        // Center map on current location if available
                        map.setView([currentLat, currentLng], 15);
                    }
                }, 200);
            }

            // Simple animation
            setTimeout(()=>v.classList.add('opacity-100'), 50);
            
            if(t==='ar') startCamera(); else stopCamera();
            
            document.querySelectorAll('.nav-link').forEach(b=>{ b.classList.remove('active'); });
            const btn = document.getElementById(`nav-${t}`);
            if(btn) btn.classList.add('active');
        }
        function toggleTool(t) {
            document.getElementById('tool-container-voice').classList.toggle('hidden', t!=='voice');
            document.getElementById('tool-container-ai').classList.toggle('hidden', t!=='ai');
             const c=document.getElementById('tool-voice'); const n=document.getElementById('tool-ai');
             if(t==='voice') { c.className="flex-1 py-3 rounded-lg text-xs font-bold text-white bg-indigo-600 shadow-sm transition"; n.className="flex-1 py-3 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 transition"; }
             else { n.className="flex-1 py-3 rounded-lg text-xs font-bold text-white bg-indigo-600 shadow-sm transition"; c.className="flex-1 py-3 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 transition"; }
        }

        // --- LOCATION & MAP ---
        async function handleLocationSearch(e) {
            const query = e.target.value;
            const resultsContainer = document.getElementById('search-results-dropdown');
            const spinner = document.getElementById('search-spinner');
            
            if (searchTimeout) clearTimeout(searchTimeout);
            if (query.length < 3) { resultsContainer.classList.add('hidden'); spinner.classList.add('hidden'); return; }

            spinner.classList.remove('hidden');

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`);
                    const data = await res.json();
                    
                    if (data.results) { renderSearchResults(data.results); } 
                    else { resultsContainer.classList.add('hidden'); }
                } catch (e) { console.error(e); } 
                finally { spinner.classList.add('hidden'); }
            }, 400);
        }
        function renderSearchResults(results) {
            const container = document.getElementById('search-results-dropdown');
            container.innerHTML = '';
            container.classList.remove('hidden');

            results.forEach(res => {
                const div = document.createElement('div');
                div.className = "px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0 flex flex-col";
                div.onclick = () => selectSearchResult(res);
                div.innerHTML = `<span class="font-bold text-slate-800 text-sm">${res.name}</span><span class="text-xs text-slate-500">${res.admin1 || ''}, ${res.country || ''}</span>`;
                container.appendChild(div);
            });
        }
        function selectSearchResult(res) {
            document.getElementById('location-search-input').value = res.name;
            document.getElementById('search-results-dropdown').classList.add('hidden');
            if(checkGuestLimit()) {
                updateLocation(res.latitude, res.longitude, res.name);
                if(document.getElementById('weather-loc')) document.getElementById('weather-loc').innerText = res.name;
                fetchFamousPlaces(res.latitude, res.longitude); 
            }
        }
        function updateLocation(lat, lng, label) {
            currentLat = lat; currentLng = lng;
            if(currentUser) { localStorage.setItem(`lat_${currentUser.email}`, lat); localStorage.setItem(`lng_${currentUser.email}`, lng); }
            fetchWeather(); 
            if(map) { 
                map.setView([lat, lng], 14); 
                L.marker([lat, lng]).addTo(map).bindPopup(label).openPopup(); 
            }
        }
        async function detectLiveLocation() {
            if(!checkGuestLimit()) return;
            if(!navigator.geolocation) return alert("No GPS support in browser.");
            document.getElementById('weather-loc').innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    const data = await res.json();
                    const city = data.address.city || data.address.town || data.address.village || "My Location";
                    document.getElementById('weather-loc').innerText = city;
                    updateLocation(lat, lng, "You are here");
                    fetchFamousPlaces(lat, lng);
                } catch(e) { 
                    updateLocation(lat, lng, "You"); 
                    document.getElementById('weather-loc').innerText = "Local";
                }
            }, () => alert("Location permission denied."));
        }
        async function fetchWeather() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLng}&current_weather=true`);
                const data = await res.json();
                document.getElementById('weather-temp').innerText = `${Math.round(data.current_weather.temperature)}¬∞`;
                document.getElementById('weather-desc').innerText = `Wind: ${data.current_weather.windspeed} km/h`;
            } catch(e){}
        }
        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl: false}).setView([currentLat, currentLng], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map);
            L.marker([currentLat, currentLng]).addTo(map).bindPopup("Start").openPopup();
        }
        function locateUser() { map.setView([currentLat, currentLng], 16); }
        
        // --- OVERPASS PLACES ---
        function quickSearch(type) { if(!checkGuestLimit()) return; document.getElementById('osm-query').value = type; fetchFamousPlaces(currentLat, currentLng, type); }
        async function fetchFamousPlaces(lat, lon, type = 'attractions') {
            const resArea = document.getElementById('results-area');
            resArea.innerHTML = '<div class="col-span-full text-center py-10 opacity-50 text-xs animate-pulse font-bold text-indigo-600">Scouting Sector...</div>';
            
            const r = 5000;
            let ql = `[out:json][timeout:25];(nwr["tourism"~"attraction"](around:${r},${lat},${lon}););out center 20;`; 
            if(type==='attractions') ql = `[out:json][timeout:25];(nwr["tourism"~"attraction|viewpoint|museum"](around:${r},${lat},${lon});nwr["historic"](around:${r},${lat},${lon}););out center 20;`;
            else if(type==='temple') ql = `[out:json][timeout:25];nwr["amenity"="place_of_worship"](around:${r},${lat},${lon});out center 20;`;
            else ql = `[out:json][timeout:25];nwr["amenity"~"${type}"](around:${r},${lat},${lon});out center 20;`;

            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(ql)}`);
                const data = await res.json();
                
                resArea.innerHTML=''; 
                mapMarkers.forEach(m=>map.removeLayer(m)); mapMarkers=[];

                if(!data || !data.elements.length) {
                    resArea.innerHTML = '<div class="col-span-full text-center py-10 opacity-40 text-xs font-bold text-slate-400">No places found nearby. Try a different category.</div>';
                } else {
                    data.elements.forEach((p, i) => {
                        const name = p.tags.name; if(!name) return;
                        let plat = p.lat || p.center.lat; let plon = p.lon || p.center.lon;
                        const url = `https://www.google.com/maps/search/?api=1&query=${plat},${plon}`;
                        const card = document.createElement('div');
                        card.className = "pro-card p-4 flex justify-between items-center animate-fade-in hover:border-indigo-500/50";
                        card.style.animationDelay = `${i*0.05}s`;
                        card.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><div class="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0"><i class="ph-fill ph-map-pin text-lg"></i></div><div class="truncate"><h4 class="text-sm font-bold text-slate-800 truncate">${name}</h4><p class="text-[10px] text-slate-500 font-medium truncate uppercase tracking-wide">${p.tags.amenity || p.tags.tourism || 'Place'}</p></div></div><a href="${url}" target="_blank" class="w-9 h-9 rounded-lg bg-indigo-600 flex items-center justify-center text-white hover:bg-indigo-700 transition shadow-sm active:scale-95"><i class="ph-bold ph-navigation-arrow"></i></a>`;
                        resArea.appendChild(card);
                        const m=L.marker([plat, plon]).addTo(map).bindPopup(name); mapMarkers.push(m);
                    });
                }
            } catch(e) {
                resArea.innerHTML = '<div class="col-span-full text-center py-10 text-red-400 text-xs">Error fetching places. Network busy.</div>';
            }
        }

        // --- AR & VISION ---
        async function startCamera() {
            const v=document.getElementById('ar-video'); const s=document.getElementById('ar-static-img');
            s.classList.add('hidden'); v.classList.remove('hidden'); isCameraOn=true;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                v.srcObject=stream; 
                // Wait for video to be ready before playing to avoid promise errors
                v.onloadedmetadata = () => { v.play(); requestAnimationFrame(processVideoFrame); };
                document.getElementById('camera-error').classList.add('hidden');
            } catch(e) { document.getElementById('camera-error').classList.remove('hidden'); }
        }
        function stopCamera() {
            const v=document.getElementById('ar-video');
            if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
            v.pause(); isCameraOn=false;
        }
        function switchVision(m) {
            visionMode=m;
            const ocr = document.getElementById('ocr-controls'); const res = document.getElementById('ocr-result');
            const objBtn = document.getElementById('btn-vis-obj'); const ocrBtn = document.getElementById('btn-vis-ocr');
            const objRes = document.getElementById('obj-result');
            
            if(m==='object') {
                ocr.classList.add('hidden'); res.classList.add('hidden');
                objBtn.classList.replace('bg-white', 'bg-indigo-600'); objBtn.classList.replace('text-black', 'text-white');
                ocrBtn.classList.replace('bg-indigo-600', 'bg-white'); ocrBtn.classList.replace('text-white', 'text-black');
                if(objRes) objRes.classList.remove('hidden');
            } else {
                ocr.classList.remove('hidden'); res.classList.remove('hidden');
                ocrBtn.classList.replace('bg-white', 'bg-indigo-600'); ocrBtn.classList.replace('text-black', 'text-white');
                objBtn.classList.replace('bg-indigo-600', 'bg-white'); objBtn.classList.replace('text-white', 'text-black');
                if(objRes) objRes.classList.add('hidden');
            }
        }
        function triggerUpload() { document.getElementById('img-upload').click(); }
        function handleFileUpload(inp) {
            if(inp.files[0]) {
                const r = new FileReader();
                r.onload = function(e) {
                    const v=document.getElementById('ar-video'); const s=document.getElementById('ar-static-img');
                    isCameraOn=false; v.pause(); v.classList.add('hidden'); 
                    s.src=e.target.result; s.classList.remove('hidden');
                    document.getElementById('camera-error').classList.add('hidden');
                    
                    if(visionMode === 'ocr') setTimeout(()=>runOCR(s), 500);
                    else if(visionMode === 'object') {
                        setTimeout(async () => {
                             if(objectModel) {
                                try {
                                    const predictions = await objectModel.detect(s);
                                    if(predictions.length > 0) {
                                        document.getElementById('obj-name').innerText = `${predictions[0].class} (${Math.round(predictions[0].score*100)}%)`;
                                        document.getElementById('obj-result').classList.remove('hidden');
                                    }
                                } catch(e){}
                             }
                          }, 500);
                    }
                }
                r.readAsDataURL(inp.files[0]);
            }
        }
        async function processVideoFrame() {
            if(!isCameraOn) return;
            const v=document.getElementById('ar-video'); const c=document.getElementById('ar-canvas'); const ctx=c.getContext('2d');
            if(v.readyState>=2) {
                c.width=v.videoWidth; c.height=v.videoHeight; ctx.clearRect(0,0,c.width,c.height);
                if(visionMode==='object' && objectModel) {
                    try {
                        const predictions = await objectModel.detect(v);
                        predictions.forEach(p=>{
                            ctx.strokeStyle='#4f46e5'; ctx.lineWidth=4; ctx.strokeRect(p.bbox[0],p.bbox[1],p.bbox[2],p.bbox[3]);
                            ctx.font='18px Inter'; ctx.fillStyle='#4f46e5'; ctx.fillText(p.class, p.bbox[0], p.bbox[1]>20?p.bbox[1]-10:20);
                        });
                        if(predictions.length > 0) {
                             document.getElementById('obj-name').innerText = predictions[0].class;
                             document.getElementById('obj-result').classList.remove('hidden');
                        }
                    } catch(e){}
                } else if(visionMode==='ocr' && !processingOCR && Date.now()%2000<100) {
                    // Only try auto-ocr every 2 seconds roughly
                    runOCR(v);
                }
            }
            requestAnimationFrame(processVideoFrame);
        }

        // --- OCR & TRANSLATION ---
        async function resetOCR() {
            // Tesseract v5 pattern: Terminate old worker when language changes
            if(ocrWorker) {
                await ocrWorker.terminate();
                ocrWorker = null; 
            }
        }
        async function updateArTranslation() {
            if(!lastOcrText) return;
            const resEl = document.getElementById('ocr-trans-text');
            resEl.innerText = "Translating...";
            const s3 = document.getElementById('ocr-source-lang').value;
            const t = document.getElementById('target-lang').value;
            const map3to2 = {'eng':'en','hin':'hi','kan':'kn','tam':'ta','tel':'te','mal':'ml'};
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(lastOcrText)}&langpair=${map3to2[s3]}|${t}`);
                const data = await res.json();
                resEl.innerText = data.responseData.translatedText || lastOcrText;
            } catch(e) { resEl.innerText = "Translation Error"; }
        }
        async function runOCR(src) {
            if(processingOCR) return; processingOCR=true;
            const txtEl = document.getElementById('ocr-text');
            txtEl.innerText="Scanning...";
            const lang = document.getElementById('ocr-source-lang').value;

            // Prepare Canvas for Tesseract
            const cvs = document.createElement('canvas');
            if(src.tagName==='VIDEO') { cvs.width=src.videoWidth; cvs.height=src.videoHeight; } else { cvs.width=src.naturalWidth; cvs.height=src.naturalHeight; }
            cvs.getContext('2d').drawImage(src,0,0);
            
            try {
                // Initialize worker if needed (V5 Syntax)
                if(!ocrWorker) {
                    ocrWorker = await Tesseract.createWorker(lang);
                }

                const res = await ocrWorker.recognize(cvs);
                const txt = res.data.text.replace(/\n/g,' ').trim();
                
                if(txt.length>2) { 
                    lastOcrText=txt; 
                    txtEl.innerText=txt.substring(0, 50) + "..."; 
                    await updateArTranslation(); 
                } else { 
                    txtEl.innerText="No Text Found"; 
                }
                document.getElementById('ocr-result').classList.remove('hidden');
            } catch(e){ 
                console.error(e);
                txtEl.innerText="Scan Error"; 
            } finally { 
                processingOCR=false; cvs.remove(); 
            }
        }

        // --- TOOLS ---
        const LANG_DATA = { 'en': { code: 'en', speech: 'en-US' }, 'hi': { code: 'hi', speech: 'hi-IN' }, 'kn': { code: 'kn', speech: 'kn-IN' }, 'ta': { code: 'ta', speech: 'ta-IN' }, 'te': { code: 'te', speech: 'te-IN' }, 'ml': { code: 'ml', speech: 'ml-IN' } };
        function swapLanguages() { const s=document.getElementById('trans-source'); const t=document.getElementById('trans-target'); const tmp=s.value; s.value=t.value; t.value=tmp; }
        async function translateTextManual() { 
            const i=document.getElementById('trans-input').value; 
            const s=document.getElementById('trans-source').value; 
            const t=document.getElementById('trans-target').value; 
            const o=document.getElementById('trans-output'); 
            if(!i) return; 
            try { 
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(i)}&langpair=${LANG_DATA[s].code}|${LANG_DATA[t].code}`); 
                const data = await res.json();
                o.innerText = data.responseData.translatedText || i; 
            } catch(e) { o.innerText="Error"; } 
        }
        function speakTranslation() { 
            const t=document.getElementById('trans-output').innerText; 
            if(!t || t === "...") return; 
            const u=new SpeechSynthesisUtterance(t); 
            const tVal = document.getElementById('trans-target').value; 
            u.lang = LANG_DATA[tVal].speech; 
            window.speechSynthesis.speak(u); 
        }
        function initSpeech() { 
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition; 
            if(SR) { 
                recognition = new SR(); 
                recognition.continuous=false; 
                recognition.interimResults=true; 
                recognition.onstart = () => { document.getElementById('mic-pulse').classList.remove('hidden'); document.getElementById('mic-status').innerText="LISTENING..."; }; 
                recognition.onend = () => { isListening=false; document.getElementById('mic-pulse').classList.add('hidden'); document.getElementById('mic-status').innerText=""; if(document.getElementById('trans-input').value) translateTextManual(); }; 
                recognition.onresult = (e) => document.getElementById('trans-input').value = Array.from(e.results).map(r=>r[0].transcript).join(''); 
            } 
        }
        function toggleVoiceInput() { 
            if(!recognition) return alert("Speech Recognition not supported in this browser."); 
            if(isListening) { recognition.stop(); } 
            else { 
                const sVal = document.getElementById('trans-source').value; 
                recognition.lang = LANG_DATA[sVal].speech; 
                recognition.start(); 
                isListening=true;
            } 
        }
        
        // --- AI CHAT & NOTES ---
        function handleChatKey(e) { if(e.key==='Enter') sendChat(); }
        async function sendChat() { 
            const i=document.getElementById('chat-input'); const t=i.value.trim(); 
            if(!t) return; 
            addMsg(t, 'user'); i.value=''; 
            addMsg("Thinking...", 'ai', 'thinking'); 
            try { 
                const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(t)}`); 
                const text = await res.text();
                document.getElementById('thinking').remove(); 
                addMsg(text, 'ai'); 
            } catch(e){ 
                document.getElementById('thinking').remove(); 
                addMsg("System Offline.", 'ai'); 
            } 
        }
        function addMsg(t, s, id) { 
            const h=document.getElementById('chat-history'); 
            const d=document.createElement('div'); 
            if(id) d.id=id; 
            d.className = s==='user' ? "p-4 text-sm font-medium msg-user max-w-[85%] mb-3 ml-auto animate-fade-in" : "flex gap-4 max-w-[90%] msg-ai p-4 mb-3 animate-fade-in"; 
            if(s==='ai') d.innerHTML=`<div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center shrink-0 border border-indigo-100"><i class="ph-fill ph-robot text-indigo-600"></i></div><p class="text-sm font-medium leading-relaxed text-slate-700">${t}</p>`; 
            else d.innerText=t; 
            h.appendChild(d); h.scrollTop=h.scrollHeight; 
        }
        function saveNote() { if(currentUser && currentUser.role !== 'guest') localStorage.setItem(`notes_${currentUser.email}`, document.getElementById('user-notes').value); }
        function downloadNote() { const text = document.getElementById('user-notes').value; if(!text) return; const blob = new Blob([text], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `TravelGuide_Notes_${new Date().toISOString().slice(0,10)}.txt`; a.click(); }
        function loadUserData() { 
            if(currentUser.role === 'guest') return;
            const key = `notes_${currentUser.email}`; 
            document.getElementById('user-notes').value = localStorage.getItem(key) || ""; 
        }
        async function loadModels() { 
            // COCO-SSD
            if (typeof cocoSsd !== 'undefined') { 
                try { objectModel = await cocoSsd.load(); } 
                catch(e) { console.warn("COCO load issue. Object detection disabled."); } 
            }
        }

        window.onload = initAuth;
    </script>
</body>
</html>
